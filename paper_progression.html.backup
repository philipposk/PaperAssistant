<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paper A: Development Progression</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>">
  <!-- Mammoth.js for DOCX preview -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <!-- Fabric.js for figure editing -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <!-- Handsontable for table editing -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.full.min.js"></script>
  <!-- Transformers.js for client-side embeddings (loaded dynamically when needed) -->
  <!-- Note: This library is loaded on-demand to avoid blocking page load -->
  <!-- Shared Features (load early) -->
  <script src="SHARED_FEATURES.js"></script>
  <!-- Unified Navigation -->
  <script src="UNIFIED_NAVIGATION.js"></script>
  <!-- Modal System (replaces alerts) -->
  <script src="MODAL_SYSTEM.js"></script>
  <!-- GitHub Integration -->
  <script src="GITHUB_INTEGRATION.js"></script>
  <!-- Storage Manager -->
  <script src="STORAGE_MANAGER.js"></script>
  <!-- Knowledge Graph -->
  <script src="KNOWLEDGE_GRAPH.js"></script>
  <!-- Timeline System -->
  <script src="TIMELINE_SYSTEM.js"></script>
  <!-- Cloud Storage Integration -->
  <script src="CLOUD_STORAGE_INTEGRATION.js"></script>
  <!-- Breadcrumbs -->
  <script src="BREADCRUMBS_SYSTEM.js"></script>
  <!-- Additional Features -->
  <script src="ADDITIONAL_FEATURES.js"></script>
  <!-- AI Training System -->
  <script src="AI_TRAINING_SYSTEM.js"></script>
  <!-- Multi-Use Case System -->
  <script src="MULTI_USE_CASE_SYSTEM.js"></script>
  <!-- Automatic Logging System -->
  <script src="AUTOMATIC_LOGGING_SYSTEM.js"></script>
  <!-- Project Import & Analysis -->
  <script src="PROJECT_IMPORT_ANALYSIS.js"></script>
  <!-- Project File Loader - Load early -->
  <script src="PROJECT_FILE_LOADER.js"></script>
  <!-- Resizable Figures/Tables -->
  <script src="RESIZABLE_FIGURES_TABLES.js"></script>
  <!-- Quick Fix Debug -->
  <script src="QUICK_FIX_DEBUG.js"></script>
  <!-- Document Editing System -->
  <script src="DOCUMENT_EDITING_SYSTEM.js"></script>
  <!-- Editor Selector -->
    <script src="EDITOR_SELECTOR.js"></script>
    <!-- Modern UI System -->
    <script src="MODERN_UI_SYSTEM.js"></script>
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js" defer></script>
  <!-- Early function definitions to prevent "not defined" errors -->
  <script>
    // Define functions early so they're available when HTML calls them
    // These will be replaced by actual implementations later
    
    // Define scrollCarousel immediately to prevent errors
    window.scrollCarousel = function(carouselId, direction) {
      const track = document.getElementById(carouselId + 'Track');
      if (track) {
        const scrollAmount = 220; // width of item + gap
        track.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
      } else {
        console.warn('Carousel track not found:', carouselId + 'Track');
      }
    };
    
    // Define placeholder carousel loaders
    window.loadFiguresCarousel = window.loadFiguresCarousel || function() {
      console.log('loadFiguresCarousel will be initialized...');
    };
    window.loadTablesCarousel = window.loadTablesCarousel || function() {
      console.log('loadTablesCarousel will be initialized...');
    };
    
    // File opening functions (early definitions)
    window.openFile = window.openFile || function(path, event) {
      if (!path) return;
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      // Will be replaced by actual implementation
      console.log('openFile will be initialized, path:', path);
    };
    
    window.openFileFromDrive = window.openFileFromDrive || function(fileName, event) {
      if (event) {
        event.preventDefault();
      }
      // Will be replaced by actual implementation
      console.log('openFileFromDrive will be initialized, file:', fileName);
    };
    
    // Settings function (early definition)
    window.openSettings = window.openSettings || function() {
      console.log('Settings will be initialized...');
      if(typeof window.ModalSystem !== 'undefined') {
        window.ModalSystem.info('Settings', 'Settings panel is loading...');
      }
    };
    
    // Search functions (early definitions)
    window.toggleSearch = window.toggleSearch || function() {
      console.log('Search toggled...');
      const searchContainer = document.getElementById('universalSearch');
      if (searchContainer) {
        const isExpanded = searchContainer.classList.contains('expanded');
        if (isExpanded) {
          searchContainer.classList.remove('expanded');
          const input = searchContainer.querySelector('input');
          if (input) input.blur();
        } else {
          searchContainer.classList.add('expanded');
          const input = searchContainer.querySelector('input');
          if (input) {
            input.focus();
          }
        }
      }
    };
    window.expandSearch = window.expandSearch || function() {
      console.log('Expand search...');
      const searchContainer = document.getElementById('universalSearch');
      if (searchContainer) {
        searchContainer.classList.add('expanded');
        const input = searchContainer.querySelector('input');
        if (input) input.focus();
      }
    };
    window.collapseSearch = window.collapseSearch || function() {
      console.log('Collapse search...');
      const searchContainer = document.getElementById('universalSearch');
      if (searchContainer) {
        searchContainer.classList.remove('expanded');
        const input = searchContainer.querySelector('input');
        if (input) input.blur();
      }
    };
    
    // AI Assistant functions (early definitions)
    window.handleAIAssistantClick = window.handleAIAssistantClick || function() {
      console.log('AI Assistant clicked, opening...');
      // Try to open chatbot modal directly
      const modal = document.getElementById('chatbotModal');
      if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        const input = document.getElementById('chatbotInput');
        if (input) {
          setTimeout(() => input.focus(), 100);
        }
      } else if(typeof window.openChatbot === 'function') {
        window.openChatbot();
      } else {
        console.log('openChatbot not yet available, will retry...');
        setTimeout(() => {
          const modal = document.getElementById('chatbotModal');
          if (modal) {
            modal.style.display = 'block';
            modal.classList.add('show');
            const input = document.getElementById('chatbotInput');
            if (input) {
              setTimeout(() => input.focus(), 100);
            }
          } else if(typeof window.openChatbot === 'function') {
            window.openChatbot();
          } else if(typeof window.ModalSystem !== 'undefined') {
            window.ModalSystem.info('AI Assistant', 'AI Assistant is loading, please wait...');
          }
        }, 500);
      }
    };
    window.openChatbot = window.openChatbot || function() {
      console.log('openChatbot called, opening modal...');
      const modal = document.getElementById('chatbotModal');
      if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        const input = document.getElementById('chatbotInput');
        if (input) {
          setTimeout(() => input.focus(), 100);
        }
      }
    };
    
    // More menu functions (early definitions)
    window.toggleToolsDropdown = window.toggleToolsDropdown || function() {
      console.log('Tools dropdown will be initialized...');
    };
    window.togglePapersDropdown = window.togglePapersDropdown || function() {
      console.log('Papers dropdown will be initialized...');
    };
    
    // More menu item functions (early definitions)
    window.openAboutModal = window.openAboutModal || function() {
      console.log('About modal will be initialized...');
    };
    window.showFileUploadModal = window.showFileUploadModal || function() {
      console.log('File upload modal will be initialized...');
    };
    window.showUseCaseSelector = window.showUseCaseSelector || function() {
      console.log('Use case selector will be initialized...');
    };
    window.showUICustomizationModal = window.showUICustomizationModal || function() {
      console.log('UI customization modal will be initialized...');
    };
    window.showVoiceFaceCloningModal = window.showVoiceFaceCloningModal || function() {
      console.log('Voice/Face cloning modal will be initialized...');
    };
    window.toggleTimerWidget = window.toggleTimerWidget || function() {
      console.log('Timer widget will be initialized...');
    };
    window.showProjectImportModal = window.showProjectImportModal || function() {
      console.log('Project import modal will be initialized...');
    };
    window.showEditorSelector = window.showEditorSelector || function() {
      console.log('Editor selector will be initialized...');
    };
    window.showMessagingPanel = window.showMessagingPanel || function() {
      console.log('Messaging panel will be initialized...');
    };
    
    // File Explorer
    window.toggleFileExplorer = window.toggleFileExplorer || function() {
      console.warn('File explorer loading...');
    };
    window.openFileFromExplorer = window.openFileFromExplorer || function() {
      console.warn('File explorer functions loading...');
    };
    window.filterFileTree = window.filterFileTree || function() {};
    window.navigateFile = window.navigateFile || function() {};
    window.toggleFolder = window.toggleFolder || function() {};
    
    // Tab and UI functions
    window.showTab = window.showTab || function(tabName, eventElement) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
      });
      
      // Remove active class from all tabs
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab content
      const selectedTab = document.getElementById(tabName);
      if (selectedTab) {
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
      }
      
      // Add active class to clicked tab
      if (eventElement) {
        eventElement.classList.add('active');
      }
      
      // Initialize special tabs
      if (tabName === 'knowledge-graph') {
        setTimeout(() => {
          if (typeof window.KnowledgeGraph !== 'undefined' && !window.knowledgeGraphInstance) {
            window.knowledgeGraphInstance = new window.KnowledgeGraph('knowledgeGraphContainer');
            if (window.projectFileLoader && window.projectFileLoader.manifest) {
              window.knowledgeGraphInstance.init(window.projectFileLoader.manifest);
            } else {
              window.knowledgeGraphInstance.init();
            }
          }
        }, 100);
      } else if (tabName === 'timeline') {
        setTimeout(() => {
          if (typeof window.TimelineSystem !== 'undefined' && !window.timelineSystemInstance) {
            window.timelineSystemInstance = new window.TimelineSystem('timelineContainer');
            window.timelineSystemInstance.init();
          }
        }, 100);
      }
    };
    window.toggleSortOrder = window.toggleSortOrder || function() {
      console.warn('toggleSortOrder loading...');
    };
    window.toggleDocxDropdown = window.toggleDocxDropdown || function() {
      console.warn('toggleDocxDropdown loading...');
    };
    
    // Search functions
    window.toggleSearch = window.toggleSearch || function() {
      console.warn('Search functions loading...');
    };
    window.expandSearch = window.expandSearch || function() {};
    window.collapseSearch = window.collapseSearch || function() {};
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --accent-dark: #2563eb;
      --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-hover: 0 12px 20px -4px rgba(0, 0, 0, 0.15), 0 6px 8px -3px rgba(0, 0, 0, 0.1);
      --error: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --border-color: #e2e8f0;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --border-radius-lg: 16px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --accent: #60a5fa;
      --accent-light: #93c5fd;
      --accent-dark: #3b82f6;
      --accent-gradient: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
      --shadow-hover: 0 12px 20px -4px rgba(0, 0, 0, 0.6), 0 6px 8px -3px rgba(0, 0, 0, 0.4);
      --error: #f87171;
      --success: #34d399;
      --warning: #fbbf24;
      --info: #60a5fa;
      --border-color: #334155;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
      background: var(--bg-primary); 
      color: var(--text-primary); 
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }
    
    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      background: var(--bg-secondary);
      border: 1.5px solid var(--border-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      color: var(--text-primary);
    }
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
      background: var(--accent-gradient);
      color: white;
    }
    
    .home-button {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1000;
      background: var(--bg-secondary);
      border: 1.5px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      padding: 0.5rem;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .home-button:hover {
      background: var(--accent-gradient);
      color: white;
      border-color: transparent;
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-md);
      text-decoration: none;
    }
    
    /* Top Button Banner - Deprecated, replaced by unified navigation */
    .top-button-banner {
      display: none;
    }
    
    .about-button {
      background: var(--bg-secondary);
      border: 1.5px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      padding: 0.625rem 1.125rem;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }
    .about-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-gradient);
      transition: left 0.3s ease;
      z-index: 0;
    }
    .about-button > * {
      position: relative;
      z-index: 1;
    }
    .about-button:hover {
      border-color: var(--accent);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .about-button:hover::before {
      left: 0;
    }
    .about-button:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    /* Footer */
    footer {
      margin-top: 4rem;
      padding: 2.5rem 2rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }
    footer a:hover {
      color: var(--accent-dark);
      text-decoration: underline;
    }
    
    /* About Modal */
    .about-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      animation: fadeIn 0.2s ease-out;
    }
    .about-modal-content {
      background: var(--bg-secondary);
      margin: 5% auto;
      padding: 0;
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    .about-modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent-gradient);
      color: white;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }
    .about-modal-header h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    .about-modal-close {
      color: white;
      font-size: 1.75rem;
      font-weight: 300;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.1);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    .about-modal-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .about-modal-body {
      padding: 2rem;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    .about-modal-body p {
      margin-bottom: 1rem;
      line-height: 1.8;
      color: var(--text-primary);
    }
    .about-modal-body strong {
      color: var(--accent);
    }
    
    header { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); 
      color: #fff; 
      padding: 0.75rem 2rem; 
      box-shadow: 0 4px 20px var(--shadow);
      border-radius: 12px;
      margin: 1rem auto;
      margin-top: 4.5rem;
      max-width: 1400px;
      transform: perspective(1000px) rotateX(2deg);
      transition: transform 0.3s;
      position: relative;
      z-index: 100;
    }
    header:hover {
      transform: perspective(1000px) rotateX(0deg);
    }
    header h1 { 
      font-size: 2rem; 
      margin-bottom: 0.25rem; 
      line-height: 1.2; 
      color: #fff !important;
    }
    header p { 
      opacity: 0.9; 
      font-size: 1.1rem; 
      line-height: 1.3; 
      color: rgba(255, 255, 255, 0.95) !important;
    }
    
    /* Ensure header text is visible in all themes */
    [data-theme="light"] header h1,
    [data-theme="light"] header p,
    body:not([data-theme="dark"]) header h1,
    body:not([data-theme="dark"]) header p {
      color: #fff !important;
    }
    
    /* Ensure header doesn't get covered */
    body {
      padding-top: 0;
    }
    
    /* Main content spacing */
    .container {
      margin-top: 2rem;
      position: relative;
      z-index: 1;
    }
    /* File Explorer Sidebar */
    .file-explorer-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 2px solid var(--bg-primary);
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 900;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 2px 0 10px var(--shadow);
    }
    .file-explorer-sidebar.open {
      transform: translateX(0);
    }
    .file-explorer-toggle {
      position: fixed;
      left: 1rem;
      bottom: 1rem;
      z-index: 1000;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s;
    }
    .file-explorer-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .file-explorer-header {
      padding: 1rem;
      background: var(--accent);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .file-explorer-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    .file-explorer-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-tree {
      list-style: none;
      padding: 0.5rem;
      margin: 0;
    }
    .file-tree-item {
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .file-tree-item:hover {
      background: var(--bg-primary);
    }
    .file-tree-item.selected {
      background: var(--accent-light);
      color: white;
    }
    .file-tree-folder {
      font-weight: 600;
    }
    .file-tree-file {
      padding-left: 1.5rem;
    }
    .file-tree-caret {
      width: 16px;
      text-align: center;
      transition: transform 0.2s;
    }
    .file-tree-caret.open {
      transform: rotate(90deg);
    }
    .file-tree-icon {
      font-size: 1rem;
    }
    .file-tree-children {
      margin-left: 1rem;
      display: none;
    }
    .file-tree-children.open {
      display: block;
    }
    .file-explorer-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent-gradient);
      color: white;
    }
    .file-explorer-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .file-explorer-close {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 1.5rem;
      transition: var(--transition);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-explorer-close:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }
    
    /* Adjust container when sidebar is open */
    body.sidebar-open .container {
      margin-left: 280px;
      transition: margin-left 0.3s ease;
    }
    body.sidebar-open .home-button {
      left: 300px;
    }
    body.sidebar-open .quick-access-toolbar {
      /* Keep toolbar accessible even when sidebar is open */
      right: calc(1rem + 280px);
    }
    
    /* Adjust toolbar position when timer is open */
    #timerWidget[style*="display: block"] ~ .quick-access-toolbar,
    #timerWidget[style*="display: flex"] ~ .quick-access-toolbar {
      bottom: calc(2rem + 400px);
    }
    body.sidebar-open .theme-toggle {
      right: calc(1rem + 280px);
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 2rem; 
      transition: margin-left 0.3s ease;
      padding-top: calc(2rem + 60px); /* Account for top banner */
    }
    .tabs { 
      display: flex; 
      gap: 1rem; 
      margin-bottom: 2rem; 
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    .tab { 
      padding: 1rem 1.5rem; 
      cursor: pointer; 
      border: none; 
      background: none; 
      font-size: 0.9375rem; 
      color: var(--text-secondary); 
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      font-weight: 500;
      position: relative;
    }
    .tab::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 0;
      height: 3px;
      background: var(--accent-gradient);
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tab:hover { 
      color: var(--text-primary); 
      background: var(--bg-tertiary); 
    }
    .tab.active { 
      color: var(--accent); 
      font-weight: 600; 
    }
    .tab.active::after {
      width: 100%;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes slideOutDown {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    
    /* Timeline Styles */
    .timeline-container { position: relative; padding: 2rem 0; }
    .timeline-controls { 
      margin-bottom: 2rem; 
      display: flex; 
      gap: 1rem; 
      flex-wrap: wrap;
      align-items: center;
    }
    .timeline-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .timeline-controls-row1 {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .timeline-controls-row2 {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .timeline-controls button, .timeline-controls select {
      padding: 0.5rem 1rem;
      border: 2px solid var(--accent);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      box-shadow: 0 2px 8px var(--shadow);
      transform: perspective(1000px) translateZ(0);
    }
    .timeline-controls button:hover, .timeline-controls select:hover {
      background: var(--accent);
      color: white;
      transform: perspective(1000px) translateZ(5px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }
    .timeline-controls button.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: perspective(1000px) translateZ(10px);
      box-shadow: 0 6px 20px var(--shadow-hover);
      font-weight: 600;
    }
    .round-button {
      border-radius: 50% !important;
      width: 50px;
      height: 50px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .timeline { 
      position: relative; 
      padding-left: 3rem; 
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 1.5rem;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #e0e0e0;
    }
    .timeline-item { 
      position: relative; 
      margin-bottom: 2.5rem; 
      padding-left: 2rem;
      opacity: 1;
      transition: var(--transition);
    }
    .timeline-item.filtered { display: none !important; }
    .timeline-item.hidden { display: none !important; }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -2.5rem;
      top: 0.5rem;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 3px solid var(--bg-secondary);
      box-shadow: 0 0 0 3px var(--border-color);
      transition: var(--transition);
    }
    .timeline-item.milestone::before {
      background: var(--warning);
      width: 20px;
      height: 20px;
      left: -2.7rem;
      top: 0.3rem;
      box-shadow: 0 0 0 3px var(--border-color), 0 0 0 6px var(--bg-secondary);
    }
    .timeline-date { 
      font-weight: 600; 
      color: var(--accent); 
      font-size: 1.125rem; 
      margin-bottom: 0.75rem;
      letter-spacing: 0.5px;
    }
    .timeline-title { 
      font-size: 1.375rem; 
      font-weight: 700; 
      margin-bottom: 0.75rem; 
      color: var(--text-primary);
      line-height: 1.3;
    }
    .timeline-content { 
      background: var(--bg-secondary); 
      padding: 1.75rem; 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow);
      margin-left: 1rem;
      transition: var(--transition);
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--accent);
    }
    .timeline-content:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }
    .timeline-content p { margin-bottom: 0.5rem; }
    .timeline-tags { 
      display: flex; 
      gap: 0.5rem; 
      flex-wrap: wrap; 
      margin-top: 1rem;
    }
    .tag { 
      padding: 0.375rem 0.875rem; 
      border-radius: 9999px; 
      font-size: 0.8125rem; 
      font-weight: 500;
      background: var(--bg-tertiary); 
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }
    .tag:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .tag.milestone { 
      background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%); 
      color: white;
      border-color: transparent;
    }
    
    /* Dashboard Styles */
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .dashboard-card { 
      background: var(--bg-secondary); 
      padding: 1.5rem; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s;
      transform: perspective(1000px) translateZ(0);
    }
    .dashboard-card:hover {
      transform: perspective(1000px) translateZ(5px);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .dashboard-card h3 { 
      color: var(--accent); 
      margin-bottom: 1rem; 
      font-size: 1.2rem;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.5rem;
    }
    .file-list { list-style: none; }
    .file-list li { 
      padding: 0.75rem; 
      margin-bottom: 0.5rem; 
      background: var(--bg-primary); 
      border-radius: 8px;
      border-left: 4px solid var(--accent);
      transition: all 0.3s;
      box-shadow: 0 2px 8px var(--shadow);
      transform: perspective(1000px) translateZ(0);
    }
    .file-list li:hover { 
      background: var(--accent); 
      transform: perspective(1000px) translateZ(5px) translateX(4px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }
    .file-list li:hover a {
      color: white;
    }
    .file-list a { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      display: block;
      transition: color 0.3s;
    }
    .file-list a:hover { text-decoration: underline; }
    .file-meta {
      font-size: 0.8125rem;
      color: var(--text-tertiary);
      margin-top: 0.375rem;
      line-height: 1.5;
    }
    .file-type { 
      display: inline-block; 
      padding: 0.2rem 0.5rem; 
      border-radius: 6px; 
      font-size: 0.75rem; 
      background: var(--accent); 
      color: white;
      margin-left: 0.5rem;
    }
    
    /* DOCX Dropdown */
    .docx-dropdown {
      position: relative;
      display: inline-block;
      margin: 2rem 0;
    }
    .docx-main-button {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color: white;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s;
      transform: perspective(1000px) translateZ(0);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .docx-main-button:hover {
      transform: perspective(1000px) translateZ(10px);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .docx-arrow-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 1rem 0.75rem;
      border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: var(--transition);
      box-shadow: 0 4px 15px var(--shadow);
    }
    .docx-arrow-button:hover {
      background: var(--accent-dark);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .docx-dropdown-content {
      display: none;
      position: absolute;
      background: var(--bg-secondary);
      min-width: 350px;
      box-shadow: var(--shadow-lg);
      border-radius: var(--border-radius);
      z-index: 1000;
      margin-top: 0.5rem;
      max-height: 450px;
      overflow-y: auto;
      border: 2px solid var(--border-color);
      transition: var(--transition);
      animation: fadeIn 0.2s ease-out;
      top: 100%;
      left: 0;
    }
    .docx-dropdown-content.show {
      display: block;
    }
    .docx-dropdown-content a {
      color: var(--text-primary) !important;
      padding: 1rem 1.5rem;
      text-decoration: none;
      display: block;
      border-bottom: 1px solid var(--border-color);
      transition: var(--transition);
      background: var(--bg-secondary);
    }
    .docx-dropdown-content a:hover {
      background: var(--bg-tertiary);
      border-left: 4px solid var(--accent);
      transform: translateX(4px);
      color: var(--text-primary) !important;
    }
    .docx-dropdown-content a strong {
      color: var(--text-primary) !important;
      display: block;
      margin-bottom: 0.25rem;
    }
    .docx-dropdown-content a small {
      color: var(--text-secondary) !important;
    }
    .docx-dropdown-content a:last-child {
      border-bottom: none;
    }
    
    /* Settings Modal */
    .settings-modal {
      display: none;
      position: fixed;
      z-index: 10003;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
    }
    .settings-modal.show {
      display: flex;
    }
    .settings-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      box-shadow: 0 10px 40px var(--shadow-hover);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: fadeIn 0.3s;
    }
    .settings-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--bg-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color: white;
      flex-shrink: 0;
    }
    .settings-header h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    .settings-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    .settings-close:hover {
      background: rgba(255,255,255,0.3);
    }
    .settings-tabs {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-bottom: 2px solid var(--bg-primary);
      background: var(--bg-primary);
      overflow-x: auto;
      flex-shrink: 0;
    }
    .settings-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .settings-tab:hover {
      color: var(--accent);
    }
    .settings-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }
    .settings-tab-content {
      display: none;
      padding: 2rem;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    .settings-tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    .settings-section {
      margin-bottom: 2rem;
    }
    .settings-section h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
      font-size: 1.1rem;
    }
    .settings-field {
      margin-bottom: 1.5rem;
    }
    .settings-field label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 500;
    }
    .settings-field input,
    .settings-field select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--bg-primary);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
    }
    .settings-field input:focus,
    .settings-field select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .settings-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .settings-toggle label {
      color: var(--text-primary);
      font-weight: 500;
    }
    .toggle-switch {
      width: 50px;
      height: 26px;
      background: var(--bg-primary);
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-switch.active {
      background: var(--accent);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.3s;
    }
    .toggle-switch.active::after {
      transform: translateX(24px);
    }
    
    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { 
      background: var(--bg-secondary); 
      padding: 1.5rem; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px var(--shadow);
      text-align: center;
      transition: all 0.3s;
      transform: perspective(1000px) translateZ(0);
    }
    .stat-card:hover {
      transform: perspective(1000px) translateZ(10px);
      box-shadow: 0 8px 25px var(--shadow-hover);
    }
    .stat-card.clickable {
      cursor: pointer;
    }
    .stat-card.clickable:hover {
      transform: perspective(1000px) translateZ(15px) scale(1.02);
    }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--accent); }
    .stat-label { color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem; }
    
    /* Carousel Styles */
    .carousel-container {
      margin-bottom: 2rem;
    }
    .carousel {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 15px var(--shadow);
    }
    .carousel-track {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      scrollbar-width: thin;
      flex: 1;
      padding: 0.5rem 0;
    }
    .carousel-track::-webkit-scrollbar {
      height: 6px;
    }
    .carousel-track::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 3px;
    }
    .carousel-track::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    .carousel-item {
      min-width: 200px;
      max-width: 200px;
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .carousel-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--shadow-hover);
      background: var(--accent);
      color: white;
    }
    .carousel-item img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      background: var(--bg-secondary);
    }
    .carousel-item .carousel-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      font-weight: 500;
    }
    .carousel-item:hover .carousel-label {
      color: white;
    }
    .carousel-nav {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
      z-index: 10;
    }
    .carousel-nav:hover {
      background: var(--accent-light);
      transform: scale(1.1);
    }
    .carousel-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .view-all-btn {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .view-all-btn:hover {
      background: var(--accent-light);
      transform: translateX(4px);
    }
    
    /* Google Drive Button */
    .drive-button { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 12px 24px; 
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); 
      color: white; 
      border-radius: 8px; 
      text-decoration: none; 
      font-weight: 600; 
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
      transition: all 0.3s;
      margin: 1rem 0;
    }
    .drive-button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4);
      text-decoration: none;
      color: white;
    }
    .drive-section {
      background: var(--bg-secondary);
      border-left: 4px solid #4285f4;
      margin-top: 2rem;
    }
    
    /* File Preview Modal */
    .file-preview-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    .file-preview-modal.fullscreen {
      background-color: rgba(0,0,0,0.95);
    }
    .file-preview-content {
      background: var(--bg-secondary);
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    .file-preview-content.fullscreen {
      margin: 0;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      border-radius: 0;
    }
    .file-preview-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--bg-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color: white;
      border-radius: 12px 12px 0 0;
    }
    .file-preview-content.fullscreen .file-preview-header {
      border-radius: 0;
    }
    .file-preview-header-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .file-preview-resize {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .file-preview-resize:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    .file-preview-header h3 {
      margin: 0;
      font-size: 1.2rem;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-preview-close {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    .file-preview-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .file-preview-body.fullscreen {
      max-height: calc(100vh - 100px);
    }
    .file-preview-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    .file-preview-body img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1rem auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .file-preview-body figure {
      max-width: 100%;
      margin: 1rem auto;
      text-align: center;
    }
    .file-preview-body figure img {
      max-width: 90%;
      max-height: 60vh;
      object-fit: contain;
    }
    .file-preview-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid var(--bg-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      background: var(--bg-primary);
      border-radius: 0 0 12px 12px;
    }
    .file-preview-footer .file-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
      flex: 1;
    }
    .file-preview-footer .file-name strong {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* AI Chatbot Modal */
    .chatbot-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }
    .chatbot-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chatbot-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      height: 80vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px var(--shadow-hover);
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .chatbot-modal.show .chatbot-content {
      transform: scale(1);
    }
    .chatbot-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 2px solid var(--bg-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent);
      color: white;
      border-radius: 16px 16px 0 0;
    }
    .chatbot-header h3 {
      margin: 0;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chatbot-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .chatbot-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .chatbot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .chatbot-message {
      display: flex;
      gap: 0.75rem;
      animation: fadeIn 0.3s;
    }
    .chatbot-message.user {
      flex-direction: row-reverse;
    }
    .chatbot-message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    .chatbot-message.user .chatbot-message-avatar {
      background: var(--accent);
      color: white;
    }
    .chatbot-message.assistant .chatbot-message-avatar {
      background: var(--bg-primary);
      color: var(--accent);
    }
    .chatbot-message-content {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      line-height: 1.5;
    }
    .chatbot-message.user .chatbot-message-content {
      background: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chatbot-message.assistant .chatbot-message-content {
      background: var(--bg-primary);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }
    .chatbot-message-content pre {
      background: rgba(0,0,0,0.1);
      padding: 0.5rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }
    .chatbot-message-content code {
      background: rgba(0,0,0,0.1);
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.9em;
    }
    .chatbot-input-area {
      border-top: 2px solid var(--bg-primary);
    }
    .chatbot-file-upload-area {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }
    .chatbot-input-wrapper {
      padding: 1rem 1.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }
    .chatbot-attach-btn {
      padding: 0.5rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 1.2rem;
      flex-shrink: 0;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }
    .chatbot-attach-btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
      transform: scale(1.05);
    }
    .chatbot-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--bg-primary);
      border-radius: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
      resize: none;
      min-height: 50px;
      max-height: 150px;
      font-family: inherit;
    }
    .chatbot-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .chatbot-send {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .chatbot-send:hover:not(:disabled) {
      background: var(--accent-light);
      transform: translateY(-2px);
    }
    .chatbot-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .chatbot-loading {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
    }
    .chatbot-loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: bounce 1.4s infinite;
    }
    .chatbot-loading-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .chatbot-loading-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
      40% { transform: translateY(-10px); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(100%);
        opacity: 0;
      }
    }
    .chatbot-settings-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .chatbot-settings-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .file-preview-download {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .file-preview-download:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Universal Search - Collapsible */
    .universal-search {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10001;
    }
    .universal-search-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    .universal-search-input {
      width: 0;
      padding: 0.75rem 0;
      border: 2px solid transparent;
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s;
      opacity: 0;
      pointer-events: none;
    }
    .universal-search.expanded .universal-search-input {
      width: 600px;
      max-width: 90vw;
      padding: 0.75rem 3rem 0.75rem 1rem;
      border-color: var(--accent);
      opacity: 1;
      pointer-events: auto;
    }
    .universal-search-input:focus {
      outline: none;
      border-color: var(--accent-light);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .universal-search-icon {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      background: var(--bg-secondary);
      border: 2px solid var(--accent);
      border-radius: 8px;
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 45px;
      min-height: 45px;
    }
    .universal-search-icon:hover {
      background: var(--accent);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px var(--shadow-hover);
    }
    .universal-search.expanded .universal-search-icon {
      right: 1rem;
      background: transparent;
      border: none;
      box-shadow: none;
      pointer-events: none;
      min-width: auto;
      min-height: auto;
      padding: 0;
    }
    .search-shortcut-hint {
      display: none;
    }
    .universal-search.expanded .search-shortcut-hint {
      display: inline-block;
      position: absolute;
      right: 3.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--text-secondary);
      pointer-events: none;
    }
    .search-results {
      position: absolute;
      top: calc(100% + 0.5rem);
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 2px solid var(--accent);
      border-radius: 12px;
      box-shadow: 0 8px 30px var(--shadow-hover);
      max-height: 500px;
      overflow-y: auto;
      display: none;
      z-index: 1001;
    }
    .search-results.show {
      display: block;
    }
    .search-result-item {
      padding: 1rem;
      border-bottom: 1px solid var(--bg-primary);
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-result-item:hover {
      background: var(--bg-primary);
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .search-result-path {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .search-result-snippet {
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.4;
    }
    .search-result-highlight {
      background: yellow;
      color: var(--text-primary);
      padding: 0.1rem 0.2rem;
      border-radius: 3px;
    }
    .search-result-score {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    .search-no-results {
      padding: 2rem;
      text-align: center;
      color: var(--text-secondary);
    }
    .search-shortcut-hint {
      position: absolute;
      right: 3rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: var(--text-secondary);
      pointer-events: none;
    }
    
    /* Search (legacy - for timeline search) */
    .search-box { 
      width: 100%; 
      padding: 0.75rem; 
      border: 2px solid #e0e0e0; 
      border-radius: 6px; 
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .search-box:focus { outline: none; border-color: #0f4c81; }
    
    @media (max-width: 768px) {
      .timeline { padding-left: 2rem; }
      .timeline-item::before { left: -1.5rem; }
      .timeline-content { margin-left: 0.5rem; }
      .about-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .quick-access-toolbar {
        padding: 0.5rem;
        gap: 0.25rem;
      }
      .about-button {
        font-size: 0.75rem;
        padding: 0.4rem 0.7rem;
      }
      .universal-search {
        left: auto;
        right: 1rem;
        transform: none;
      }
      .universal-search.expanded .universal-search-input {
        width: calc(100vw - 2rem);
        max-width: 500px;
      }
      .theme-toggle {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <!-- Top Button Banner -->
  <!-- Quick Access Toolbar - Hidden by default, shown via More menu or toggle -->
  <!-- All tools also available in unified navigation "More" dropdown -->
  <div class="quick-access-toolbar" id="quickAccessToolbar" style="position: fixed; bottom: 1rem; right: 1rem; z-index: 10000; display: none !important; gap: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); backdrop-filter: blur(10px); flex-wrap: wrap; max-width: calc(100vw - 2rem);">
    <button class="quick-tool-btn" onclick="openAboutModal()" title="About this website">
      <span style="font-size: 1.25rem;">â„¹ï¸</span>
    </button>
    <button class="quick-tool-btn" onclick="showFileUploadModal()" title="Upload Files for AI Training">
      <span style="font-size: 1.25rem;">ðŸ“š</span>
    </button>
    <button class="quick-tool-btn" onclick="showUseCaseSelector()" title="Change Use Case">
      <span style="font-size: 1.25rem;">ðŸŽ¯</span>
    </button>
    <button class="quick-tool-btn" onclick="showUICustomizationModal()" title="Customize Interface">
      <span style="font-size: 1.25rem;">ðŸŽ¨</span>
    </button>
    <button class="quick-tool-btn" onclick="showVoiceFaceCloningModal()" title="Voice & Face Cloning">
      <span style="font-size: 1.25rem;">ðŸŽ­</span>
    </button>
    <button class="quick-tool-btn" onclick="toggleTimerWidget()" title="Work Timer">
      <span style="font-size: 1.25rem;">â±ï¸</span>
    </button>
    <button class="quick-tool-btn" onclick="showProjectImportModal()" title="Import Project">
      <span style="font-size: 1.25rem;">ðŸ“¥</span>
    </button>
    <button class="quick-tool-btn" onclick="showEditorSelector()" title="Open Editor">
      <span style="font-size: 1.25rem;">âœï¸</span>
    </button>
    <button class="quick-tool-btn" onclick="showMessagingPanel()" title="Messages">
      <span style="font-size: 1.25rem;">ðŸ’¬</span>
    </button>
    <button class="quick-tool-btn commit-btn" onclick="if(typeof window.showCommitModal === 'function') window.showCommitModal(); else if(typeof showCommitModal === 'function') showCommitModal(); else if(typeof window.ModalSystem !== 'undefined') { window.ModalSystem.warning('Authentication Required', 'Please log in with editor or administrator privileges to commit changes.'); } else { alert('Commit feature - ensure you are logged in as editor/admin'); }" title="Commit Changes" style="background: var(--accent); color: white; padding: 0 0.75rem; min-width: auto;">
      <span style="font-size: 1rem;">ðŸ“</span>
      <span style="font-size: 0.75rem; margin-left: 0.25rem; font-weight: 600;">Commit</span>
    </button>
  </div>
  
  <style>
    .quick-access-toolbar {
      animation: slideInUp 0.3s ease;
      flex-direction: row;
    }
    
    .quick-access-toolbar.show {
      display: flex !important;
    }
    
    /* Ensure toolbar is visible when shown */
    #quickAccessToolbar.show {
      display: flex !important;
    }
    
    /* Force hide by default */
    #quickAccessToolbar:not(.show) {
      display: none !important;
    }
    
    .quick-tool-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      padding: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }
    
    .quick-tool-btn.commit-btn {
      width: auto;
      padding: 0 0.75rem;
    }
    
    .quick-tool-btn:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }
    
    .quick-tool-btn:active {
      transform: translateY(0);
    }
    
    @media (max-width: 768px) {
      .quick-access-toolbar {
        bottom: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        max-width: calc(100vw - 1rem);
        justify-content: center;
      }
      
      .quick-tool-btn {
        width: 40px;
        height: 40px;
      }
      
      .quick-tool-btn.commit-btn {
        width: auto;
      }
    }
    
  </style>
  
  <!-- Toolbar position adjustment is handled in toggleTimerWidget() and closeTimerWidget() functions -->
  
  <!-- Work Timer Widget (Floating) -->
  <div id="timerWidget" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 10002; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 2rem; box-shadow: var(--shadow-lg); min-width: 300px; max-width: 360px; display: none; border-top: 4px solid var(--accent);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
      <h4 style="margin: 0; color: var(--accent); font-size: 1.25rem; font-weight: 600;">â±ï¸ Work Timer</h4>
      <button onclick="closeTimerWidget()" class="btn-modern btn-modern-ghost" style="padding: 0.25rem 0.5rem; font-size: 1.5rem; min-width: auto; width: auto;">Ã—</button>
    </div>
    
    <div style="margin-bottom: 1rem;">
      <select id="timerMethodSelect" onchange="initTimer(this.value)" class="input-modern" style="width: 100%; font-size: 0.875rem; padding: 0.75rem 1rem;">
        <option value="pomodoro">Pomodoro (25/5)</option>
        <option value="flowtime">Flow Time</option>
        <option value="timeblocking">Time Blocking (60/10)</option>
        <option value="ultradian">Ultradian (90/20)</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    
    <div id="timerDisplay" class="timer-display" style="text-align: center; font-size: 3.5rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 2rem 0; font-family: 'Courier New', monospace; letter-spacing: 0.1em;">
      25:00
    </div>
    
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
      <button id="timerStartBtn" onclick="startTimer()" class="btn-modern btn-modern-primary" style="flex: 1; font-weight: 600;">
        <span>â–¶ï¸</span>
        <span>Start</span>
      </button>
      <button id="timerPauseBtn" onclick="pauseTimer()" class="btn-modern btn-modern-secondary" style="flex: 1; font-weight: 600; display: none;">
        <span>â¸ï¸</span>
        <span>Pause</span>
      </button>
      <button onclick="stopTimer()" class="btn-modern" style="flex: 1; background: var(--error); color: white; font-weight: 600;">
        <span>â¹ï¸</span>
        <span>Stop</span>
      </button>
    </div>
    
    <div style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
      <div id="timerState" style="margin-bottom: 0.5rem; font-weight: 500;">Ready</div>
      <div id="timerSessions" style="color: var(--text-tertiary);">Sessions: 0</div>
    </div>
    
    <div style="margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid var(--border-color);">
      <button onclick="openTimerStats()" class="btn-modern btn-modern-secondary" style="width: 100%; font-size: 0.875rem; padding: 0.75rem 1rem;">
        <span>ðŸ“Š</span>
        <span>View Statistics</span>
      </button>
    </div>
  </div>
  
  
  <a href="index.html" class="home-button" title="Go to Home Page">ðŸ </a>
  
  <!-- Universal Search -->
  <div class="universal-search" id="universalSearch">
    <div class="universal-search-container">
      <input 
        type="text" 
        id="universalSearchInput" 
        class="universal-search-input" 
        placeholder="Search all files... (Ctrl+K or Cmd+K)"
        autocomplete="off"
        oninput="if(typeof window.performSearch === 'function') window.performSearch(this.value); else performSearch(this.value);"
        onfocus="if(typeof window.showSearchResults === 'function') window.showSearchResults(); else showSearchResults();"
        onblur="setTimeout(() => { if(typeof window.hideSearchResults === 'function') window.hideSearchResults(); else hideSearchResults(); if(typeof window.collapseSearch === 'function') window.collapseSearch(); else collapseSearch(); }, 200)"
      />
      <span class="universal-search-icon" onclick="if(typeof window.toggleSearch === 'function') window.toggleSearch(); else toggleSearch();" title="Search (Ctrl+K or Cmd+K)">ðŸ”</span>
      <span class="search-shortcut-hint">Ctrl+K</span>
      <div class="search-results" id="searchResults">
        <div class="search-no-results">Type to search...</div>
      </div>
    </div>
  </div>
  
  <!-- File Explorer Sidebar -->
  <div class="file-explorer-sidebar" id="fileExplorerSidebar">
    <div class="file-explorer-header" style="padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--accent-gradient); color: white;">
      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">ðŸ“ File Explorer</h3>
      <button class="file-explorer-close" onclick="if(typeof window.toggleFileExplorer === 'function') window.toggleFileExplorer(); else toggleFileExplorer();" title="Close (Esc)" class="btn-modern btn-modern-ghost" style="background: rgba(255,255,255,0.15); color: white; padding: 0.25rem 0.5rem; min-width: auto; width: auto; font-size: 1.5rem;">Ã—</button>
    </div>
    <div class="file-explorer-search">
      <input type="text" id="fileExplorerSearch" placeholder="Search files..." oninput="if(typeof window.filterFileTree === 'function') window.filterFileTree(this.value); else filterFileTree(this.value);">
    </div>
    <div class="file-explorer-nav">
      <button id="fileExplorerPrev" onclick="if(typeof window.navigateFile === 'function') window.navigateFile('prev'); else navigateFile('prev');" title="Previous file" disabled>â—€ Prev</button>
      <button id="fileExplorerNext" onclick="if(typeof window.navigateFile === 'function') window.navigateFile('next'); else navigateFile('next');" title="Next file" disabled>Next â–¶</button>
    </div>
    <ul class="file-tree" id="fileTree">
      <!-- Will be populated by JavaScript -->
    </ul>
  </div>
  
  <!-- File Explorer Toggle Button - Also available in unified navigation header -->
  <!-- Keeping this for quick access, but header button is primary -->
  <button class="file-explorer-toggle" onclick="if(typeof window.toggleFileExplorer === 'function') { window.toggleFileExplorer(); } else { console.error('toggleFileExplorer not available'); }" title="Toggle File Explorer (Ctrl+B)" style="position: fixed; left: 1rem; top: 8rem; z-index: 998; background: var(--bg-secondary); border: 1.5px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 0.625rem; color: var(--text-primary); cursor: pointer; font-size: 1.5rem; box-shadow: var(--shadow); transition: var(--transition); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
    ðŸ“
  </button>
  
  <div class="container">
    <!-- Timeline Container (moved from tabs) -->
    <div id="timelineContainer" style="width: 100%; min-height: 400px; margin-bottom: 2rem; padding: 2rem; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
      <!-- Enhanced timeline will be rendered here -->
    </div>
    
    <!-- Quick Access Buttons - Horizontal row -->
    <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; padding: 1rem; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
      <div class="docx-dropdown" style="display: flex; gap: 0.5rem; align-items: center; position: relative;">
        <button class="docx-main-button" onclick="event.stopPropagation(); openLatestPaper();" style="display: flex; align-items: center; gap: 0.5rem; padding-right: 0;">
          ðŸ“„ Final Paper (DOCX)
        </button>
        <button class="docx-arrow-button" onclick="event.stopPropagation(); toggleDocxDropdown();" style="background: var(--accent); color: white; border: none; padding: 0.625rem 0.5rem; border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0; cursor: pointer; display: flex; align-items: center; transition: var(--transition);" onmouseover="this.style.background='var(--accent-dark)'" onmouseout="this.style.background='var(--accent)'">
          <span id="docxArrow">â–¼</span>
        </button>
        <div class="docx-dropdown-content" id="docxDropdown">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      <button class="docx-main-button" onclick="window.location.href='research_hub.html'" title="Research Hub - Cross-referenced documents, papers, and AI/ML ideas">
        ðŸ“š Research Hub
      </button>
      <button class="docx-main-button" onclick="toggleDocumentExplorer()" title="Document Explorer - Browse all project files">
        ðŸ“ Documents
      </button>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="showTab('timeline', this)">Timeline</button>
      <button class="tab" onclick="showTab('knowledge-graph', this)">Knowledge Graph</button>
      <button class="tab" onclick="showTab('status', this)">Script Status</button>
      <button class="tab" onclick="showTab('dashboard', this)">Dashboard</button>
      <button class="tab" onclick="showTab('guide', this)">Build Guide</button>
      <button class="tab" onclick="showTab('logs', this)">Logs</button>
    </div>
    
    <!-- Timeline Tab -->
    <div id="timeline" class="tab-content active">
      <div class="stats">
        <div class="stat-card clickable" onclick="openFile(getLocalPath('tables/final_selected_variables_CLEAN.csv'), event)" style="cursor: pointer; transition: var(--transition);" title="Click to view variable selection table" onmouseover="this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
          <div class="stat-value">26</div>
          <div class="stat-label">Clean Variables</div>
        </div>
        <div class="stat-card clickable" onclick="openFile(getLocalPath('tables/model_comparison_CLEAN_variables.csv'), event)" style="cursor: pointer; transition: var(--transition);" title="Click to view model comparison table" onmouseover="this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
          <div class="stat-value">7</div>
          <div class="stat-label">Models</div>
        </div>
        <div class="stat-card clickable" onclick="window.open('tables_portfolio.html#table5', '_blank')" style="cursor: pointer; transition: var(--transition);" title="Click to view model comparison table (Table 5)" onmouseover="this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
          <div class="stat-value">73.71%</div>
          <div class="stat-label">Best RÂ² (XGBoost)</div>
        </div>
        <div class="stat-card clickable" onclick="window.location.href='figures_portfolio.html'" style="cursor: pointer; transition: var(--transition);" onmouseover="this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
          <div class="stat-value">34</div>
          <div class="stat-label">Figures</div>
        </div>
        <div class="stat-card clickable" onclick="window.location.href='tables_portfolio.html'" style="cursor: pointer; transition: var(--transition);" onmouseover="this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
          <div class="stat-value">16</div>
          <div class="stat-label">Tables</div>
        </div>
      </div>
      
      <!-- Figures Carousel -->
      <div class="carousel-container" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
          <h3 style="margin: 0; color: var(--accent); font-size: 1.375rem; font-weight: 600;">ðŸ“Š Figures</h3>
          <button onclick="window.location.href='figures_portfolio.html'" class="view-all-btn" title="View all figures">
            <span>View All</span>
            <span>â†’</span>
          </button>
        </div>
        <div class="carousel" id="figuresCarousel">
          <button class="carousel-nav carousel-prev" onclick="if(typeof window.scrollCarousel === 'function') { window.scrollCarousel('figuresCarousel', -1); } else { console.error('scrollCarousel not available'); }">â—€</button>
          <div class="carousel-track" id="figuresCarouselTrack">
            <!-- Figures will be loaded here -->
          </div>
          <button class="carousel-nav carousel-next" onclick="if(typeof window.scrollCarousel === 'function') { window.scrollCarousel('figuresCarousel', 1); } else { console.error('scrollCarousel not available'); }">â–¶</button>
        </div>
      </div>
      
      <!-- Tables Carousel -->
      <div class="carousel-container" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
          <h3 style="margin: 0; color: var(--accent); font-size: 1.375rem; font-weight: 600;">ðŸ“‹ Tables</h3>
          <button onclick="window.location.href='tables_portfolio.html'" class="view-all-btn" title="View all tables">
            <span>View All</span>
            <span>â†’</span>
          </button>
        </div>
        <div class="carousel" id="tablesCarousel">
          <button class="carousel-nav carousel-prev" onclick="if(typeof window.scrollCarousel === 'function') { window.scrollCarousel('tablesCarousel', -1); } else { console.error('scrollCarousel not available'); }">â—€</button>
          <div class="carousel-track" id="tablesCarouselTrack">
            <!-- Tables will be loaded here -->
          </div>
          <button class="carousel-nav carousel-next" onclick="if(typeof window.scrollCarousel === 'function') { window.scrollCarousel('tablesCarousel', 1); } else { console.error('scrollCarousel not available'); }">â–¶</button>
        </div>
      </div>
      
      <!-- Knowledge Graph Section -->
      <div id="knowledge-graph" class="tab-content" style="display: none;">
        <div style="margin-bottom: 2rem;">
          <h3 style="color: var(--accent); margin-bottom: 1rem;">Research Knowledge Graph</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Visualize relationships between variables, models, results, figures, and tables. Click on nodes to explore connections.
          </p>
          <div id="knowledgeGraphContainer" style="width: 100%; min-height: 600px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color); position: relative;">
            <!-- Knowledge graph will be rendered here -->
          </div>
        </div>
      </div>
      
      <div class="timeline-controls" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: 2rem; box-shadow: var(--shadow-sm);">
        <div class="timeline-controls-row1">
          <button class="active" onclick="filterTimeline('all')">All Items</button>
          <button onclick="filterTimeline('important')">Important (100)</button>
          <button onclick="filterTimeline('most_important')">Most Important (10)</button>
          <button onclick="filterTimeline('milestone')">Milestones Only</button>
          <button onclick="filterTimeline('correction')">Corrections</button>
          <select onchange="filterTimelineByType(this.value)" class="input-modern" style="font-size: 0.875rem; padding: 0.625rem 1rem;">
            <option value="all">All Types</option>
            <option value="methodology">Methodology</option>
            <option value="correction">Corrections</option>
            <option value="output">Output</option>
            <option value="documentation">Documentation</option>
          </select>
        </div>
        <div class="timeline-controls-row2" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
          <button class="round-button" onclick="toggleSortOrder()" title="Toggle Sort Order">
            <span id="sortIcon">â‡…</span>
          </button>
          <span id="sortLabel" style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 0.75rem; font-weight: 500;">Chronological (Old â†’ New)</span>
        </div>
      </div>
      
      <div class="timeline-container">
        <div class="timeline" id="timeline-content">
          <!-- Timeline items will be inserted here by JavaScript -->
        </div>
      </div>
      
    </div>
    
    <!-- Knowledge Graph Tab -->
    <div id="knowledge-graph" class="tab-content" style="display: none;">
      <div style="margin-bottom: 2rem;">
        <h3 style="color: var(--accent); margin-bottom: 1rem;">Research Knowledge Graph</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
          Visualize relationships between variables, models, results, figures, and tables. Click on nodes to explore connections.
        </p>
        <div id="knowledgeGraphContainer" style="width: 100%; min-height: 600px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color); position: relative;">
          <!-- Knowledge graph will be rendered here -->
        </div>
      </div>
    </div>
    
    <!-- Script Status Tab -->
    <div id="status" class="tab-content">
      <div class="dashboard-card">
        <h3>ðŸ“Š Script Status</h3>
        <div id="script-status-content">
          <p>Loading script status...</p>
        </div>
        <div id="script-status-explanation"></div>
      </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content">
      <input type="text" class="search-box" placeholder="Search files..." onkeyup="searchFiles(this.value)">
      
      <div class="dashboard">
        <div class="dashboard-card">
          <h3>ðŸ“„ Paper Files</h3>
          <ul class="file-list" id="paper-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>
        
        <div class="dashboard-card">
          <h3>ðŸ“Š Analysis Scripts</h3>
          <ul class="file-list" id="script-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>
        
        <div class="dashboard-card">
          <h3>ðŸ“ˆ Results & Data</h3>
          <ul class="file-list" id="result-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>

        <div class="dashboard-card">
          <h3>ðŸ“‹ Documentation</h3>
          <ul class="file-list" id="doc-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>

        <div class="dashboard-card">
          <h3>ðŸ“ Log Files</h3>
          <ul class="file-list" id="log-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>

        <div class="dashboard-card">
          <h3>ðŸ”§ All Scripts</h3>
          <ul class="file-list" id="scripts-all-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>

        <div class="dashboard-card">
          <h3>ðŸ› ï¸ Utility Scripts</h3>
          <ul class="file-list" id="utilities-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>

        <div class="dashboard-card">
          <h3>ðŸ“š Documentation</h3>
          <ul class="file-list" id="doc-files">
            <!-- Will be populated by JavaScript -->
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Build Guide Tab -->
    <div id="guide" class="tab-content">
      <div class="dashboard-card">
        <h3>Quick Links</h3>
        <ul class="file-list">
          <li><a href="#" onclick="openFileFromDrive('PAPER_BUILD_GUIDE.md', event); return false;">Complete Build Guide</a> <span class="file-type">MD</span></li>
          <li><a href="#" onclick="openFileFromDrive('METHODOLOGY_EVOLUTION_DOCUMENTATION.md', event); return false;">Methodology Evolution</a> <span class="file-type">MD</span></li>
          <li><a href="#" onclick="openFileFromDrive('VARIABLE_SELECTION_DOCUMENTATION.md', event); return false;">Variable Selection</a> <span class="file-type">MD</span></li>
          <li><a href="#" onclick="openFileFromDrive('TODO_PAPER_COMPLETION.md', event); return false;">TODO Checklist</a> <span class="file-type">MD</span></li>
          <li><a href="#" onclick="openFileFromDrive('MARKOS_REVIEW_NEEDED.md', event); return false;">Review Items</a> <span class="file-type">MD</span></li>
        </ul>
      </div>
    </div>
    
    <!-- Logs Tab -->
    <div id="logs" class="tab-content">
      <div class="dashboard-card">
        <h3>Analysis Logs</h3>
        <ul class="file-list">
          <li><a href="#" onclick="openFileFromDrive('all_models_CLEAN.log', event); return false;">All Models (Clean Variables)</a> <span class="file-type">LOG</span></li>
          <li><a href="#" onclick="openFileFromDrive('comprehensive_analysis_ALL.log', event); return false;">Comprehensive Analysis</a> <span class="file-type">LOG</span></li>
          <li><a href="#" onclick="openFileFromDrive('eds_comprehensive_analysis.log', event); return false;">EDS Analysis</a> <span class="file-type">LOG</span></li>
          <li><a href="#" onclick="openFileFromDrive('future_work_analyses.log', event); return false;">Future Work Analyses</a> <span class="file-type">LOG</span></li>
        </ul>
      </div>
      
      <div class="dashboard-card">
        <h3>Development Logs</h3>
        <ul class="file-list">
          <li><a href="#" onclick="openFileFromDrive('DEVELOPMENT_LOG_COMPLETE.md', event); return false;">Complete Log</a> <span class="file-type">MD</span></li>
          <li><a href="#" onclick="openFileFromDrive('DEVELOPMENT_LOG_SUMMARY.md', event); return false;">Summary Log</a> <span class="file-type">MD</span></li>
        </ul>
      </div>
    </div>
  </div>
  
  <script>
    // Google Drive link configuration (defined at top for all functions)
    const DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/1PSRm7LG9QyBRnVgHREzQITe5Bthrniro?usp=sharing';
    // Make globally accessible
    window.DRIVE_FOLDER_URL = DRIVE_FOLDER_URL;
    
    // Function to open files (local or Google Drive)
    function openFileFromDrive(fileName, event) {
      if (event) {
        event.preventDefault();
      }
      
      // Detect if running on localhost
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      // Determine if file is MD or LOG and use local path
      const ext = fileName.split('.').pop().toLowerCase();
      let filePath = '';
      
      if (ext === 'md') {
        filePath = isLocalhost ? `../paper_a_analysis/${fileName}` : `docs/${fileName}`;
      } else if (ext === 'log') {
        filePath = isLocalhost ? `../paper_a_analysis/${fileName}` : `logs/${fileName}`;
      } else if (ext === 'r' || ext === 'R') {
        // R scripts in paper_a_analysis
        filePath = isLocalhost ? `../paper_a_analysis/${fileName}` : DRIVE_FOLDER_URL;
      } else {
        // For other files, use Google Drive
        showFilePreview(DRIVE_FOLDER_URL, fileName);
        return;
      }
      
      // Try to open local file first
      showFilePreview(filePath, fileName);
    }
    
    // Make globally available
    window.openFileFromDrive = openFileFromDrive;
    
    // Load timeline data from JSON
    let timelineData = [];
    let allTimelineData = [];
    
    // Load JSON data - try multiple paths
    function loadTimelineData() {
      const isLocalhost = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.protocol === 'file:';
      
      const paths = isLocalhost 
        ? ['../paper_a_analysis/TIMELINE_DATA.json', 'paper_a_analysis/TIMELINE_DATA.json', '../../paper_a_analysis/TIMELINE_DATA.json', 'TIMELINE_DATA.json']
        : ['TIMELINE_DATA.json', 'docs/TIMELINE_DATA.json', '../paper_a_analysis/TIMELINE_DATA.json'];
      
      let pathIndex = 0;
      const tryNextPath = () => {
        if (pathIndex >= paths.length) {
          console.warn('Timeline data not found in any expected location');
          timelineData = [];
          allTimelineData = [];
          return;
        }
        
        fetch(paths[pathIndex])
          .then(response => {
            if (!response.ok) throw new Error('Not found');
            return response.json();
          })
          .then(data => {
            allTimelineData = data.timeline || data || [];
            timelineData = allTimelineData;
            renderTimeline();
            console.log('Timeline data loaded from:', paths[pathIndex]);
          })
          .catch(error => {
            pathIndex++;
            tryNextPath();
          });
      };
      
      tryNextPath();
    }
    
    loadTimelineData();
    
    // Legacy data structure for compatibility
    const legacyTimelineData = [
      {
        date: "December 2024",
        title: "Baseline Established",
        type: "milestone",
        content: "Created initial data loading and cleaning scripts. Established baseline with simple linear model (3 variables: mass, AER, region).",
        result: "44.65% RÂ²",
        files: ["01_data_loading.R", "02_data_cleaning.R", "03_energy_calculations.R", "05_variable_importance.R"],
        tags: ["Baseline", "Initial Analysis"]
      },
      {
        date: "January 2025",
        title: "Feature Engineering",
        type: "milestone",
        content: "Added EDS as critical predictor. Created engineered features (ratios, interactions). Expanded to 12 variables.",
        result: "59.44% RÂ² (Random Forest)",
        files: ["05_variable_importance_FINAL.R"],
        tags: ["Feature Engineering", "EDS Added"]
      },
      {
        date: "February-March 2025",
        title: "Hyperparameter Tuning",
        type: "milestone",
        content: "Systematic hyperparameter tuning. Expanded to 18 variables. Added engine displacement, vehicle length, registration year.",
        result: "71.56% RÂ² (Random Forest, intermediate phase)",
        files: ["Updated 05_variable_importance_FINAL.R"],
        tags: ["Tuning", "Intermediate Phase"]
      },
      {
        date: "April-May 2025",
        title: "Comprehensive Analysis",
        type: "milestone",
        content: "Expanded to 44 variables. Implemented 7 models (RF, XGBoost, LightGBM, CatBoost, GAM, NN, Ensemble). Extensive hyperparameter tuning.",
        result: "91.88% RÂ² (Random Forest) - later identified as inflated",
        files: ["09_comprehensive_model_comparison_ALL.R", "10_create_comprehensive_figures_ALL.R"],
        tags: ["Comprehensive", "All Models"]
      },
      {
        date: "June 2025",
        title: "Circular Variables Identified",
        type: "correction",
        content: "Identified 25 circular variables (derived from outcome). Created script to identify and document them.",
        result: "26 clean variables selected",
        files: ["09d_identify_circular_variables.R", "VARIABLE_SELECTION_DOCUMENTATION.md"],
        tags: ["Correction", "Variable Selection"]
      },
      {
        date: "July 2025",
        title: "Clean Variable Selection",
        type: "milestone",
        content: "Applied VIF-based multicollinearity reduction. Selected final 26 clean variables.",
        result: "26 clean variables finalized",
        files: ["09f_final_variable_selection_CLEAN.R", "tables/final_selected_variables_CLEAN.csv"],
        tags: ["Variable Selection", "Clean Variables"]
      },
      {
        date: "August-September 2025",
        title: "Clean Variable Analysis",
        type: "milestone",
        content: "Re-ran all models with 26 clean variables. Used parameter transfer approach (best hyperparameters from 44-variable runs).",
        result: "71.63% RÂ² (RF), 73.71% (XGBoost), 73.22% (NN), 64.31% (GAM)",
        files: ["09g_all_models_CLEAN_variables.R", "tables/model_comparison_CLEAN_variables.csv"],
        tags: ["Clean Variables", "Realistic Results"]
      },
      {
        date: "October 2025",
        title: "EDS Comprehensive Analysis",
        type: "milestone",
        content: "Created comprehensive country-level EDS analysis. Fixed temperature data merging (explicitly use MS column).",
        result: "10 analysis types, 16 tables, 19 figures",
        files: ["11_eds_comprehensive_analysis.R", "12_create_eds_comprehensive_figures.R"],
        tags: ["EDS Analysis", "Country-Level"]
      },
      {
        date: "November 2025",
        title: "Future Work Analyses",
        type: "milestone",
        content: "Created individual vehicle EDS prediction, temporal analysis, charging infrastructure analysis. Fixed circularity in EDS prediction.",
        result: "3 new analysis types, 3 figures",
        files: ["13_individual_vehicle_eds_analysis.R", "14_temporal_analysis.R", "15_charging_infrastructure_analysis.R"],
        tags: ["Future Work", "Additional Analyses"]
      },
      {
        date: "December 2025",
        title: "Consistency Fixes",
        type: "correction",
        content: "Fixed all consistency issues: 71.56% vs 71.63%, variable sets (26 vs 44), section updates. Updated Section 1.4 and 5.3. Fixed abstract.",
        result: "All sections consistent",
        files: ["PAPER_DRAFT.md", "PAPER_DRAFT_20_CONSISTENCY_FIXED.docx"],
        tags: ["Correction", "Finalization"]
      },
      {
        date: "17 Dec 2025 05:00",
        title: "âœ… Ensemble Model Completed",
        type: "milestone",
        content: "Ensemble model successfully completed. Fixed skip logic for GAM, fixed saving section to use all_results. Ensemble combines RF, XGBoost, GAM, and Neural Network using weighted average based on test RÂ².",
        result: "Ensemble: 73.54% test RÂ², 2.98 kWh/100 km RMSE, 2.07 kWh/100 km MAE, 9.56% MAPE",
        files: ["09g_all_models_CLEAN_variables.R", "tables/model_comparison_CLEAN_variables.csv"],
        tags: ["Models", "Ensemble", "Complete"]
      },
      {
        date: "17 Dec 2025 05:10",
        title: "âœ… Final Comparison Figures Created",
        type: "milestone",
        content: "Created 3 new comparison figures: figure6_model_comparison_final.png (RÂ² comparison with Ensemble), figure6b_comprehensive_metrics_comparison.png (all metrics), figure6c_train_test_comparison.png (generalization).",
        result: "3 new figures added",
        files: ["create_final_comparison_figures.R", "figures/figure6_model_comparison_final.png", "figures/figure6b_comprehensive_metrics_comparison.png", "figures/figure6c_train_test_comparison.png"],
        tags: ["Figures", "Visualization", "Complete"]
      },
      {
        date: "17 Dec 2025 05:15",
        title: "âœ… Final Paper DOCX Generated",
        type: "milestone",
        content: "Generated PAPER_DRAFT_27_FINAL_COMPLETE.docx with all updates: Ensemble results, updated figure captions, all model comparisons, comprehensive metrics. Paper ready for Markos review.",
        result: "Final DOCX with all models including Ensemble",
        files: ["PAPER_DRAFT_27_FINAL_COMPLETE.docx", "PAPER_DRAFT.md"],
        tags: ["Document", "Final", "Complete"]
      }
    ];
    
    // File data for dashboard
    const fileData = {
      paper: [
        { name: "PAPER_DRAFT.md", path: "docs/PAPER_DRAFT.md", type: "MD", desc: "Main paper source (single source of truth)" },
        { name: "LATEST_PAPER_DRAFT.docx", path: "LATEST_PAPER_DRAFT.docx", type: "DOCX", desc: "ðŸŽ¯ LATEST - Always the most recent paper draft (auto-updated)" },
        { name: "PAPER_DRAFT_34.docx", path: "../paper_a_analysis/PAPER_DRAFT_34.docx", type: "DOCX", desc: "ðŸŽ¯ NEWEST - Updated author: Markos A. Ktistakis, ... (Dec 2025)" },
        { name: "PAPER_DRAFT_27_FINAL_COMPLETE.docx", path: "../paper_a_analysis/PAPER_DRAFT_27_FINAL_COMPLETE.docx", type: "DOCX", desc: "FINAL - All models complete including Ensemble" },
        { name: "PAPER_OUTLINE.md", path: "docs/PAPER_OUTLINE.md", type: "MD", desc: "Paper structure outline" }
      ],
      scripts: [
        { name: "09g_all_models_CLEAN_variables.R", path: "../paper_a_analysis/09g_all_models_CLEAN_variables.R", type: "R", desc: "âœ… Main analysis script (all models + Ensemble, 26 clean vars)" },
        { name: "create_final_comparison_figures.R", path: "../paper_a_analysis/create_final_comparison_figures.R", type: "R", desc: "Creates final comparison figures (6, 6b, 6c)" },
        { name: "11_eds_comprehensive_analysis.R", path: "../paper_a_analysis/11_eds_comprehensive_analysis.R", type: "R", desc: "EDS country-level analysis" },
        { name: "12_create_eds_comprehensive_figures.R", path: "../paper_a_analysis/12_create_eds_comprehensive_figures.R", type: "R", desc: "Create EDS figures" },
        { name: "13_individual_vehicle_eds_analysis.R", path: "../paper_a_analysis/13_individual_vehicle_eds_analysis.R", type: "R", desc: "Individual vehicle EDS prediction" },
        { name: "14_temporal_analysis.R", path: "../paper_a_analysis/14_temporal_analysis.R", type: "R", desc: "Temporal trends analysis" },
        { name: "15_charging_infrastructure_analysis.R", path: "../paper_a_analysis/15_charging_infrastructure_analysis.R", type: "R", desc: "Charging infrastructure analysis" },
        { name: "99_run_future_work_analyses.R", path: "../paper_a_analysis/99_run_future_work_analyses.R", type: "R", desc: "Master script for future work" }
      ],
      results: [
        { name: "model_comparison_CLEAN_variables.csv", path: "../paper_a_analysis/tables/model_comparison_CLEAN_variables.csv", type: "CSV", desc: "âœ… Final model results (RF, XGBoost, GAM, NN, Ensemble - 26 clean vars)" },
        { name: "final_selected_variables_CLEAN.csv", path: "../paper_a_analysis/tables/final_selected_variables_CLEAN.csv", type: "CSV", desc: "26 clean variables list" },
        { name: "linear_model_baseline_results.csv", path: "../paper_a_analysis/tables/linear_model_baseline_results.csv", type: "CSV", desc: "Linear model baseline results" }
      ],
      docs: [
        { name: "PAPER_BUILD_GUIDE.md", path: "docs/PAPER_BUILD_GUIDE.md", type: "MD", desc: "Complete build guide" },
        { name: "METHODOLOGY_EVOLUTION_DOCUMENTATION.md", path: "docs/METHODOLOGY_EVOLUTION_DOCUMENTATION.md", type: "MD", desc: "Methodology evolution" },
        { name: "VARIABLE_SELECTION_DOCUMENTATION.md", path: "docs/VARIABLE_SELECTION_DOCUMENTATION.md", type: "MD", desc: "Variable selection rationale" },
        { name: "DEVELOPMENT_LOG_COMPLETE.md", path: "docs/DEVELOPMENT_LOG_COMPLETE.md", type: "MD", desc: "Complete development log" },
        { name: "DEVELOPMENT_LOG_SUMMARY.md", path: "docs/DEVELOPMENT_LOG_SUMMARY.md", type: "MD", desc: "Summary log (important only)" },
        { name: "TODO_PAPER_COMPLETION.md", path: "docs/TODO_PAPER_COMPLETION.md", type: "MD", desc: "Completion checklist" },
        { name: "MARKOS_REVIEW_NEEDED.md", path: "docs/MARKOS_REVIEW_NEEDED.md", type: "MD", desc: "Items for review" },
        { name: "FUTURE_WORK_PROPOSAL.md", path: "docs/FUTURE_WORK_PROPOSAL.md", type: "MD", desc: "Future work proposals" },
        { name: "ALL_MODELS_COMPLETE_SUMMARY.md", path: "docs/ALL_MODELS_COMPLETE_SUMMARY.md", type: "MD", desc: "All models summary" },
        { name: "COMPLETE_UPDATE_SUMMARY.md", path: "docs/COMPLETE_UPDATE_SUMMARY.md", type: "MD", desc: "Complete update summary" }
      ],
      logs: [
        { name: "all_models_CLEAN.log", path: "logs/all_models_CLEAN.log", type: "LOG", desc: "All models script log (26 clean vars)" },
        { name: "comprehensive_analysis_ALL.log", path: "logs/comprehensive_analysis_ALL.log", type: "LOG", desc: "Comprehensive analysis (all models) log" },
        { name: "comprehensive_analysis.log", path: "logs/comprehensive_analysis.log", type: "LOG", desc: "Comprehensive analysis log" },
        { name: "eds_comprehensive_analysis.log", path: "logs/eds_comprehensive_analysis.log", type: "LOG", desc: "EDS comprehensive analysis log" },
        { name: "eds_analysis.log", path: "logs/eds_analysis.log", type: "LOG", desc: "EDS analysis log" },
        { name: "future_work_analyses.log", path: "logs/future_work_analyses.log", type: "LOG", desc: "Future work analyses log" },
        { name: "monitor.log", path: "logs/monitor.log", type: "LOG", desc: "Monitor script log" }
      ],
      scripts_all: [
        { name: "01_data_loading.R", path: "../paper_a_analysis/01_data_loading.R", type: "R", desc: "Data loading script" },
        { name: "02_data_cleaning.R", path: "../paper_a_analysis/02_data_cleaning.R", type: "R", desc: "Data cleaning script" },
        { name: "03_energy_calculations.R", path: "../paper_a_analysis/03_energy_calculations.R", type: "R", desc: "Energy calculations" },
        { name: "05_variable_importance_FINAL.R", path: "../paper_a_analysis/05_variable_importance_FINAL.R", type: "R", desc: "Variable importance analysis" },
        { name: "09g_all_models_CLEAN_variables.R", path: "../paper_a_analysis/09g_all_models_CLEAN_variables.R", type: "R", desc: "âœ… All models + Ensemble (26 clean vars)" },
        { name: "create_final_comparison_figures.R", path: "../paper_a_analysis/create_final_comparison_figures.R", type: "R", desc: "Creates comparison figures 6, 6b, 6c" },
        { name: "11_eds_comprehensive_analysis.R", path: "../paper_a_analysis/11_eds_comprehensive_analysis.R", type: "R", desc: "EDS comprehensive analysis" },
        { name: "12_create_eds_comprehensive_figures.R", path: "../paper_a_analysis/12_create_eds_comprehensive_figures.R", type: "R", desc: "Create EDS figures" },
        { name: "13_individual_vehicle_eds_analysis.R", path: "../paper_a_analysis/13_individual_vehicle_eds_analysis.R", type: "R", desc: "Individual vehicle EDS" },
        { name: "14_temporal_analysis.R", path: "../paper_a_analysis/14_temporal_analysis.R", type: "R", desc: "Temporal analysis" },
        { name: "15_charging_infrastructure_analysis.R", path: "../paper_a_analysis/15_charging_infrastructure_analysis.R", type: "R", desc: "Charging infrastructure" },
        { name: "99_run_future_work_analyses.R", path: "../paper_a_analysis/99_run_future_work_analyses.R", type: "R", desc: "Master script for future work" }
      ],
      utilities: [
        { name: "monitor_script_status.sh", path: "../paper_a_analysis/monitor_script_status.sh", type: "SH", desc: "Monitor script status and send notifications" },
        { name: "check_and_notify_when_done.sh", path: "../paper_a_analysis/check_and_notify_when_done.sh", type: "SH", desc: "Check analysis status and notify" },
        { name: "monitor_and_notify.py", path: "../paper_a_analysis/monitor_and_notify.py", type: "PY", desc: "Python monitor script" }
      ]
    };
    
    // Tab switching
    function showTab(tabName, eventElement) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Activate the clicked tab button
      if (eventElement) {
        eventElement.classList.add('active');
      } else {
        // Find the tab button by onclick attribute
        document.querySelectorAll('.tab').forEach(t => {
          const onclick = t.getAttribute('onclick');
          if (onclick && onclick.includes(tabName)) {
            t.classList.add('active');
          }
        });
      }
      
      // Show the corresponding tab content
      const tabContent = document.getElementById(tabName);
      if (tabContent) {
        tabContent.classList.add('active');
      } else {
        console.warn('Tab content not found:', tabName);
      }
    }
    
    // Make globally accessible
    window.showTab = showTab;
    
    // Timeline rendering
    function renderTimeline(data = timelineData) {
      const container = document.getElementById('timeline-content');
      if (!data || data.length === 0) {
        container.innerHTML = '<p>Loading timeline data...</p>';
        return;
      }
      
      container.innerHTML = data.map((item, index) => {
        const importance = item.importance || 100;
        const importanceClass = importance === 10 ? 'most-important' : importance === 100 ? 'important' : 'all-items';
          const fileLinks = (item.files || []).map(file => {
          // Determine file path based on extension
          // Detect if running on localhost
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          let filePath = '';
          if (file.endsWith('.png')) {
            // Figures are in repo
            filePath = isLocalhost ? `../paper_a_analysis/figures/${file}` : `figures/${file}`;
          } else if (file.endsWith('.csv')) {
            // Tables are in repo
            filePath = isLocalhost ? `../paper_a_analysis/tables/${file}` : `tables/${file}`;
          } else if (file.includes('PAPER_DRAFT') && file.endsWith('.docx')) {
            // Check if it's the latest (always available as LATEST_PAPER_DRAFT.docx)
            if (file.includes('LATEST') || file === 'PAPER_DRAFT_34.docx' || file === 'PAPER_DRAFT_33_COMPLETE_WITH_ALL_FIGURES.docx') {
              filePath = isLocalhost ? `../paper_a_analysis/LATEST_PAPER_DRAFT.docx` : 'LATEST_PAPER_DRAFT.docx';
            } else {
              // Other DOCX files are in Google Drive
              filePath = DRIVE_FOLDER_URL;
            }
          } else if (file.endsWith('.md')) {
            // MD files in paper_a_analysis
            filePath = isLocalhost ? `../paper_a_analysis/${file}` : `docs/${file}`;
          } else if (file.endsWith('.log')) {
            // LOG files in paper_a_analysis
            filePath = isLocalhost ? `../paper_a_analysis/${file}` : `logs/${file}`;
          } else if (file.endsWith('.R')) {
            // R scripts in paper_a_analysis
            filePath = isLocalhost ? `../paper_a_analysis/${file}` : DRIVE_FOLDER_URL;
          } else {
            // All other files point to Google Drive
            filePath = DRIVE_FOLDER_URL;
          }
          return `<li><a href="#" target="_blank" onclick="event.stopPropagation(); openFile('${filePath}', event); return false;">${file}</a></li>`;
        }).join('');
        
        // Format date for display (already includes time from JSON)
        const displayDate = item.date; // Format: "16 Dec 2025 14:30"
        
        return `
        <div class="timeline-item ${item.type} ${importanceClass}" data-type="${item.type}" data-importance="${importance}">
          <div class="timeline-date">${displayDate}</div>
          <div class="timeline-content">
            <div class="timeline-title">${item.title}</div>
            <p>${item.content}</p>
            ${item.result ? `<p><strong>Result:</strong> ${item.result}</p>` : ''}
            ${fileLinks ? `
              <div style="margin-top: 1rem;">
                <strong>Files:</strong>
                <ul style="margin-top: 0.5rem; margin-left: 1.5rem; list-style: none; padding-left: 0;">
                  ${fileLinks}
                </ul>
              </div>
            ` : ''}
            <div class="timeline-tags">
              ${(item.tags || []).map(tag => `<span class="tag ${item.type === 'milestone' ? 'milestone' : ''}">${tag}</span>`).join('')}
              <span class="tag" style="background: #e8f4f8; color: #0f4c81;">Importance: ${importance}</span>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }
    
    // Timeline filtering
    function filterTimeline(filter) {
      document.querySelectorAll('.timeline-controls button').forEach(b => {
        if (b.textContent.includes(filter) || (filter === 'all' && b.textContent.includes('All'))) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
      
      const items = document.querySelectorAll('.timeline-item');
      items.forEach(item => {
        const importance = parseInt(item.dataset.importance) || 100;
        const type = item.dataset.type;
        
        if (filter === 'all') {
          item.classList.remove('filtered', 'hidden');
        } else if (filter === 'important') {
          if (importance === 100 || importance === 10) {
            item.classList.remove('filtered', 'hidden');
          } else {
            item.classList.add('hidden');
          }
        } else if (filter === 'most_important') {
          if (importance === 10) {
            item.classList.remove('filtered', 'hidden');
          } else {
            item.classList.add('hidden');
          }
        } else if (filter === 'milestone') {
          if (type === 'milestone') {
            item.classList.remove('filtered', 'hidden');
          } else {
            item.classList.add('hidden');
          }
        } else if (filter === 'correction') {
          if (type === 'correction') {
            item.classList.remove('filtered', 'hidden');
          } else {
            item.classList.add('hidden');
          }
        }
      });
    }
    
    // Make globally accessible
    window.filterTimeline = filterTimeline;
    window.filterTimelineByType = filterTimelineByType;
    
    // Filter by type
    function filterTimelineByType(type) {
      const items = document.querySelectorAll('.timeline-item');
      items.forEach(item => {
        if (type === 'all' || item.dataset.type === type) {
          item.classList.remove('filtered', 'hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    }
    
    let sortOrder = 'chronological';
    
    // Timeline sorting
    function toggleSortOrder() {
      sortOrder = sortOrder === 'chronological' ? 'reverse' : 'chronological';
      const container = document.getElementById('timeline-content');
      const items = Array.from(container.children).filter(item => !item.classList.contains('hidden'));
      
      // Parse dates in format "16 Dec 2025 14:30"
      const parseDate = (dateStr) => {
        const parts = dateStr.trim().split(' ');
        if (parts.length >= 4) {
          const day = parseInt(parts[0]);
          const month = parts[1];
          const year = parseInt(parts[2]);
          const time = parts[3] || '00:00';
          const [hour, minute] = time.split(':').map(Number);
          const monthMap = { 'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
                            'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12 };
          return new Date(year, monthMap[month] - 1, day, hour, minute);
        }
        return new Date(0);
      };
      
      if (sortOrder === 'reverse') {
        items.sort((a, b) => {
          const dateA = a.querySelector('.timeline-date').textContent;
          const dateB = b.querySelector('.timeline-date').textContent;
          return parseDate(dateB) - parseDate(dateA);
        });
        document.getElementById('sortIcon').textContent = 'â‡…';
        document.getElementById('sortLabel').textContent = 'Reverse (New â†’ Old)';
      } else {
        items.sort((a, b) => {
          const dateA = a.querySelector('.timeline-date').textContent;
          const dateB = b.querySelector('.timeline-date').textContent;
          return parseDate(dateA) - parseDate(dateB);
        });
        document.getElementById('sortIcon').textContent = 'â‡…';
        document.getElementById('sortLabel').textContent = 'Chronological (Old â†’ New)';
      }
      items.forEach(item => container.appendChild(item));
    }
    
    // Make globally accessible
    window.toggleSortOrder = toggleSortOrder;
    
    // DOCX Dropdown - sorted by version number (newest first)
    // Latest DOCX is always available as LATEST_PAPER_DRAFT.docx in the repo
    const docxFiles = [
      { name: "LATEST_PAPER_DRAFT.docx", path: "LATEST_PAPER_DRAFT.docx", desc: "ðŸŽ¯ LATEST - Always the most recent paper draft (auto-updated)" },
      { name: "PAPER_DRAFT_34.docx", path: "../paper_a_analysis/PAPER_DRAFT_34.docx", desc: "ðŸŽ¯ NEWEST - Updated author: Markos A. Ktistakis, ... (Dec 2025)" },
      { name: "PAPER_DRAFT_33_COMPLETE_WITH_ALL_FIGURES.docx", path: "../paper_a_analysis/PAPER_DRAFT_33_COMPLETE_WITH_ALL_FIGURES.docx", desc: "Complete with all figures (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_32_TABLES_FIXED.docx", path: "../paper_a_analysis/PAPER_DRAFT_32_TABLES_FIXED.docx", desc: "All tables expanded to full width with readable columns (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_30_WITH_IMAGES_PANDOC.docx", path: "../paper_a_analysis/PAPER_DRAFT_30_WITH_IMAGES_PANDOC.docx", desc: "With images included using pandoc rebase_relative_paths (4.8MB)" },
      { name: "PAPER_DRAFT_29_WITH_IMAGES.docx", path: "../paper_a_analysis/PAPER_DRAFT_29_WITH_IMAGES.docx", desc: "With images included (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_28_WITH_FIGURES_TABLES.docx", path: "../paper_a_analysis/PAPER_DRAFT_28_WITH_FIGURES_TABLES.docx", desc: "With markdown figure references (no images in DOCX)" },
      { name: "PAPER_DRAFT_27_FINAL_COMPLETE.docx", path: "../paper_a_analysis/PAPER_DRAFT_27_FINAL_COMPLETE.docx", desc: "FINAL - All models complete including Ensemble (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_26_FINAL.docx", path: "../paper_a_analysis/PAPER_DRAFT_26_FINAL.docx", desc: "FINAL - All updates complete (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_25_FORMATTED.docx", path: "../paper_a_analysis/PAPER_DRAFT_25_FORMATTED.docx", desc: "Formatted with author template (Dec 17, 2025)" },
      { name: "PAPER_DRAFT_24_FINAL_COMPLETE.docx", path: "../paper_a_analysis/PAPER_DRAFT_24_FINAL_COMPLETE.docx", desc: "Final Complete (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_23_COMPLETE_WITH_TESTS.docx", path: "../paper_a_analysis/PAPER_DRAFT_23_COMPLETE_WITH_TESTS.docx", desc: "With Statistical Tests (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_22_COMPLETE.docx", path: "../paper_a_analysis/PAPER_DRAFT_22_COMPLETE.docx", desc: "Complete Version (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_21_FINAL_UPDATES.docx", path: "../paper_a_analysis/PAPER_DRAFT_21_FINAL_UPDATES.docx", desc: "Final Updates (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_20_CONSISTENCY_FIXED.docx", path: "../paper_a_analysis/PAPER_DRAFT_20_CONSISTENCY_FIXED.docx", desc: "Consistency Fixes (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_19.docx", path: "../paper_a_analysis/PAPER_DRAFT_19.docx", desc: "Version 19 (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_18.docx", path: "../paper_a_analysis/PAPER_DRAFT_18.docx", desc: "Version 18 (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_17.docx", path: "../paper_a_analysis/PAPER_DRAFT_17.docx", desc: "Version 17 (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_16.docx", path: "../paper_a_analysis/PAPER_DRAFT_16.docx", desc: "Version 16 (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_15.docx", path: "../paper_a_analysis/PAPER_DRAFT_15.docx", desc: "Version 15 (Dec 16, 2025)" },
      { name: "PAPER_DRAFT_14.docx", path: "../paper_a_analysis/PAPER_DRAFT_14.docx", desc: "Version 14 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_13.docx", path: "../paper_a_analysis/PAPER_DRAFT_13.docx", desc: "Version 13 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_12.docx", path: "../paper_a_analysis/PAPER_DRAFT_12.docx", desc: "Version 12 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_11.docx", path: "../paper_a_analysis/PAPER_DRAFT_11.docx", desc: "Version 11 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_10.docx", path: "../paper_a_analysis/PAPER_DRAFT_10.docx", desc: "Version 10 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_9.docx", path: "../paper_a_analysis/PAPER_DRAFT_9.docx", desc: "Version 9 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT_8.docx", path: "../paper_a_analysis/PAPER_DRAFT_8.docx", desc: "Version 8 (Dec 15, 2025)" },
      { name: "PAPER_DRAFT.docx", path: "../paper_a_analysis/PAPER_DRAFT.docx", desc: "Initial Version (Dec 15, 2025)" },
    ];
    
    function renderDocxDropdown() {
      const dropdown = document.getElementById('docxDropdown');
      if (!dropdown) {
        console.warn('docxDropdown element not found');
        return;
      }
      dropdown.innerHTML = docxFiles.map((file, index) => `
        <a href="${file.path}" target="_blank" onclick="openFile('${file.path}', event); return false;">
          <strong>${file.name}</strong><br>
          <small style="color: var(--text-secondary);">${file.desc}</small>
        </a>
      `).join('');
    }
    
    // Initialize dropdown on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', renderDocxDropdown);
    } else {
      renderDocxDropdown();
    }
    
    function toggleDocxDropdown() {
      const dropdown = document.getElementById('docxDropdown');
      const arrow = document.getElementById('docxArrow');
      if (dropdown && arrow) {
        dropdown.classList.toggle('show');
        arrow.textContent = dropdown.classList.contains('show') ? 'â–²' : 'â–¼';
      }
    }
    
    // Make globally accessible immediately
    window.toggleDocxDropdown = toggleDocxDropdown;
    
    // Open latest paper in preview
    function openLatestPaper() {
      // Skip LATEST_PAPER_DRAFT.docx if it exists, use actual latest
      const latestPaper = docxFiles.find(f => f.name === 'PAPER_DRAFT_34.docx') || docxFiles.find(f => f.name.startsWith('PAPER_DRAFT_') && !f.name.includes('LATEST')) || docxFiles[1] || docxFiles[0];
      if (latestPaper && typeof openFile === 'function') {
        openFile(latestPaper.path, new Event('click'));
      } else {
        console.warn('openFile function not available or latest paper not found');
      }
    }
    window.openLatestPaper = openLatestPaper;
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('docxDropdown');
      const dropdownContainer = document.querySelector('.docx-dropdown');
      const arrowButton = document.querySelector('.docx-arrow-button');
      if (dropdown && dropdownContainer && !dropdownContainer.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
        const arrow = document.getElementById('docxArrow');
        if (arrow) arrow.textContent = 'â–¼';
      }
    });
    
    // Theme toggle - comprehensive update
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme') || localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
      }
      
      // Update all CSS variables for theme
      if (newTheme === 'dark') {
        document.documentElement.style.setProperty('--bg-primary', '#0f172a');
        document.documentElement.style.setProperty('--bg-secondary', '#1e293b');
        document.documentElement.style.setProperty('--bg-tertiary', '#334155');
        document.documentElement.style.setProperty('--text-primary', '#f1f5f9');
        document.documentElement.style.setProperty('--text-secondary', '#cbd5e1');
        document.documentElement.style.setProperty('--text-tertiary', '#94a3b8');
        document.documentElement.style.setProperty('--border-color', '#334155');
      } else {
        document.documentElement.style.setProperty('--bg-primary', '#f8fafc');
        document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
        document.documentElement.style.setProperty('--bg-tertiary', '#f1f5f9');
        document.documentElement.style.setProperty('--text-primary', '#0f172a');
        document.documentElement.style.setProperty('--text-secondary', '#64748b');
        document.documentElement.style.setProperty('--text-tertiary', '#94a3b8');
        document.documentElement.style.setProperty('--border-color', '#e2e8f0');
      }
      
      // Force re-render of unified header if it exists
      if (typeof window.updateUnifiedHeaderTheme === 'function') {
        window.updateUnifiedHeaderTheme(newTheme);
      }
    }
    
    // Make globally accessible
    window.toggleTheme = toggleTheme;
    
    // Make available early
    if (typeof window.toggleTheme === 'undefined') {
      window.toggleTheme = toggleTheme;
    }
    
    // Load saved theme and apply immediately - run on DOM ready
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
      }
      
    // Apply theme CSS variables immediately
    if (savedTheme === 'dark') {
      document.documentElement.style.setProperty('--bg-primary', '#0f172a');
      document.documentElement.style.setProperty('--bg-secondary', '#1e293b');
      document.documentElement.style.setProperty('--bg-tertiary', '#334155');
      document.documentElement.style.setProperty('--text-primary', '#f1f5f9');
      document.documentElement.style.setProperty('--text-secondary', '#cbd5e1');
      document.documentElement.style.setProperty('--text-tertiary', '#94a3b8');
      document.documentElement.style.setProperty('--border-color', '#334155');
    } else {
      document.documentElement.style.setProperty('--bg-primary', '#f8fafc');
      document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
      document.documentElement.style.setProperty('--bg-tertiary', '#f1f5f9');
      document.documentElement.style.setProperty('--text-primary', '#0f172a');
      document.documentElement.style.setProperty('--text-secondary', '#64748b');
      document.documentElement.style.setProperty('--text-tertiary', '#94a3b8');
      document.documentElement.style.setProperty('--border-color', '#e2e8f0');
      }
    }
    
    // Run immediately and on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTheme);
    } else {
      initTheme();
    }
    
    // Dashboard file rendering
    function renderFiles(category, files) {
      const container = document.getElementById(category);
      container.innerHTML = files.map(file => `
        <li>
          <a href="${file.path}" onclick="openFile('${file.path}', event); return false;">${file.name}</a>
          <span class="file-type">${file.type}</span>
          <div class="file-meta">${file.desc}</div>
        </li>
      `).join('');
    }
    
    // File search - enhanced
    function searchFiles(query) {
      if (!query || query.trim() === '') {
        // Show all files if search is empty
        document.querySelectorAll('.file-list li').forEach(item => {
          item.style.display = 'block';
        });
        return;
      }
      
      const searchTerm = query.toLowerCase().trim();
      const lists = document.querySelectorAll('.file-list');
      let foundCount = 0;
      
      lists.forEach(list => {
        const items = list.querySelectorAll('li');
        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          const matches = text.includes(searchTerm);
          item.style.display = matches ? 'block' : 'none';
          if (matches) foundCount++;
        });
      });
      
      // Also search in timeline if visible
      if (document.getElementById('timeline-content')) {
        const timelineItems = document.getElementById('timeline-content').querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
      }
    }
    
    // Make search globally accessible
    window.searchFiles = searchFiles;
    
    // Document Explorer
    function toggleDocumentExplorer() {
      const modal = document.getElementById('documentExplorerModal');
      if (!modal) {
        createDocumentExplorer();
        return;
      }
      modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
      if (modal.style.display === 'flex') {
        loadProjectFiles();
      }
    }
    
    function createDocumentExplorer() {
      const modal = document.createElement('div');
      modal.id = 'documentExplorerModal';
      modal.className = 'document-explorer-modal';
      modal.innerHTML = `
        <div class="document-explorer-content">
          <div class="document-explorer-header">
            <h2>ðŸ“ Document Explorer</h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button onclick="toggleDocumentExplorerView('icons')" class="view-toggle-btn active" id="viewIconsBtn">ðŸ–¼ï¸ Icons</button>
              <button onclick="toggleDocumentExplorerView('list')" class="view-toggle-btn" id="viewListBtn">ðŸ“‹ List</button>
              <select id="documentCategoryFilter" onchange="filterDocumentsByCategory(this.value)" class="input-modern" style="margin-left: 1rem;">
                <option value="all">All Categories</option>
                <option value="figures">Figures</option>
                <option value="tables">Tables</option>
                <option value="markdown">Markdown</option>
                <option value="documents">Documents</option>
                <option value="logs">Logs</option>
              </select>
              <button onclick="toggleDocumentExplorer()" class="close-btn" style="margin-left: auto; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">âœ•</button>
            </div>
          </div>
          <div class="document-explorer-body" id="documentExplorerBody">
            <p>Loading project files...</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Add styles if not present
      if (!document.getElementById('document-explorer-styles')) {
        const style = document.createElement('style');
        style.id = 'document-explorer-styles';
        style.textContent = `
          .document-explorer-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
          }
          .document-explorer-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
          }
          .document-explorer-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-gradient);
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
          }
          .document-explorer-header h2 {
            margin: 0;
            font-size: 1.5rem;
          }
          .document-explorer-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
          }
          .document-explorer-icons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
          }
          .document-explorer-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
          }
          .document-item-icon {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
          }
          .document-item-icon:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
          }
          .document-item-list {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition);
          }
          .document-item-list:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
          }
          .view-toggle-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
          }
          .view-toggle-btn:hover, .view-toggle-btn.active {
            background: rgba(255,255,255,0.3);
          }
        `;
        document.head.appendChild(style);
      }
    }
    
    function toggleDocumentExplorerView(view) {
      const body = document.getElementById('documentExplorerBody');
      const iconsBtn = document.getElementById('viewIconsBtn');
      const listBtn = document.getElementById('viewListBtn');
      
      if (view === 'icons') {
        body.className = 'document-explorer-icons';
        iconsBtn.classList.add('active');
        listBtn.classList.remove('active');
      } else {
        body.className = 'document-explorer-list';
        listBtn.classList.add('active');
        iconsBtn.classList.remove('active');
      }
      loadProjectFiles(); // Reload with new view
    }
    
    function filterDocumentsByCategory(category) {
      loadProjectFiles(category);
    }
    
    async function loadProjectFiles(category = 'all') {
      const body = document.getElementById('documentExplorerBody');
      if (!body) return;
      
      body.innerHTML = '<p>Loading project files...</p>';
      
      try {
        // Load files using project file loader
        if (window.projectFileLoader) {
          await window.projectFileLoader.loadManifest();
          const allFiles = window.projectFileLoader.getAllFiles();
          
          let filesToShow = [];
          if (category === 'all') {
            filesToShow = [
              ...allFiles.figures.map(f => ({...f, type: 'figure'})),
              ...allFiles.tables.map(t => ({...t, type: 'table'})),
              ...allFiles.markdown.map(m => ({...m, type: 'markdown'})),
              ...allFiles.documents.map(d => ({...d, type: 'document'})),
              ...allFiles.logs.map(l => ({...l, type: 'log'}))
            ];
          } else {
            filesToShow = allFiles[category]?.map(f => ({...f, type: category})) || [];
          }
          
          const isList = body.classList.contains('document-explorer-list');
          
          if (isList) {
            body.innerHTML = filesToShow.map(file => `
              <div class="document-item-list" onclick="openFile('${file.path}', event)">
                <span style="font-size: 1.5rem;">${getFileIcon(file.type)}</span>
                <div style="flex: 1;">
                  <strong>${file.name}</strong>
                  <div style="font-size: 0.875rem; color: var(--text-secondary);">${file.category || 'Other'}</div>
                </div>
              </div>
            `).join('');
          } else {
            body.innerHTML = filesToShow.map(file => `
              <div class="document-item-icon" onclick="openFile('${file.path}', event)">
                <span style="font-size: 2.5rem;">${getFileIcon(file.type)}</span>
                <div style="font-size: 0.875rem; text-align: center; word-break: break-word;">${file.name}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">${file.category || 'Other'}</div>
              </div>
            `).join('');
          }
        } else {
          body.innerHTML = '<p>Project file loader not available. Please refresh the page.</p>';
        }
      } catch (error) {
        body.innerHTML = `<p>Error loading files: ${error.message}</p>`;
      }
    }
    
    function getFileIcon(type) {
      const icons = {
        figure: 'ðŸ–¼ï¸',
        table: 'ðŸ“Š',
        markdown: 'ðŸ“',
        document: 'ðŸ“„',
        log: 'ðŸ“‹'
      };
      return icons[type] || 'ðŸ“';
    }
    
    // Override shared function with page-specific implementation
    window.toggleDocumentExplorer = toggleDocumentExplorer;
    window.toggleDocumentExplorerView = toggleDocumentExplorerView;
    window.filterDocumentsByCategory = filterDocumentsByCategory;
    window.loadProjectFiles = loadProjectFiles;
    
    // File preview modal
    function showFilePreview(filePath, fileName) {
      const modal = document.getElementById('filePreviewModal');
      const modalTitle = document.getElementById('filePreviewTitle');
      const modalContent = document.getElementById('filePreviewContent');
      const modalDownload = document.getElementById('filePreviewDownload');
      const content = document.querySelector('.file-preview-content');
      
      // Reset to normal size when opening new file
      if (content) {
        content.classList.remove('fullscreen');
        modal.classList.remove('fullscreen');
        updateResizeButton(false);
      }
      
      modalTitle.textContent = fileName;
      modalContent.innerHTML = '<p>Loading preview...</p>';
      modal.style.display = 'block';
      
      // Set file name in footer
      const fileNameElement = document.getElementById('filePreviewFileName');
      if (fileNameElement) {
        fileNameElement.textContent = fileName;
      }
      
      // Determine file type
      const ext = filePath.split('.').pop().toLowerCase();
      const isTextFile = ['md', 'txt', 'log', 'csv', 'r', 'rdata'].includes(ext);
      const isDocx = ext === 'docx';
      
      // Set download link
      modalDownload.href = filePath;
      modalDownload.download = fileName;
      modalDownload.style.display = 'inline-block';
      
      if (isTextFile) {
        // Fetch and display text content
        fetch(filePath)
          .then(response => {
            if (!response.ok) {
              // If file not found, try Google Drive
              if (response.status === 404) {
                modalContent.innerHTML = `
                  <div style="padding: 2rem; text-align: center;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                      This file is stored in Google Drive. Click the download button to access it.
                    </p>
                    <a href="${DRIVE_FOLDER_URL}" class="drive-button" target="_blank" style="margin-top: 1rem;">
                      <span>ðŸ“</span>
                      <span>Open Google Drive</span>
                    </a>
                  </div>
                `;
                modalDownload.href = DRIVE_FOLDER_URL;
                modalDownload.textContent = 'Open in Google Drive';
                modalDownload.download = '';
                return;
              }
              throw new Error('File not found');
            }
            return response.text();
          })
          .then(text => {
            if (text) {
              // Format text based on file type
              if (ext === 'md') {
                // Simple markdown rendering (basic)
                const html = text
                  .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                  .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                  .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*(.*?)\*/g, '<em>$1</em>')
                  .replace(/`(.*?)`/g, '<code>$1</code>')
                  .replace(/\n/g, '<br>');
                modalContent.innerHTML = `<div style="max-height: 60vh; overflow-y: auto; padding: 1rem; background: var(--bg-primary); border-radius: 8px; font-family: monospace; font-size: 0.9rem; line-height: 1.6;">${html}</div>`;
              } else if (ext === 'csv') {
                // Show CSV as table
                const lines = text.split('\n').filter(l => l.trim());
                const rows = lines.slice(0, 100).map(line => {
                  const cells = line.split(',').map(cell => `<td>${cell.trim()}</td>`).join('');
                  return `<tr>${cells}</tr>`;
                }).join('');
                modalContent.innerHTML = `
                  <div style="max-height: 60vh; overflow: auto; padding: 1rem;">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                      Showing first 100 rows. Download for full file.
                    </p>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                      ${rows}
                    </table>
                  </div>
                `;
              } else {
                // Plain text with syntax highlighting for code files
                const isCode = ['r', 'rdata'].includes(ext);
                const className = isCode ? 'language-r' : '';
                modalContent.innerHTML = `
                  <pre style="max-height: 60vh; overflow-y: auto; padding: 1rem; background: var(--bg-primary); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(text)}</pre>
                `;
              }
            }
          })
          .catch(error => {
            modalContent.innerHTML = `
              <div style="padding: 2rem; text-align: center;">
                <p style="color: #d32f2f; margin-bottom: 1rem;">âš ï¸ Could not load preview</p>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">${error.message}</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                  This file may be in Google Drive. Click download to access it.
                </p>
                <a href="${DRIVE_FOLDER_URL}" class="drive-button" target="_blank" style="margin-top: 1rem;">
                  <span>ðŸ“</span>
                  <span>Open Google Drive</span>
                </a>
              </div>
            `;
            modalDownload.href = DRIVE_FOLDER_URL;
            modalDownload.textContent = 'Open in Google Drive';
            modalDownload.download = '';
          });
      } else if (isDocx) {
        // DOCX files - try to preview using Google Docs Viewer
        modalContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Loading DOCX preview...</p>';
        
        // First, try to fetch from repo
        fetch(filePath)
          .then(response => {
            if (response.ok) {
              // File is in repo, convert with mammoth.js
              return response.blob();
            } else {
              // File not in repo, it's in Google Drive
              // Use Google Docs Viewer with Google Drive link
              throw new Error('File in Google Drive');
            }
          })
          .then(blob => {
            // File is in repo, convert with mammoth.js
            const reader = new FileReader();
            reader.onload = function(e) {
              const arrayBuffer = e.target.result;
              
              if (typeof mammoth !== 'undefined') {
                mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                  .then(function(result) {
                    // Process HTML to constrain image sizes
                    let html = result.value;
                    // Add style to all images to constrain their size
                    html = html.replace(/<img([^>]*)>/gi, function(match, attrs) {
                      // Check if style already exists
                      if (attrs.includes('style=')) {
                        return match.replace(/style="([^"]*)"/gi, function(styleMatch, styleContent) {
                          return `style="${styleContent}; max-width: 100%; max-height: 60vh; height: auto; display: block; margin: 1rem auto;"`;
                        });
                      } else {
                        return `<img${attrs} style="max-width: 100%; max-height: 60vh; height: auto; display: block; margin: 1rem auto;">`;
                      }
                    });
                    // Also handle figures
                    html = html.replace(/<figure([^>]*)>/gi, '<figure$1 style="max-width: 100%; margin: 1rem auto; text-align: center;">');
                    
                    modalContent.innerHTML = `
                      <div style="max-height: 60vh; overflow-y: auto; padding: 2rem; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: var(--text-primary); max-width: 800px; margin: 0 auto;">
                          ${html}
                        </div>
                        ${result.messages.length > 0 ? '<p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">Note: Some formatting may not be preserved.</p>' : ''}
                      </div>
                    `;
                  })
                  .catch(function(error) {
                    console.error('Mammoth error:', error);
                    showDocxGoogleDriveViewer(modalContent, modalDownload, fileName);
                  });
              } else {
                showDocxGoogleDriveViewer(modalContent, modalDownload, fileName);
              }
            };
            reader.readAsArrayBuffer(blob);
          })
          .catch(error => {
            // File is in Google Drive - use Google Docs Viewer
            showDocxGoogleDriveViewer(modalContent, modalDownload, fileName);
          });
      } else {
        // Other file types
        modalContent.innerHTML = `
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
              Preview unavailable for this file type. Please download the file to view its contents.
            </p>
          </div>
        `;
      }
    }
    
    function showDocxGoogleDriveViewer(modalContent, modalDownload, fileName) {
        // For Google Drive files, we need to construct a viewer URL
        // Since files are in Google Drive, we'll embed the Google Drive viewer
        // The user needs to open the file in Google Drive first to get the file ID
        // For now, show instructions and Google Drive link
        
        modalContent.innerHTML = `
          <div style="padding: 2rem;">
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; text-align: center;">
              This DOCX file is in Google Drive. To preview it:
            </p>
            <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
              <p style="color: var(--text-primary); margin-bottom: 1rem; font-weight: 600;">Option 1: Preview in Google Drive</p>
              <ol style="color: var(--text-secondary); margin-left: 1.5rem; line-height: 1.8;">
                <li>Click "Open in Google Drive" below</li>
                <li>Find and open the file: <strong>${fileName}</strong></li>
                <li>Google Drive will show a preview automatically</li>
              </ol>
            </div>
            <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 8px;">
              <p style="color: var(--text-primary); margin-bottom: 1rem; font-weight: 600;">Option 2: Download and Open</p>
              <p style="color: var(--text-secondary);">
                Use the download button below to download the file, then open it with Microsoft Word, Google Docs, or another DOCX viewer.
              </p>
            </div>
            <div style="text-align: center; margin-top: 1.5rem;">
              <a href="${DRIVE_FOLDER_URL}" class="drive-button" target="_blank">
                <span>ðŸ“</span>
                <span>Open in Google Drive</span>
              </a>
            </div>
          </div>
        `;
        modalDownload.href = DRIVE_FOLDER_URL;
        modalDownload.textContent = 'Open in Google Drive';
        modalDownload.download = '';
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function closeFilePreview() {
      const modal = document.getElementById('filePreviewModal');
      const content = document.querySelector('.file-preview-content');
      if (modal) {
        modal.style.display = 'none';
      }
      // Reset to normal size when closing
      if (content) {
        content.classList.remove('fullscreen');
        if (modal) {
          modal.classList.remove('fullscreen');
        }
        updateResizeButton(false);
      }
    }
    
    // Close file preview on Escape key (only if preview is open)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        const filePreviewModal = document.getElementById('filePreviewModal');
        if (filePreviewModal && filePreviewModal.style.display !== 'none' && filePreviewModal.style.display !== '') {
          closeFilePreview();
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });
    
    function togglePreviewSize() {
      const modal = document.getElementById('filePreviewModal');
      const content = document.querySelector('.file-preview-content');
      const isFullscreen = content.classList.contains('fullscreen');
      
      if (isFullscreen) {
        // Switch to normal size
        content.classList.remove('fullscreen');
        modal.classList.remove('fullscreen');
        updateResizeButton(false);
      } else {
        // Switch to fullscreen
        content.classList.add('fullscreen');
        modal.classList.add('fullscreen');
        updateResizeButton(true);
      }
    }
    
    function updateResizeButton(isFullscreen) {
      const icon = document.getElementById('resizeIcon');
      const text = document.getElementById('resizeText');
      if (icon && text) {
        if (isFullscreen) {
          icon.textContent = 'â›¶';
          text.textContent = 'Normal';
        } else {
          icon.textContent = 'â›¶';
          text.textContent = 'Fullscreen';
        }
      }
    }
    
    // About Modal Functions
    function openAboutModal() {
      const modal = document.getElementById('aboutModal');
      if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.classList.add('show');
        }, 10);
      }
    }
    
    function closeAboutModal() {
      const modal = document.getElementById('aboutModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
    }
    
    // Make globally accessible
    window.openAboutModal = openAboutModal;
    window.closeAboutModal = closeAboutModal;
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      const aboutModal = document.getElementById('aboutModal');
      const filePreviewModal = document.getElementById('filePreviewModal');
      if (event.target === aboutModal) {
        closeAboutModal();
      }
      if (event.target === filePreviewModal) {
        closeFilePreview();
      }
    });
    
    // File opening - show preview instead of direct open
    function openFile(path, event) {
      if (!path) return;
      
      // Normalize path for localhost
      if (path && !path.startsWith('http') && !path.startsWith('//') && typeof getLocalPath === 'function') {
        path = getLocalPath(path);
      }
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      const fileName = path.split('/').pop();
      showFilePreview(path, fileName);
    }
    
    // Script Status - Multiple Scripts
    async function updateScriptStatus() {
      const statusDiv = document.getElementById('script-status-content');
      
      // Define all scripts to monitor with their log files and descriptions
      const scripts = [
        {
          name: 'All Models (Clean Variables)',
          logFile: 'all_models_CLEAN.log',
          scriptFile: '09g_all_models_CLEAN_variables.R',
          description: 'Runs RF, XGBoost, GAM, NN, LightGBM, CatBoost, Ensemble with 26 clean variables'
        },
        {
          name: 'Comprehensive Analysis (All Models)',
          logFile: 'comprehensive_analysis_ALL.log',
          scriptFile: '09_comprehensive_model_comparison_ALL.R',
          description: 'Full model comparison with all 7 models (44 variables)'
        },
        {
          name: 'Comprehensive Analysis',
          logFile: 'comprehensive_analysis.log',
          scriptFile: '09_comprehensive_model_comparison.R',
          description: 'Model comparison analysis'
        },
        {
          name: 'EDS Comprehensive Analysis',
          logFile: 'eds_comprehensive_analysis.log',
          scriptFile: '11_eds_comprehensive_analysis.R',
          description: 'Country-level EDS analysis with regression, ANOVA, regional comparisons'
        },
        {
          name: 'EDS Analysis',
          logFile: 'eds_analysis.log',
          scriptFile: '11_eds_focused_analysis.R',
          description: 'EDS-focused country-level analysis'
        },
        {
          name: 'Future Work Analyses',
          logFile: 'future_work_analyses.log',
          scriptFile: '99_run_future_work_analyses.R',
          description: 'Individual vehicle EDS, temporal, and charging infrastructure analyses'
        }
      ];
      
      let allStatusHTML = '<div style="display: grid; gap: 1.5rem;">';
      
      // Detect if running on localhost
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const logsBasePath = isLocalhost ? '../paper_a_analysis/' : 'logs/';
      
      // Fetch status for each script
      const statusPromises = scripts.map(async (script) => {
        try {
          const logPath = isLocalhost ? `${logsBasePath}${script.logFile}` : `${logsBasePath}${script.logFile}`;
          const response = await fetch(logPath);
          if (!response.ok) {
            return {
              script: script,
              status: 'not_found',
              content: null
            };
          }
          const logText = await response.text();
          const lines = logText.split('\n').filter(l => l.trim());
          const lastLines = lines.slice(-5);
          
          // Determine status
          const hasError = logText.toLowerCase().includes('error') || 
                          logText.toLowerCase().includes('halted') ||
                          logText.toLowerCase().includes('execution halted');
          const isComplete = logText.toLowerCase().includes('complete') || 
                            logText.toLowerCase().includes('finished') ||
                            logText.toLowerCase().includes('saved to:') ||
                            (logText.toLowerCase().includes('ensemble') && !hasError);
          
          let statusType = 'unknown';
          let statusIcon = 'â³';
          let statusColor = 'orange';
          
          if (isComplete && !hasError) {
            statusType = 'complete';
            statusIcon = 'âœ…';
            statusColor = 'green';
          } else if (hasError) {
            statusType = 'error';
            statusIcon = 'âŒ';
            statusColor = 'red';
          } else if (lines.length > 10) {
            statusType = 'running';
            statusIcon = 'â³';
            statusColor = 'blue';
          }
          
          return {
            script: script,
            status: statusType,
            statusIcon: statusIcon,
            statusColor: statusColor,
            lastLines: lastLines,
            logText: logText,
            lineCount: lines.length
          };
        } catch (err) {
          return {
            script: script,
            status: 'error',
            statusIcon: 'âŒ',
            statusColor: 'red',
            error: err.message,
            content: null
          };
        }
      });
      
      const statuses = await Promise.all(statusPromises);
      
      // Render each script's status
      statuses.forEach((statusInfo) => {
        const { script, status, statusIcon, statusColor, lastLines, logText, lineCount, error } = statusInfo;
        
        allStatusHTML += `
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--${statusColor === 'green' ? 'accent' : statusColor === 'red' ? 'error' : 'warning'}); box-shadow: 0 2px 8px var(--shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <h4 style="margin: 0; color: var(--text-primary);">${statusIcon} ${script.name}</h4>
              <span style="font-size: 0.85rem; color: var(--text-secondary);">${lineCount || 0} lines</span>
            </div>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">${script.description}</p>
            <div style="margin-bottom: 0.75rem;">
              <strong style="color: ${statusColor};">Status:</strong> 
              <span style="color: ${statusColor};">${status === 'complete' ? 'Completed' : status === 'error' ? 'Error/Crashed' : status === 'running' ? 'Running/In Progress' : 'Unknown'}</span>
            </div>
        `;
        
        if (error) {
          allStatusHTML += `<p style="color: red; font-size: 0.85rem;">Error loading log: ${error}</p>`;
        } else if (lastLines && lastLines.length > 0) {
          allStatusHTML += `
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; color: var(--accent); font-size: 0.9rem;">Last 5 lines of log</summary>
              <pre style="background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; overflow-x: auto; font-size: 0.75rem; margin-top: 0.5rem; max-height: 150px; overflow-y: auto;">${lastLines.join('\n')}</pre>
            </details>
          `;
        }
        
        // Extract specific information based on script type
        if (logText) {
          if (script.name.includes('All Models')) {
            const modelsCompleted = [];
            if (logText.includes('Random Forest already completed') || logText.includes('Random Forest complete')) modelsCompleted.push('RF');
            if (logText.includes('XGBoost already completed') || logText.includes('XGBoost complete')) modelsCompleted.push('XGBoost');
            if (logText.includes('GAM already completed') || logText.includes('GAM complete')) modelsCompleted.push('GAM');
            if (logText.includes('Neural Network already completed') || logText.includes('Neural Network complete')) modelsCompleted.push('NN');
            if (logText.includes('LightGBM complete')) modelsCompleted.push('LightGBM');
            if (logText.includes('CatBoost complete')) modelsCompleted.push('CatBoost');
            if (logText.includes('Ensemble complete') || logText.includes('All models complete')) modelsCompleted.push('Ensemble');
            if (modelsCompleted.length > 0) {
              allStatusHTML += `<div style="margin-top: 0.5rem; font-size: 0.85rem;"><strong>Models:</strong> ${modelsCompleted.join(', ')}</div>`;
            }
          } else if (script.name.includes('EDS')) {
            const r2Match = logText.match(/RÂ²:\s*([\d.]+)/);
            if (r2Match) {
              allStatusHTML += `<div style="margin-top: 0.5rem; font-size: 0.85rem;"><strong>Best RÂ²:</strong> ${r2Match[1]}</div>`;
            }
            if (logText.includes('Temperature data merged for')) {
              const countriesMatch = logText.match(/Temperature data merged for (\d+) countries/);
              if (countriesMatch) {
                allStatusHTML += `<div style="margin-top: 0.5rem; font-size: 0.85rem;"><strong>Countries analyzed:</strong> ${countriesMatch[1]}</div>`;
              }
            }
          }
        }
        
        allStatusHTML += `</div>`;
      });
      
      allStatusHTML += '</div>';
      statusDiv.innerHTML = allStatusHTML;
      document.getElementById('script-status-explanation').innerHTML = explainScriptStatus();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Timeline will be rendered when JSON loads
      // If JSON fails, show message
      setTimeout(() => {
        if (timelineData.length === 0 && allTimelineData.length === 0) {
          document.getElementById('timeline-content').innerHTML = 
            '<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">Timeline data loading... If this persists, check that TIMELINE_DATA.json exists.</p>';
        }
      }, 1000);
      
      renderFiles('paper-files', fileData.paper);
      renderFiles('script-files', fileData.scripts);
      renderFiles('result-files', fileData.results);
      renderFiles('doc-files', fileData.docs);
      if (fileData.logs) renderFiles('log-files', fileData.logs);
      if (fileData.scripts_all) renderFiles('scripts-all-files', fileData.scripts_all);
      if (fileData.utilities) renderFiles('utilities-files', fileData.utilities);
      renderDocxDropdown();
      updateScriptStatus();
      
      // Initialize timeline on page load
      setTimeout(() => {
        if (typeof window.TimelineSystem !== 'undefined' && !window.timelineSystemInstance) {
          const timelineContainer = document.getElementById('timelineContainer');
          if (timelineContainer) {
            window.timelineSystemInstance = new window.TimelineSystem('timelineContainer');
            window.timelineSystemInstance.init();
          }
        }
      }, 500);
      
      // Update script status every 30 seconds
      setInterval(updateScriptStatus, 30000);
    });
    
    // Explanation of script status
    function explainScriptStatus() {
      const explanation = `
        <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 12px; margin-top: 1rem;">
          <h4>ðŸ“ Script Status Monitoring</h4>
          <p style="margin-top: 0.5rem; color: var(--text-secondary);">
            This section monitors <strong>6 different analysis scripts</strong> and their log files:
          </p>
          <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--text-secondary);">
            <li><strong>All Models (Clean Variables):</strong> Runs RF, XGBoost, GAM, NN, LightGBM, CatBoost, Ensemble with 26 clean variables</li>
            <li><strong>Comprehensive Analysis (All Models):</strong> Full model comparison with all 7 models using 44 variables</li>
            <li><strong>Comprehensive Analysis:</strong> Standard model comparison analysis</li>
            <li><strong>EDS Comprehensive Analysis:</strong> Country-level EDS analysis with regression, ANOVA, regional comparisons</li>
            <li><strong>EDS Analysis:</strong> EDS-focused country-level analysis</li>
            <li><strong>Future Work Analyses:</strong> Individual vehicle EDS, temporal, and charging infrastructure analyses</li>
          </ul>
          <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Status Indicators:</strong>
          </p>
          <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--text-secondary);">
            <li>âœ… <strong>Green:</strong> Script completed successfully</li>
            <li>âŒ <strong>Red:</strong> Script crashed or encountered an error</li>
            <li>â³ <strong>Blue/Orange:</strong> Script is running or status is unknown</li>
          </ul>
          <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Auto-refresh:</strong> Status updates every 30 seconds. Click "Last 5 lines of log" to see recent output from each script.
          </p>
        </div>
      `;
      return explanation;
    }
    
    // Google Drive link configuration (defined at top level for all functions)
    // This is already defined above, keeping for reference
    
    // ============================================
    // FILE EXPLORER SIDEBAR
    // ============================================
    
    let fileTreeData = [];
    let currentFileIndex = -1;
    let currentFolderFiles = [];
    
    // Initialize navigation buttons on load
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (typeof updateNavigationButtons === 'function') {
          updateNavigationButtons();
        }
      }, 100);
    });
    
    // File system structure (based on deployed site structure, adjusted for localhost)
    function getFileSystemStructure() {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const basePath = isLocalhost ? '../paper_a_analysis/' : '';
      
      return {
        name: 'Root',
        type: 'folder',
        children: [
          {
            name: 'docs',
            type: 'folder',
            children: [
              { name: 'PAPER_BUILD_GUIDE.md', type: 'file', path: basePath + 'PAPER_BUILD_GUIDE.md' },
              { name: 'METHODOLOGY_EVOLUTION_DOCUMENTATION.md', type: 'file', path: basePath + 'METHODOLOGY_EVOLUTION_DOCUMENTATION.md' },
              { name: 'VARIABLE_SELECTION_DOCUMENTATION.md', type: 'file', path: basePath + 'VARIABLE_SELECTION_DOCUMENTATION.md' },
              { name: 'TODO_PAPER_COMPLETION.md', type: 'file', path: basePath + 'TODO_PAPER_COMPLETION.md' },
              { name: 'MARKOS_REVIEW_NEEDED.md', type: 'file', path: basePath + 'MARKOS_REVIEW_NEEDED.md' },
              { name: 'DEVELOPMENT_LOG_COMPLETE.md', type: 'file', path: basePath + 'DEVELOPMENT_LOG_COMPLETE.md' },
              { name: 'DEVELOPMENT_LOG_SUMMARY.md', type: 'file', path: basePath + 'DEVELOPMENT_LOG_SUMMARY.md' },
              { name: 'FUTURE_WORK_PROPOSAL.md', type: 'file', path: basePath + 'FUTURE_WORK_PROPOSAL.md' },
              { name: 'ALL_MODELS_COMPLETE_SUMMARY.md', type: 'file', path: basePath + 'ALL_MODELS_COMPLETE_SUMMARY.md' },
              { name: 'COMPLETE_UPDATE_SUMMARY.md', type: 'file', path: basePath + 'COMPLETE_UPDATE_SUMMARY.md' },
              { name: 'PAPER_DRAFT.md', type: 'file', path: basePath + 'PAPER_DRAFT.md' },
              { name: 'PAPER_OUTLINE.md', type: 'file', path: basePath + 'PAPER_OUTLINE.md' },
              { name: 'SUPERVISOR_MEETING_QUESTIONS.md', type: 'file', path: basePath + 'SUPERVISOR_MEETING_QUESTIONS.md' },
              { name: 'SUPERVISOR_MEETING_QUICK_REFERENCE.md', type: 'file', path: basePath + 'SUPERVISOR_MEETING_QUICK_REFERENCE.md' }
            ]
          },
          {
            name: 'logs',
            type: 'folder',
            children: [
              { name: 'all_models_CLEAN.log', type: 'file', path: basePath + 'all_models_CLEAN.log' },
              { name: 'comprehensive_analysis_ALL.log', type: 'file', path: basePath + 'comprehensive_analysis_ALL.log' },
              { name: 'comprehensive_analysis.log', type: 'file', path: basePath + 'comprehensive_analysis.log' },
              { name: 'eds_comprehensive_analysis.log', type: 'file', path: basePath + 'eds_comprehensive_analysis.log' },
              { name: 'eds_analysis.log', type: 'file', path: basePath + 'eds_analysis.log' },
              { name: 'future_work_analyses.log', type: 'file', path: basePath + 'future_work_analyses.log' },
              { name: 'monitor.log', type: 'file', path: basePath + 'monitor.log' }
            ]
          },
          {
            name: 'data_cleaning_docs',
            type: 'folder',
            children: [
              { name: 'README.md', type: 'file', path: basePath + 'data_cleaning_docs/README.md' },
              { name: 'DATA_CLEANING_DOCUMENTATION.md', type: 'file', path: basePath + 'data_cleaning_docs/DATA_CLEANING_DOCUMENTATION.md' },
              { name: 'FLAGGING_STATISTICS_TABLE.md', type: 'file', path: basePath + 'data_cleaning_docs/FLAGGING_STATISTICS_TABLE.md' },
              { name: 'FLAGGING_APPROACH_EXPLANATION.md', type: 'file', path: basePath + 'data_cleaning_docs/FLAGGING_APPROACH_EXPLANATION.md' },
              { name: 'CLEANING_EXECUTION_SUMMARY.md', type: 'file', path: basePath + 'data_cleaning_docs/CLEANING_EXECUTION_SUMMARY.md' },
              { name: 'CLEANING_SCRIPT_README.md', type: 'file', path: basePath + 'data_cleaning_docs/CLEANING_SCRIPT_README.md' },
              { name: 'DATA_CLEANING_DETAILED_LOG.txt', type: 'file', path: basePath + 'data_cleaning_docs/DATA_CLEANING_DETAILED_LOG.txt' }
            ]
          },
          {
            name: 'tables',
            type: 'folder',
            children: [
              { name: 'final_selected_variables_CLEAN.csv', type: 'file', path: basePath + 'tables/final_selected_variables_CLEAN.csv' },
              { name: 'model_comparison_CLEAN_variables.csv', type: 'file', path: basePath + 'tables/model_comparison_CLEAN_variables.csv' },
              { name: 'all_tables.md', type: 'file', path: basePath + 'tables/all_tables.md' }
            ]
          },
          {
            name: 'figures',
            type: 'folder',
            children: [] // Will be populated dynamically or from file list
          },
        {
          name: 'Root Files',
          type: 'folder',
          children: [
            { name: 'index.html', type: 'file', path: 'index.html' },
            { name: 'paper_progression.html', type: 'file', path: 'paper_progression.html' },
            { name: 'figures_portfolio.html', type: 'file', path: 'figures_portfolio.html' },
            { name: 'tables_portfolio.html', type: 'file', path: 'tables_portfolio.html' },
            { name: 'TIMELINE_DATA.json', type: 'file', path: 'TIMELINE_DATA.json' }
          ]
        }
      ]
    };
    
    function toggleFileExplorer() {
      const sidebar = document.getElementById('fileExplorerSidebar');
      const body = document.body;
      if (sidebar) {
        sidebar.classList.toggle('open');
        body.classList.toggle('sidebar-open');
        
        // Load file tree on first open
        if (sidebar.classList.contains('open') && fileTreeData.length === 0) {
          if (typeof buildFileTree === 'function') {
            buildFileTree();
          } else {
            console.warn('buildFileTree function not available yet');
          }
        }
      } else {
        console.error('File explorer sidebar element not found');
      }
    }
    
    // Make globally accessible immediately - override placeholder
    window.toggleFileExplorer = toggleFileExplorer;
    
    function buildFileTree() {
      const treeContainer = document.getElementById('fileTree');
      const fileSystemStructure = getFileSystemStructure();
      fileTreeData = flattenFileTree(fileSystemStructure);
      treeContainer.innerHTML = renderFileTree(fileSystemStructure);
    }
    
    function flattenFileTree(node, path = '', result = []) {
      if (node.type === 'file') {
        result.push({ ...node, fullPath: path + '/' + node.name });
      } else if (node.children) {
        node.children.forEach(child => {
          flattenFileTree(child, path + '/' + node.name, result);
        });
      }
      return result;
    }
    
    function renderFileTree(node, level = 0) {
      if (node.type === 'file') {
        const icon = getFileIcon(node.name);
        const safePath = (node.path || '').replace(/'/g, "\\'");
        const safeName = (node.name || '').replace(/'/g, "\\'");
        return `<li class="file-tree-item file-tree-file" onclick="if(typeof window.openFileFromExplorer === 'function') window.openFileFromExplorer('${safePath}', '${safeName}', event); else openFileFromExplorer('${safePath}', '${safeName}', event);" title="${safeName}">
          <span class="file-tree-icon">${icon}</span>
          <span>${safeName}</span>
        </li>`;
      } else {
        const folderId = 'folder-' + node.name.replace(/\s+/g, '-').toLowerCase();
        const icon = 'ðŸ“';
        let html = `<li class="file-tree-item file-tree-folder" onclick="toggleFolder('${folderId}')">
          <span class="file-tree-caret" id="caret-${folderId}">â–¶</span>
          <span class="file-tree-icon">${icon}</span>
          <span>${node.name}</span>
        </li>`;
        if (node.children && node.children.length > 0) {
          html += `<ul class="file-tree-children" id="${folderId}">`;
          node.children.forEach(child => {
            html += renderFileTree(child, level + 1);
          });
          html += '</ul>';
        }
        return html;
      }
    }
    
    function getFileIcon(fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      const icons = {
        'md': 'ðŸ“',
        'log': 'ðŸ“‹',
        'txt': 'ðŸ“„',
        'csv': 'ðŸ“Š',
        'json': 'ðŸ“‹',
        'html': 'ðŸŒ',
        'docx': 'ðŸ“„',
        'png': 'ðŸ–¼ï¸',
        'jpg': 'ðŸ–¼ï¸',
        'jpeg': 'ðŸ–¼ï¸',
        'pdf': 'ðŸ“•',
        'r': 'ðŸ“Š'
      };
      return icons[ext] || 'ðŸ“„';
    }
    
    function toggleFolder(folderId) {
      const folder = document.getElementById(folderId);
      const caret = document.getElementById('caret-' + folderId);
      if (folder) {
        folder.classList.toggle('open');
        if (caret) {
          caret.classList.toggle('open');
        }
      }
    }
    
    function openFileFromExplorer(filePath, fileName, event) {
      // Find the folder containing this file and set up navigation
      const pathParts = filePath.split('/');
      const folderPath = pathParts.slice(0, -1).join('/');
      
      // Get all files in the same folder
      currentFolderFiles = fileTreeData.filter(f => {
        const fPath = f.fullPath || f.path || '';
        const fFolder = fPath.split('/').slice(0, -1).join('/');
        return fFolder === folderPath && f.type === 'file';
      });
      
      // Find current file index
      currentFileIndex = currentFolderFiles.findIndex(f => {
        const fPath = f.fullPath || f.path || '';
        return fPath === filePath || fPath.endsWith('/' + fileName) || fPath === fileName;
      });
      if (currentFileIndex === -1) currentFileIndex = 0;
      
      // Update navigation buttons
      updateNavigationButtons();
      
      // Open file
      const clickEvent = event || new Event('click');
      openFile(filePath, clickEvent);
      
      // Highlight selected file
      document.querySelectorAll('.file-tree-item').forEach(item => {
        item.classList.remove('selected');
      });
      if (event && event.target) {
        const clickedItem = event.target.closest('.file-tree-item');
        if (clickedItem) clickedItem.classList.add('selected');
      }
    }
    
    function navigateFile(direction) {
      if (!currentFolderFiles || currentFolderFiles.length === 0) {
        if(typeof window.ModalSystem !== 'undefined') {
          window.ModalSystem.info('No File Selected', 'Please open a file to enable navigation features.');
        } else {
        alert('Please open a file first to enable navigation');
        }
        return;
      }
      
      if (direction === 'next') {
        currentFileIndex = (currentFileIndex + 1) % currentFolderFiles.length;
      } else {
        currentFileIndex = (currentFileIndex - 1 + currentFolderFiles.length) % currentFolderFiles.length;
      }
      
      const file = currentFolderFiles[currentFileIndex];
      if (file) {
        openFileFromExplorer(file.path, file.name);
      }
    }
    
    function updateNavigationButtons() {
      const prevBtn = document.getElementById('fileExplorerPrev');
      const nextBtn = document.getElementById('fileExplorerNext');
      if (prevBtn && nextBtn) {
        const hasFiles = currentFolderFiles && currentFolderFiles.length > 1;
        prevBtn.disabled = !hasFiles;
        nextBtn.disabled = !hasFiles;
        if (!hasFiles) {
          prevBtn.title = 'Open a file first to enable navigation';
          nextBtn.title = 'Open a file first to enable navigation';
          prevBtn.textContent = 'â—€ Prev (Not Loaded)';
          nextBtn.textContent = 'Next (Not Loaded) â–¶';
        } else {
          prevBtn.title = 'Previous file';
          nextBtn.title = 'Next file';
          prevBtn.textContent = 'â—€ Prev';
          nextBtn.textContent = 'Next â–¶';
        }
      }
    }
    
    window.updateNavigationButtons = updateNavigationButtons;
    
    function filterFileTree(query) {
      const items = document.querySelectorAll('.file-tree-item');
      const searchTerm = query.toLowerCase();
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
          // Expand parent folders
          let parent = item.parentElement;
          while (parent && parent.classList.contains('file-tree-children')) {
            parent.classList.add('open');
            const folderId = parent.id;
            const caret = document.getElementById('caret-' + folderId);
            if (caret) caret.classList.add('open');
            parent = parent.parentElement;
          }
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // Make file explorer functions globally accessible
    window.toggleFileExplorer = toggleFileExplorer;
    window.toggleFolder = toggleFolder;
    window.openFileFromExplorer = openFileFromExplorer;
    window.navigateFile = navigateFile;
    window.filterFileTree = filterFileTree;
    
    // Make available early
    if (typeof window.toggleFileExplorer === 'undefined') {
      window.toggleFileExplorer = toggleFileExplorer;
      window.toggleFolder = toggleFolder;
      window.openFileFromExplorer = openFileFromExplorer;
      window.navigateFile = navigateFile;
      window.filterFileTree = filterFileTree;
    }
    
    // Keyboard shortcut: Ctrl+B or Cmd+B to toggle file explorer
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        toggleFileExplorer();
      }
    });
    
    // Get context from uploaded training files
    async function getTrainingFilesContext() {
      const trainingData = JSON.parse(localStorage.getItem('aiTrainingData') || '[]');
      if (trainingData.length === 0) return '';
      
      // Get most relevant training files (semantic search if embeddings available)
      const relevantFiles = trainingData.slice(0, 5).map(item => 
        `From uploaded file "${item.fileName}":\n${item.content.substring(0, 500)}...`
      ).join('\n\n');
      
      return `Additional context from user's uploaded files:\n${relevantFiles}`;
    }
    
    // Make file explorer functions available immediately (before DOMContentLoaded)
    // This ensures they're available when buttons are clicked
    // Define a placeholder that will be replaced by the actual function
    window.toggleFileExplorer = window.toggleFileExplorer || function() {
      console.warn('File explorer functions loading...');
      // Will be replaced by actual function when script loads
    };
    
    // Initialize file tree on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // File tree will be built when sidebar is first opened
      await initializeSearchIndex();
      
      // Initialize embeddings model (lazy load)
      initializeEmbeddingsModel();
      
      // Load use case customizations
      if (localStorage.getItem('useCaseSelected')) {
        const useCase = localStorage.getItem('currentUseCase') || 'research';
        if (window.applyUseCase) {
          applyUseCase(useCase);
        }
      }
      
      // Load carousels
      loadFiguresCarousel();
      loadTablesCarousel();
    });
    
    // Carousel Functions
    function scrollCarousel(carouselId, direction) {
      const track = document.getElementById(carouselId + 'Track');
      if (track) {
        const scrollAmount = 220; // width of item + gap
        track.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
      }
    }
    
    // Make globally accessible
    window.scrollCarousel = scrollCarousel;
    
    function loadFiguresCarousel() {
      const track = document.getElementById('figuresCarouselTrack');
      if (!track) {
        console.warn('figuresCarouselTrack not found');
        return;
      }
      
      // Use PROJECT_FILE_LOADER if available, otherwise use hardcoded list
      let figures = [];
      
      if (window.projectFileLoader && window.projectFileLoader.manifest) {
        // Get figures from manifest
        const manifestFigures = window.projectFileLoader.manifest.figures || [];
        figures = manifestFigures.slice(0, 10).map(fig => {
          // Extract figure number from filename
          const match = fig.name.match(/figure(\d+[a-z]?)/i);
          const number = match ? match[1] : fig.name.replace(/\.(png|jpg|jpeg|svg)$/i, '');
          return {
            number: number,
            file: fig.name,
            path: fig.path,
            caption: fig.caption || `Figure ${number}`
          };
        });
      } else {
        // Fallback to hardcoded list
        figures = [
        { number: 1, file: "figure1_energy_distribution.png", caption: "Distribution of total energy consumption" },
        { number: 2, file: "figure2_eds_distribution.png", caption: "Distribution of Electric Driving Share (EDS)" },
        { number: 3, file: "figure3_energy_vs_eds.png", caption: "Relationship between energy and EDS" },
        { number: 4, file: "figure4_fleet_vs_campaign.png", caption: "Fleet vs campaign comparison" },
          { number: 5, file: "figure5_variable_importance_lmg.png", caption: "Variable importance (LMG)" }
        ];
      }
      
      if (figures.length === 0) {
        track.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary); width: 100%;">No figures found. Loading from project files...</div>';
        // Try to load manifest if not loaded
        if (window.projectFileLoader && !window.projectFileLoader.manifest) {
          window.projectFileLoader.loadManifest().then(() => {
            loadFiguresCarousel(); // Retry after manifest loads
          });
        }
        return;
      }
      
      const basePath = '../paper_a_analysis/figures/';
      const items = figures.map(fig => {
        const imgPath = fig.path || (basePath + fig.file);
        // Escape quotes in caption for onclick
        const safeCaption = (fig.caption || '').replace(/'/g, "\\'");
        return `
        <div class="carousel-item" onclick="if(typeof window.openModal === 'function') { window.openModal('${imgPath}', 'Figure ${fig.number}: ${safeCaption}'); } else if(typeof openModal === 'function') { openModal('${imgPath}', 'Figure ${fig.number}: ${safeCaption}'); } else { window.open('${imgPath}', '_blank'); }" title="Figure ${fig.number}: ${safeCaption}">
          <img src="${imgPath}" 
               alt="Figure ${fig.number}" 
               style="width: 100%; height: 150px; object-fit: contain; background: var(--bg-primary); border-radius: 8px; display: block;"
               onerror="this.onerror=null; this.style.display='none'; const parent = this.parentElement; if(parent && !parent.querySelector('.error-msg')) { parent.innerHTML='<div class=\\'error-msg\\' style=\\'padding: 2rem; text-align: center; color: var(--text-secondary); background: var(--bg-primary); border-radius: 8px; height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column;\\'><div>Figure ${fig.number}</div><small>Image not found</small></div>'; }">
          <div class="carousel-label">Figure ${fig.number}</div>
        </div>
      `;
      }).join('');
      
      track.innerHTML = items;
      console.log(`Loaded ${figures.length} figures into carousel`, figures);
      
      // Verify items were added
      const itemsAdded = track.querySelectorAll('.carousel-item');
      if (itemsAdded.length === 0) {
        console.error('No carousel items were added to track');
                } else {
        console.log(`Successfully added ${itemsAdded.length} carousel items`);
      }
    }
    
    function loadTablesCarousel() {
      const track = document.getElementById('tablesCarouselTrack');
      if (!track) {
        console.warn('tablesCarouselTrack not found');
        return;
      }
      
      // Use PROJECT_FILE_LOADER if available, otherwise use hardcoded list
      let tables = [];
      
      if (window.projectFileLoader && window.projectFileLoader.manifest) {
        // Get tables from manifest
        const manifestTables = window.projectFileLoader.manifest.tables || [];
        tables = manifestTables.slice(0, 10).map(tbl => {
          // Extract table number from filename
          const match = tbl.name.match(/table(\d+)/i);
          const number = match ? match[1] : tbl.name.replace(/\.(csv|xlsx)$/i, '');
          return {
            number: number,
            file: tbl.name,
            path: tbl.path,
            caption: tbl.caption || `Table ${number}`
          };
        });
      } else {
        // Fallback to hardcoded list
        tables = [
        { number: 1, file: "table1_dataset_overview.csv", caption: "Dataset overview" },
        { number: 2, file: "table2_summary_statistics.csv", caption: "Summary statistics" },
          { number: 3, file: "table3_variable_importance_lmg.csv", caption: "Variable importance" }
        ];
      }
      
      if (tables.length === 0) {
        track.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No tables found</div>';
        return;
      }
      
      const basePath = '../paper_a_analysis/tables/';
      track.innerHTML = tables.map(tbl => {
        const tablePath = tbl.path || (basePath + tbl.file);
        return `
        <div class="carousel-item" onclick="window.open('${tablePath}', '_blank')" title="Table ${tbl.number}: ${tbl.caption}">
          <div style="width: 100%; height: 150px; background: var(--bg-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 1rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“Š</div>
            <div style="font-weight: 600; color: var(--text-primary);">Table ${tbl.number}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 0.25rem;">${tbl.caption.substring(0, 40)}${tbl.caption.length > 40 ? '...' : ''}</div>
          </div>
          <div class="carousel-label">Table ${tbl.number}</div>
        </div>
      `;
      }).join('');
      
      console.log(`Loaded ${tables.length} tables into carousel`);
    }
    
    // Helper function to get correct path based on environment
    function getLocalPath(relativePath) {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      // If it's a figures or tables path, point to paper_a_analysis
      if (relativePath.startsWith('figures/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      if (relativePath.startsWith('tables/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      if (relativePath.startsWith('docs/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      if (relativePath.startsWith('logs/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      if (relativePath.startsWith('data_cleaning_docs/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      
      // For other files, check if they're MD files in paper_a_analysis
      if (relativePath.endsWith('.md') && !relativePath.includes('/')) {
        return isLocalhost ? `../paper_a_analysis/${relativePath}` : relativePath;
      }
      
      return relativePath;
    }
    
    // Make functions globally available
    window.scrollCarousel = scrollCarousel;
    window.loadFiguresCarousel = loadFiguresCarousel;
    window.loadTablesCarousel = loadTablesCarousel;
    window.getLocalPath = getLocalPath;
    
    // Load carousels on page load - wait for PROJECT_FILE_LOADER
    function initCarousels() {
      console.log('Initializing carousels...');
      const track1 = document.getElementById('figuresCarouselTrack');
      const track2 = document.getElementById('tablesCarouselTrack');
      console.log('Tracks found:', { track1: !!track1, track2: !!track2 });
      
      // Wait for project file loader to be ready
      if (window.projectFileLoader) {
        console.log('ProjectFileLoader found');
        if (window.projectFileLoader.manifest) {
          // Manifest already loaded
          console.log('Manifest already loaded, loading carousels...');
          if (typeof loadFiguresCarousel === 'function') loadFiguresCarousel();
          if (typeof loadTablesCarousel === 'function') loadTablesCarousel();
        } else {
          // Wait for manifest to load
          console.log('Loading manifest...');
          window.projectFileLoader.loadManifest().then(() => {
            console.log('Manifest loaded, loading carousels...');
            if (typeof loadFiguresCarousel === 'function') loadFiguresCarousel();
            if (typeof loadTablesCarousel === 'function') loadTablesCarousel();
          }).catch((err) => {
            console.warn('Manifest load failed, using fallback:', err);
            // If manifest fails, try loading anyway
            if (typeof loadFiguresCarousel === 'function') loadFiguresCarousel();
            if (typeof loadTablesCarousel === 'function') loadTablesCarousel();
          });
        }
      } else {
        // PROJECT_FILE_LOADER not available, try loading anyway
        console.log('ProjectFileLoader not found, using fallback');
        setTimeout(() => {
          if (typeof loadFiguresCarousel === 'function') loadFiguresCarousel();
          if (typeof loadTablesCarousel === 'function') loadTablesCarousel();
        }, 1000);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initCarousels, 500);
      });
    } else {
      setTimeout(initCarousels, 500);
    }
    
    // Also try loading after a longer delay in case scripts load late
    setTimeout(initCarousels, 2000);
    
    // Force load carousels after all scripts are loaded
    window.addEventListener('load', () => {
      setTimeout(() => {
        console.log('Window loaded, attempting to load carousels...');
        if (typeof loadFiguresCarousel === 'function') {
          loadFiguresCarousel();
        } else {
          console.warn('loadFiguresCarousel not available');
        }
        if (typeof loadTablesCarousel === 'function') {
          loadTablesCarousel();
        } else {
          console.warn('loadTablesCarousel not available');
        }
      }, 1000);
    });
    
    // ============================================
    // SEMANTIC SEARCH WITH EMBEDDINGS (Transformers.js)
    // ============================================
    
    async function initializeEmbeddingsModel() {
      try {
        // Use a lightweight model that works in browser
        const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
        embeddingModel = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
          quantized: true // Use quantized model for faster loading
        });
        console.log('Embeddings model loaded');
        
        // Generate embeddings for existing search index (in background)
        generateEmbeddingsForIndex();
      } catch (error) {
        console.warn('Could not load embeddings model:', error);
        console.log('Falling back to TF-IDF search');
      }
    }
    
    // Generate embeddings for search index
    async function generateEmbeddingsForIndex() {
      if (!embeddingModel) return;
      
      console.log('Generating embeddings for search index...');
      const batchSize = 10;
      
      for (let i = 0; i < searchIndex.length; i += batchSize) {
        const batch = searchIndex.slice(i, i + batchSize);
        
        try {
          const embeddings = await Promise.all(
            batch.map(async (item) => {
              if (embeddingsCache.has(item.filePath + '_' + item.chunkIndex)) {
                return embeddingsCache.get(item.filePath + '_' + item.chunkIndex);
              }
              
              const embedding = await embeddingModel(item.content, {
                pooling: 'mean',
                normalize: true
              });
              
              const embeddingArray = Array.from(embedding.data);
              embeddingsCache.set(item.filePath + '_' + item.chunkIndex, embeddingArray);
              item.embedding = embeddingArray;
              
              // Store in IndexedDB
              if (db) {
                const transaction = db.transaction(['searchIndex'], 'readwrite');
                const store = transaction.objectStore('searchIndex');
                await store.put({
                  id: item.filePath + '_' + item.chunkIndex,
                  ...item,
                  embedding: embeddingArray
                });
              }
              
              return embeddingArray;
            })
          );
          
          // Small delay to avoid blocking
          if (i + batchSize < searchIndex.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        } catch (error) {
          console.error('Error generating embeddings for batch:', error);
        }
      }
      
      console.log('Embeddings generation complete');
    }
    
    // Semantic search using cosine similarity
    async function semanticSearch(query, topK = 5) {
      if (!embeddingModel) {
        throw new Error('Embeddings model not loaded');
      }
      
      // Generate query embedding
      const queryEmbedding = await embeddingModel(query, {
        pooling: 'mean',
        normalize: true
      });
      const queryVector = Array.from(queryEmbedding.data);
      
      // Calculate cosine similarity with all indexed documents
      const similarities = [];
      
      for (const item of searchIndex) {
        let itemEmbedding = item.embedding;
        
        // Load from cache if available
        if (!itemEmbedding) {
          const cacheKey = item.filePath + '_' + item.chunkIndex;
          itemEmbedding = embeddingsCache.get(cacheKey);
        }
        
        // Generate embedding if not cached
        if (!itemEmbedding) {
          try {
            const embedding = await embeddingModel(item.content, {
              pooling: 'mean',
              normalize: true
            });
            itemEmbedding = Array.from(embedding.data);
            embeddingsCache.set(item.filePath + '_' + item.chunkIndex, itemEmbedding);
            item.embedding = itemEmbedding;
          } catch (error) {
            console.error('Error generating embedding:', error);
            continue;
          }
        }
        
        // Calculate cosine similarity
        const similarity = cosineSimilarity(queryVector, itemEmbedding);
        
        if (similarity > 0.3) { // Threshold for relevance
          similarities.push({
            ...item,
            score: similarity,
            semanticScore: similarity
          });
        }
      }
      
      // Sort by similarity and return top K
      similarities.sort((a, b) => b.score - a.score);
      return similarities.slice(0, topK);
    }
    
    // Calculate cosine similarity between two vectors
    function cosineSimilarity(vecA, vecB) {
      if (vecA.length !== vecB.length) {
        return 0;
      }
      
      let dotProduct = 0;
      let normA = 0;
      let normB = 0;
      
      for (let i = 0; i < vecA.length; i++) {
        dotProduct += vecA[i] * vecB[i];
        normA += vecA[i] * vecA[i];
        normB += vecB[i] * vecB[i];
      }
      
      const denominator = Math.sqrt(normA) * Math.sqrt(normB);
      if (denominator === 0) return 0;
      
      return dotProduct / denominator;
    }
    
    // Hybrid search: Combine semantic and TF-IDF scores
    async function hybridSearch(query, topK = 5) {
      const queryWords = extractKeywords(query);
      
      // Get semantic results
      let semanticResults = [];
      try {
        if (embeddingModel) {
          semanticResults = await semanticSearch(query, topK * 2);
        }
      } catch (error) {
        console.log('Semantic search failed, using TF-IDF only');
      }
      
      // Get TF-IDF results
      const tfidfResults = searchIndex.map(item => {
        const score = calculateTFIDFScore(queryWords, item, searchIndex);
        return { ...item, score, tfidfScore: score };
      }).filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, topK * 2);
      
      // Combine results
      const combinedResults = new Map();
      
      // Add semantic results with weight
      semanticResults.forEach(result => {
        const key = result.filePath + '_' + result.chunkIndex;
        combinedResults.set(key, {
          ...result,
          combinedScore: (result.semanticScore || 0) * 0.6 // 60% weight for semantic
        });
      });
      
      // Add TF-IDF results with weight
      tfidfResults.forEach(result => {
        const key = result.filePath + '_' + result.chunkIndex;
        const existing = combinedResults.get(key);
        if (existing) {
          existing.combinedScore += (result.tfidfScore || 0) * 0.4; // 40% weight for TF-IDF
        } else {
          combinedResults.set(key, {
            ...result,
            combinedScore: (result.tfidfScore || 0) * 0.4
          });
        }
      });
      
      // Sort by combined score and return top K
      return Array.from(combinedResults.values())
        .sort((a, b) => b.combinedScore - a.combinedScore)
        .slice(0, topK);
    }
    
    // ============================================
    // UNIVERSAL SEARCH SYSTEM
    // ============================================
    
    let searchIndex = [];
    let searchDebounceTimer = null;
    let embeddingModel = null;
    let embeddingsCache = new Map(); // Cache for embeddings
    let documentFrequencies = new Map(); // For TF-IDF
    let totalDocuments = 0;
    
    // Initialize search index from file system
    async function initializeSearchIndex() {
      // Build search index from file system structure
      searchIndex = [];
      await indexFiles(fileSystemStructure);
    }
    
    async function indexFiles(node, path = '') {
      if (node.type === 'file') {
        try {
          // Fetch file content
          const response = await fetch(node.path);
          if (response.ok) {
            const content = await response.text();
            // Improved chunking: 1000 char chunks with 200 char overlap
            const chunks = chunkText(content, 1000, 200);
            chunks.forEach((chunk, index) => {
              const chunkData = {
                filePath: node.path,
                fileName: node.name,
                chunkIndex: index,
                content: chunk,
                fileType: node.name.split('.').pop().toLowerCase(),
                wordCount: chunk.split(/\s+/).length,
                embedding: null, // Will be populated when embeddings are generated
                tfidfScores: null // Will be populated for TF-IDF
              };
              searchIndex.push(chunkData);
              
              // Calculate document frequencies for TF-IDF
              const words = extractWords(chunk);
              words.forEach(word => {
                documentFrequencies.set(word, (documentFrequencies.get(word) || 0) + 1);
              });
            });
            totalDocuments++;
          }
        } catch (e) {
          // File not accessible, skip
          console.log('Could not index file:', node.path);
        }
      } else if (node.children) {
        node.children.forEach(child => {
          indexFiles(child, path + '/' + node.name);
        });
      }
    }
    
    // ============================================
    // IMPROVED CHUNKING WITH OVERLAP & CONTEXT PRESERVATION
    // ============================================
    
    function chunkText(text, chunkSize = 1000, overlap = 200) {
      // First, try to split by paragraphs (double newlines)
      const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0);
      const chunks = [];
      let currentChunk = [];
      let currentSize = 0;
      
      paragraphs.forEach(para => {
        const paraSize = para.length;
        
        // If adding this paragraph would exceed chunk size
        if (currentSize + paraSize > chunkSize && currentChunk.length > 0) {
          // Save current chunk
          chunks.push(currentChunk.join('\n\n'));
          
          // Start new chunk with overlap
          // Take last N characters from previous chunk for overlap
          const lastChunk = currentChunk.join('\n\n');
          const overlapText = lastChunk.slice(-overlap);
          currentChunk = [overlapText, para];
          currentSize = overlapText.length + paraSize;
        } else {
          // Add paragraph to current chunk
          currentChunk.push(para);
          currentSize += paraSize;
        }
      });
      
      // Add remaining chunk
      if (currentChunk.length > 0) {
        chunks.push(currentChunk.join('\n\n'));
      }
      
      // If no paragraphs found, fall back to sentence-based chunking
      if (chunks.length === 0) {
        const sentences = text.split(/([.!?]+\s+)/);
        currentChunk = [];
        currentSize = 0;
        
        sentences.forEach((sentence, index) => {
          const sentenceSize = sentence.length;
          
          if (currentSize + sentenceSize > chunkSize && currentChunk.length > 0) {
            chunks.push(currentChunk.join(''));
            const lastChunk = currentChunk.join('');
            const overlapText = lastChunk.slice(-overlap);
            currentChunk = [overlapText, sentence];
            currentSize = overlapText.length + sentenceSize;
          } else {
            currentChunk.push(sentence);
            currentSize += sentenceSize;
          }
        });
        
        if (currentChunk.length > 0) {
          chunks.push(currentChunk.join(''));
        }
      }
      
      // Final fallback: character-based with overlap
      if (chunks.length === 0) {
        let start = 0;
        while (start < text.length) {
          const end = Math.min(start + chunkSize, text.length);
          chunks.push(text.substring(start, end));
          start = end - overlap;
        }
      }
      
      return chunks.map(chunk => chunk.trim()).filter(chunk => chunk.length > 0);
    }
    
    function performSearch(query) {
      // Clear previous debounce
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }
      
      // Debounce search (300ms)
      searchDebounceTimer = setTimeout(() => {
        if (query.trim().length === 0) {
          hideSearchResults();
          return;
        }
        
        const results = searchFiles(query.trim());
        displaySearchResults(results, query);
      }, 300);
    }
    
    // Make globally accessible
    window.performSearch = performSearch;
    window.showSearchResults = showSearchResults;
    window.hideSearchResults = hideSearchResults;
    window.openSearchResult = openSearchResult;
    
    function searchFiles(query) {
      if (searchIndex.length === 0) {
        // Fallback to simple file name search
        return searchByFileName(query);
      }
      
      const queryLower = query.toLowerCase();
      const queryWords = queryLower.split(/\s+/).filter(w => w.length > 2);
      
      // Score each chunk using TF-IDF
      const scoredResults = searchIndex.map(item => {
        const score = calculateTFIDFScore(queryWords, item, searchIndex);
        return { ...item, score };
      }).filter(item => item.score > 0);
      
      // Sort by score, group by file
      scoredResults.sort((a, b) => b.score - a.score);
      
      // Group by file, take best chunk per file
      const fileMap = new Map();
      scoredResults.forEach(result => {
        if (!fileMap.has(result.filePath) || fileMap.get(result.filePath).score < result.score) {
          fileMap.set(result.filePath, result);
        }
      });
      
      return Array.from(fileMap.values()).slice(0, 10); // Top 10 results
    }
    
    function searchByFileName(query) {
      const queryLower = query.toLowerCase();
      const results = [];
      
      function searchNode(node) {
        if (node.type === 'file' && node.name.toLowerCase().includes(queryLower)) {
          results.push({
            filePath: node.path,
            fileName: node.name,
            content: '',
            score: 100,
            fileType: node.name.split('.').pop().toLowerCase()
          });
        }
        if (node.children) {
          node.children.forEach(child => searchNode(child));
        }
      }
      
      searchNode(fileSystemStructure);
      return results.slice(0, 10);
    }
    
    function displaySearchResults(results, query) {
      const resultsContainer = document.getElementById('searchResults');
      
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
        resultsContainer.classList.add('show');
        return;
      }
      
      const queryWords = query.toLowerCase().split(/\s+/);
      
      resultsContainer.innerHTML = results.map(result => {
        const snippet = getSnippet(result.content, queryWords, 150);
        const icon = getFileIcon(result.fileName);
        
        return `
          <div class="search-result-item" onclick="openSearchResult('${result.filePath}', '${result.fileName}')">
            <div class="search-result-title">
              <span>${icon}</span>
              <span>${highlightText(result.fileName, queryWords)}</span>
            </div>
            <div class="search-result-path">${result.filePath}</div>
            <div class="search-result-snippet">${snippet}</div>
            <div class="search-result-score">Relevance: ${Math.round(result.score)}%</div>
          </div>
        `;
      }).join('');
      
      resultsContainer.classList.add('show');
    }
    
    function getSnippet(text, queryWords, maxLength) {
      if (!text) return '...';
      
      const textLower = text.toLowerCase();
      let bestIndex = -1;
      let bestScore = 0;
      
      // Find best snippet (most query words)
      for (let i = 0; i < text.length - maxLength; i++) {
        const snippet = text.substring(i, i + maxLength).toLowerCase();
        const score = queryWords.reduce((sum, word) => {
          return sum + (snippet.includes(word) ? 1 : 0);
        }, 0);
        
        if (score > bestScore) {
          bestScore = score;
          bestIndex = i;
        }
      }
      
      if (bestIndex === -1) {
        bestIndex = 0;
      }
      
      let snippet = text.substring(bestIndex, bestIndex + maxLength);
      if (bestIndex > 0) snippet = '...' + snippet;
      if (bestIndex + maxLength < text.length) snippet = snippet + '...';
      
      return highlightText(snippet, queryWords);
    }
    
    function highlightText(text, queryWords) {
      let highlighted = text;
      queryWords.forEach(word => {
        const regex = new RegExp(`(${word})`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="search-result-highlight">$1</span>');
      });
      return highlighted;
    }
    
    function openSearchResult(filePath, fileName) {
      if (typeof openFile === 'function') {
        openFile(filePath, new Event('click'));
      } else if (typeof window.openFile === 'function') {
        window.openFile(filePath, new Event('click'));
      }
      if (typeof hideSearchResults === 'function') {
        hideSearchResults();
      } else if (typeof window.hideSearchResults === 'function') {
        window.hideSearchResults();
      }
      const searchInput = document.getElementById('universalSearchInput');
      if (searchInput) searchInput.blur();
    }
    
    window.openSearchResult = openSearchResult;
    
    function showSearchResults() {
      const results = document.getElementById('searchResults');
      if (results.innerHTML.trim() !== '<div class="search-no-results">Type to search...</div>') {
        results.classList.add('show');
      }
    }
    
    function hideSearchResults() {
      document.getElementById('searchResults').classList.remove('show');
    }
    
    // Search expand/collapse functions
    function toggleSearch() {
      const searchContainer = document.getElementById('universalSearch');
      const searchInput = document.getElementById('universalSearchInput');
      if (searchContainer.classList.contains('expanded')) {
        collapseSearch();
      } else {
        expandSearch();
      }
    }
    
    function expandSearch() {
      const searchContainer = document.getElementById('universalSearch');
      const searchInput = document.getElementById('universalSearchInput');
      if (searchContainer && searchInput) {
        searchContainer.classList.add('expanded');
        setTimeout(() => {
          searchInput.focus();
        }, 100);
      }
    }
    
    function collapseSearch() {
      const searchContainer = document.getElementById('universalSearch');
      const searchInput = document.getElementById('universalSearchInput');
      if (searchContainer && searchInput) {
        searchContainer.classList.remove('expanded');
        searchInput.value = '';
        hideSearchResults();
        searchInput.blur();
      }
    }
    
    // Keyboard shortcut: Ctrl+K or Cmd+K to toggle search
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        toggleSearch();
      }
      // Escape to close search
      if (e.key === 'Escape') {
        const searchContainer = document.getElementById('universalSearch');
        if (searchContainer && searchContainer.classList.contains('expanded')) {
          collapseSearch();
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });
    
    // Make functions globally available
    window.toggleSearch = toggleSearch;
    window.expandSearch = expandSearch;
    window.collapseSearch = collapseSearch;
    
    // Make available early
    if (typeof window.toggleSearch === 'undefined') {
      window.toggleSearch = toggleSearch;
      window.expandSearch = expandSearch;
      window.collapseSearch = collapseSearch;
    }
  </script>
  
  <!-- About Modal -->
  <div id="aboutModal" class="about-modal" onclick="if(event.target === this) closeAboutModal()">
    <div class="about-modal-content" onclick="event.stopPropagation()">
      <div class="about-modal-header">
        <h3>About This Website</h3>
        <span class="about-modal-close" onclick="closeAboutModal()">&times;</span>
      </div>
      <div class="about-modal-body">
        <p><strong>About this research portal:</strong></p>
        <p>This interactive research portal (also referred to as a platform or web application) tracks the complete development progression of Paper A, a research study analyzing real-world energy consumption and electric driving share (EDS) of plug-in hybrid vehicles (PHEVs) across Europe. The portal provides a comprehensive timeline of all development milestones, methodology changes, and analysis iterations from the initial baseline model through to the final ensemble model with 26 clean variables.</p>
        
        <p>Users can explore the evolution of the research through an interactive timeline, monitor script execution status in real-time, access all paper drafts and documentation files, and view detailed dashboards of analysis scripts, results, and figures. The portal serves as both a development log and a navigation hub, connecting researchers to all project resources including R analysis scripts, generated figures and tables, methodology documentation, and paper drafts stored both locally and in Google Drive.</p>
        
        <p>The portal features a <strong>figures portfolio (gallery)</strong> showcasing 34+ visualizations including energy distributions, EDS analysis, model comparisons, and regional comparisons, as well as a <strong>tables portfolio</strong> with 16 comprehensive data tables covering dataset overview, model performance, regional summaries, and statistical analyses. These portfolios provide easy access to all research outputs and visualizations.</p>
        
        <p>The platform features filtering capabilities to view milestones, corrections, or specific analysis types, and provides real-time monitoring of analysis script execution with status indicators and log previews. It also includes interactive file previews for DOCX documents with fullscreen viewing options, making it easy to review paper drafts and documentation directly in the browser.</p>
        
        <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--bg-primary);"><strong>Technical details:</strong></p>
        <p>This portal is built as a static website using <strong>HTML</strong> (structure), <strong>CSS</strong> (styling and responsive design), and <strong>JavaScript</strong> (interactivity, timeline rendering, file previews, and real-time updates). It uses modern web technologies including the Mammoth.js library for DOCX file previews and is deployed via GitHub Pages. The portal is designed to be fast, responsive, and accessible without requiring any backend server or database.</p>
        
        <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--bg-primary);"><strong>Short description:</strong></p>
        <p>This research portal tracks the complete development progression of Paper A, providing an interactive timeline of milestones, real-time script monitoring, and access to all research resources including paper drafts, analysis scripts, figures portfolio (gallery), tables portfolio, and documentation for the PHEV energy consumption and EDS research study. Built with HTML, CSS, and JavaScript as a static web application.</p>
        
        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--bg-primary);">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
          <button onclick="openLegalPage('privacy')" class="btn-modern btn-modern-secondary" style="font-size: 0.875rem; padding: 0.625rem 1rem;">Privacy Policy</button>
          <button onclick="openLegalPage('terms')" class="btn-modern btn-modern-secondary" style="font-size: 0.875rem; padding: 0.625rem 1rem;">Terms of Service</button>
          <button onclick="openLegalPage('cookies')" class="btn-modern btn-modern-secondary" style="font-size: 0.875rem; padding: 0.625rem 1rem;">Cookie Policy</button>
          <button onclick="openLegalPage('faq')" class="btn-modern btn-modern-secondary" style="font-size: 0.875rem; padding: 0.625rem 1rem;">FAQ</button>
          <button onclick="openLegalPage('contact')" class="btn-modern btn-modern-secondary" style="font-size: 0.875rem; padding: 0.625rem 1rem;">Contact Us</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- File Preview Modal -->
  <div id="filePreviewModal" class="file-preview-modal" onclick="if(event.target === this) closeFilePreview()">
    <div class="file-preview-content" onclick="event.stopPropagation()">
      <div class="file-preview-header">
        <h3 id="filePreviewTitle">File Preview</h3>
        <div class="file-preview-header-controls">
          <button class="file-preview-resize" id="filePreviewResize" onclick="togglePreviewSize()" title="Toggle fullscreen">
            <span id="resizeIcon">â›¶</span>
            <span id="resizeText">Fullscreen</span>
          </button>
          <span class="file-preview-close" onclick="closeFilePreview()">&times;</span>
        </div>
      </div>
      <div class="file-preview-body" id="filePreviewContent">
        <p>Loading...</p>
      </div>
      <div class="file-preview-footer">
        <span class="file-name">File: <strong id="filePreviewFileName"></strong></span>
        <a id="filePreviewDownload" href="#" class="file-preview-download" download>
          <span>â¬‡ï¸</span>
          <span>Download</span>
        </a>
      </div>
    </div>
  </div>
  
  <!-- Google Drive Section -->
  <div class="container">
    <div class="dashboard-card drive-section" style="border-left: 4px solid #4285f4;">
      <h3>ðŸ“š Literature Reviews & Database Files</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Supplementary research materials, including literature reviews and database files, are available through cloud storage integration. Access all research materials:
      </p>
      <a href="#" id="drive-link-progression" class="drive-button" target="_blank" rel="noopener noreferrer">
        <span>ðŸ“</span>
        <span>Open Google Drive Folder</span>
        <span>â†’</span>
      </a>
      <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
        <h4 style="font-size: 0.95rem; color: var(--accent); margin-bottom: 0.75rem;">What's in Google Drive:</h4>
        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem;">
          <li><strong>Literature Reviews:</strong> All .txt files from paper reviews (54+ files)</li>
          <li><strong>Database Files:</strong> Large datasets and data archives</li>
          <li><strong>Paper Drafts:</strong> DOCX files and working documents</li>
          <li><strong>Supplementary Materials:</strong> Additional analysis files</li>
        </ul>
      </div>
    </div>
  </div>
  
  <script>
    // Set Google Drive link (use global DRIVE_FOLDER_URL or get from first script block)
    const driveUrl = window.DRIVE_FOLDER_URL || 'https://drive.google.com/drive/folders/1PSRm7LG9QyBRnVgHREzQITe5Bthrniro?usp=sharing';
    if (driveUrl !== 'YOUR_GOOGLE_DRIVE_FOLDER_URL_HERE') {
      const driveLink = document.getElementById('drive-link-progression');
      if (driveLink) {
        driveLink.href = driveUrl;
      }
    } else {
      // Hide section if URL not set
      const driveSection = document.querySelector('.drive-section');
      if (driveSection) {
        driveSection.style.display = 'none';
      }
    }
  </script>
  
  <!-- AI Chatbot Modal -->
  <div id="chatbotModal" class="chatbot-modal" onclick="if(event.target === this) closeChatbot()">
    <div class="chatbot-content" onclick="event.stopPropagation()">
      <div class="chatbot-header">
        <h3>
          <span>ðŸ¤–</span>
          <span>AI Research Assistant</span>
        </h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button class="chatbot-settings-btn" onclick="openChatbotSettings()" title="AI Settings">âš™ï¸</button>
          <button class="chatbot-close" onclick="closeChatbot()" title="Close">Ã—</button>
        </div>
      </div>
      <div class="chatbot-messages" id="chatbotMessages">
        <div class="chatbot-message assistant">
          <div class="chatbot-message-avatar">ðŸ¤–</div>
          <div class="chatbot-message-content">
            <p>Hello! I'm your AI Research Assistant. I can help you with:</p>
            <ul>
              <li>ðŸ“„ Reading and summarizing files</li>
              <li>â“ Answering questions about your research</li>
              <li>âœï¸ Editing and improving documents</li>
              <li>ðŸ“Š Analyzing data and results</li>
              <li>ðŸ’¡ Suggesting methodologies and improvements</li>
            </ul>
            <p>How can I help you today?</p>
          </div>
        </div>
      </div>
      <div class="chatbot-loading" id="chatbotLoading" style="display: none;">
        <div class="chatbot-loading-dot"></div>
        <div class="chatbot-loading-dot"></div>
        <div class="chatbot-loading-dot"></div>
        <span>AI is thinking...</span>
      </div>
      <div class="chatbot-input-area">
        <div class="chatbot-file-upload-area" id="chatbotFileUploadArea" style="display: none; padding: 0.5rem; border-bottom: 1px solid var(--border-color); background: var(--bg-tertiary);">
          <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <span style="font-size: 0.85rem; color: var(--text-secondary);">ðŸ“Ž Attached files:</span>
            <div id="chatbotAttachedFiles" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            <button onclick="clearChatbotFiles()" class="btn-modern btn-modern-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: auto;">Clear All</button>
          </div>
        </div>
        <div class="chatbot-input-wrapper">
          <button class="chatbot-attach-btn" id="chatbotAttachBtn" onclick="toggleChatbotFileUpload()" title="Attach files">ðŸ“Ž</button>
          <textarea 
            id="chatbotInput" 
            class="chatbot-input" 
            placeholder="Ask me anything about your research..."
            rows="1"
            onkeydown="handleChatbotKeydown(event)"
            oninput="autoResizeTextarea(this)"
          ></textarea>
          <button class="chatbot-send btn-modern btn-modern-primary" id="chatbotSend" onclick="const input = document.getElementById('chatbotInput'); const message = input ? input.value.trim() : ''; if(message && typeof window.sendChatbotMessage === 'function') { window.sendChatbotMessage(); } else if(typeof window.sendChatbotMessage === 'function') { window.sendChatbotMessage(''); } else { console.error('sendChatbotMessage not available'); if(typeof window.ModalSystem !== 'undefined') { window.ModalSystem.info('AI Assistant', 'AI assistant is loading, please wait...'); } else { alert('AI assistant is loading, please wait...'); } }">
            <span>Send</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================
    // AI RESEARCH ASSISTANT
    // ============================================
    
    let chatbotMessages = [];
    let aiProvider = 'openai'; // 'openai' or 'groq'
    let aiApiKey = '';
    let aiModel = 'gpt-3.5-turbo';
    let conversationHistory = [];
    
    // AI Provider Configuration
    const aiProviders = {
      openai: {
        apiUrl: 'https://api.openai.com/v1/chat/completions',
        defaultModel: 'gpt-3.5-turbo',
        keyPrefix: 'sk-'
      },
      groq: {
        apiUrl: 'https://api.groq.com/openai/v1/chat/completions',
        defaultModel: 'llama-3.1-8b-instant',
        keyPrefix: 'gsk_'
      }
    };
    
    function openChatbot() {
      const modal = document.getElementById('chatbotModal');
      modal.classList.add('show');
      document.getElementById('chatbotInput').focus();
      
      // Load API key from localStorage
      loadAIConfig();
    }
    
    function closeChatbot() {
      const modal = document.getElementById('chatbotModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
      document.body.style.overflow = '';
    }
    
    // Close chatbot on Escape key (only if chatbot is open)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        const chatbotModal = document.getElementById('chatbotModal');
        if (chatbotModal && chatbotModal.classList.contains('show')) {
          closeChatbot();
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });
    
    function loadAIConfig() {
      aiProvider = localStorage.getItem('aiProvider') || 'openai';
      aiApiKey = localStorage.getItem('aiApiKey') || '';
      aiModel = localStorage.getItem('aiModel') || aiProviders[aiProvider].defaultModel;
      
      // Make available globally
      window.aiProvider = aiProvider;
      window.aiApiKey = aiApiKey;
      window.aiModel = aiModel;
    }
    
    function saveAIConfig() {
      localStorage.setItem('aiProvider', aiProvider);
      if (aiApiKey) {
        localStorage.setItem('aiApiKey', aiApiKey);
      }
      localStorage.setItem('aiModel', aiModel);
      
      // Update global variables
      window.aiProvider = aiProvider;
      window.aiApiKey = aiApiKey;
      window.aiModel = aiModel;
    }
    
    function openChatbotSettings() {
      const provider = prompt('AI Provider (openai/groq):', aiProvider);
      if (provider && (provider === 'openai' || provider === 'groq')) {
        aiProvider = provider;
        aiModel = aiProviders[provider].defaultModel;
        saveAIConfig();
      }
      
      const apiKey = prompt('Enter API Key (leave empty to keep current):');
      if (apiKey !== null && apiKey !== '') {
        if (apiKey.startsWith(aiProviders[aiProvider].keyPrefix)) {
          aiApiKey = apiKey;
          saveAIConfig();
          alert('API key saved!');
        } else {
          alert('Invalid API key format. Should start with: ' + aiProviders[aiProvider].keyPrefix);
        }
      }
    }
    
    // Chatbot file upload state
    let chatbotAttachedFiles = [];
    
    function toggleChatbotFileUpload() {
      const uploadArea = document.getElementById('chatbotFileUploadArea');
      const fileInput = document.getElementById('chatbotFileInput');
      
      if (!fileInput) {
        // Create file input if it doesn't exist
        const input = document.createElement('input');
        input.type = 'file';
        input.id = 'chatbotFileInput';
        input.multiple = true;
        input.style.display = 'none';
        input.accept = '.pdf,.docx,.txt,.md,.csv,.json,.py,.r,.R,.jpg,.jpeg,.png,.gif';
        input.onchange = handleChatbotFileSelect;
        document.body.appendChild(input);
        input.click();
      } else {
        fileInput.click();
      }
    }
    
    function handleChatbotFileSelect(event) {
      const files = Array.from(event.target.files);
      files.forEach(file => {
        if (!chatbotAttachedFiles.find(f => f.name === file.name && f.size === file.size)) {
          chatbotAttachedFiles.push(file);
        }
      });
      updateChatbotFileDisplay();
    }
    
    function updateChatbotFileDisplay() {
      const container = document.getElementById('chatbotAttachedFiles');
      const uploadArea = document.getElementById('chatbotFileUploadArea');
      
      if (chatbotAttachedFiles.length === 0) {
        uploadArea.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      
      uploadArea.style.display = 'block';
      container.innerHTML = chatbotAttachedFiles.map((file, index) => `
        <div style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 0.8rem;">
          <span>${file.name}</span>
          <button onclick="removeChatbotFile(${index})" style="background: none; border: none; color: var(--error); cursor: pointer; font-size: 1rem; padding: 0; margin-left: 0.25rem;">Ã—</button>
        </div>
      `).join('');
    }
    
    function removeChatbotFile(index) {
      chatbotAttachedFiles.splice(index, 1);
      updateChatbotFileDisplay();
    }
    
    function clearChatbotFiles() {
      chatbotAttachedFiles = [];
      updateChatbotFileDisplay();
    }
    
    async function processChatbotFiles() {
      if (chatbotAttachedFiles.length === 0) return '';
      
      let fileContents = [];
      for (const file of chatbotAttachedFiles) {
        try {
          const text = await file.text();
          fileContents.push(`File: ${file.name}\nContent:\n${text.substring(0, 5000)}${text.length > 5000 ? '... (truncated)' : ''}`);
        } catch (error) {
          fileContents.push(`File: ${file.name}\nError: Could not read file (${error.message})`);
        }
      }
      
      return '\n\n--- Uploaded Files ---\n' + fileContents.join('\n\n---\n\n');
    }
    
    function sendChatbotMessage() {
      const input = document.getElementById('chatbotInput');
      const message = input.value.trim();
      if (!message && chatbotAttachedFiles.length === 0) return;
      
      if (!aiApiKey) {
        alert('Please configure your AI API key in settings (âš™ï¸ button)');
        const aiLocation = localStorage.getItem('aiAssistantLocation') || 'chat';
        if (aiLocation === 'settings') {
          openSettings();
          // Switch to AI tab
          setTimeout(() => {
            const aiTab = document.querySelector('[onclick="switchSettingsTab(\'ai\')"]');
            if (aiTab) aiTab.click();
          }, 100);
        } else {
          openChatbotSettings();
        }
        return;
      }
      
      // Add user message
      const messageWithFiles = chatbotAttachedFiles.length > 0 
        ? message + (message ? '\n\n' : '') + `[Attached ${chatbotAttachedFiles.length} file(s): ${chatbotAttachedFiles.map(f => f.name).join(', ')}]`
        : message;
      addChatbotMessage('user', messageWithFiles);
      input.value = '';
      autoResizeTextarea(input);
      
      // Store files to process before clearing
      const filesToProcess = [...chatbotAttachedFiles];
      
      // Show loading
      document.getElementById('chatbotLoading').style.display = 'flex';
      document.getElementById('chatbotSend').disabled = true;
      
      // Process files before clearing
      const processFiles = async () => {
        if (filesToProcess.length === 0) return '';
        let fileContents = [];
        for (const file of filesToProcess) {
          try {
            const text = await file.text();
            fileContents.push(`File: ${file.name}\nContent:\n${text.substring(0, 5000)}${text.length > 5000 ? '... (truncated)' : ''}`);
          } catch (error) {
            fileContents.push(`File: ${file.name}\nError: Could not read file (${error.message})`);
          }
        }
        return '\n\n--- Uploaded Files ---\n' + fileContents.join('\n\n---\n\n');
      };
      
      // Clear attached files after storing
      clearChatbotFiles();
      
      // Process files and get RAG context
      Promise.all([
        getRAGContext(message),
        getTrainingFilesContext(),
        processFiles()
      ]).then(([ragContext, trainingContext, fileContext]) => {
        const fullContext = [ragContext, trainingContext, fileContext].filter(c => c).join('\n\n');
        // Call AI API
        callAIAPI(message, fullContext)
          .then(response => {
            addChatbotMessage('assistant', response);
            document.getElementById('chatbotLoading').style.display = 'none';
            document.getElementById('chatbotSend').disabled = false;
          })
          .catch(error => {
            addChatbotMessage('assistant', 'Error: ' + error.message);
            document.getElementById('chatbotLoading').style.display = 'none';
            document.getElementById('chatbotSend').disabled = false;
          });
      }).catch(error => {
        console.error('RAG context error:', error);
        // Fallback: call AI without context
        processFiles().then(fileContext => {
          const context = fileContext || 'No additional context available.';
          return callAIAPI(message, context);
        }).then(response => {
          addChatbotMessage('assistant', response);
          document.getElementById('chatbotLoading').style.display = 'none';
          document.getElementById('chatbotSend').disabled = false;
        }).catch(err => {
          addChatbotMessage('assistant', 'Error: ' + err.message);
          document.getElementById('chatbotLoading').style.display = 'none';
          document.getElementById('chatbotSend').disabled = false;
        });
      });
    }
    
    function addChatbotMessage(role, content) {
      const messagesContainer = document.getElementById('chatbotMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chatbot-message ${role}`;
      
      const avatar = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
      const formattedContent = formatMessageContent(content);
      
      messageDiv.innerHTML = `
        <div class="chatbot-message-avatar">${avatar}</div>
        <div class="chatbot-message-content">${formattedContent}</div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Store in history
      chatbotMessages.push({ role, content });
      conversationHistory.push({ role, content });
      
      // Keep last 20 messages
      if (conversationHistory.length > 20) {
        conversationHistory = conversationHistory.slice(-20);
      }
    }
    
    function formatMessageContent(content) {
      // Convert markdown to HTML
      let formatted = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/\n/g, '<br>');
      
      return formatted;
    }
    
    // ============================================
    // IMPROVED RAG CONTEXT WITH TF-IDF & SEMANTIC SEARCH
    // ============================================
    
    async function getRAGContext(query) {
      const queryWords = extractKeywords(query);
      
      // Use hybrid search (semantic + TF-IDF) if available
      try {
        if (embeddingModel) {
          const hybridResults = await hybridSearch(query, 5);
          if (hybridResults.length > 0) {
            return formatRAGContext(hybridResults);
          }
        }
      } catch (error) {
        console.log('Hybrid search failed, falling back to TF-IDF:', error);
      }
      
      // Fallback to TF-IDF search
      const relevantChunks = [];
      
      searchIndex.forEach(item => {
        const score = calculateTFIDFScore(queryWords, item, searchIndex);
        if (score > 0) {
          relevantChunks.push({
            file: item.fileName,
            path: item.filePath,
            content: item.content,
            score: score,
            chunkIndex: item.chunkIndex
          });
        }
      });
      
      // Sort by score, take top 5 (improved from 3)
      relevantChunks.sort((a, b) => b.score - a.score);
      return formatRAGContext(relevantChunks.slice(0, 5));
    }
    
    // Format RAG context with better structure
    function formatRAGContext(chunks) {
      if (chunks.length === 0) {
        return 'No additional context available.';
      }
      
      return chunks.map((chunk, index) => {
        const content = chunk.content.length > 800 
          ? chunk.content.substring(0, 800) + '...' 
          : chunk.content;
        return `[Context ${index + 1}] From "${chunk.file}" (${chunk.path}):\n${content}`;
      }).join('\n\n---\n\n');
    }
    
    // Extract keywords (remove stop words)
    function extractKeywords(text) {
      const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'what', 'which', 'who', 'whom', 'whose', 'where', 'when', 'why', 'how']);
      
      return text.toLowerCase()
        .split(/\s+/)
        .filter(word => word.length > 2 && !stopWords.has(word))
        .map(word => word.replace(/[^\w]/g, ''));
    }
    
    // Calculate TF-IDF score
    function calculateTFIDFScore(queryWords, document, allDocuments) {
      if (!document.content || document.content.length === 0) return 0;
      
      const docWords = extractWords(document.content);
      const docWordFreq = new Map();
      docWords.forEach(word => {
        docWordFreq.set(word, (docWordFreq.get(word) || 0) + 1);
      });
      
      let score = 0;
      const docLength = docWords.length;
      
      queryWords.forEach(queryWord => {
        // Term Frequency (TF)
        const tf = (docWordFreq.get(queryWord) || 0) / docLength;
        
        // Inverse Document Frequency (IDF)
        const docFreq = documentFrequencies.get(queryWord) || 1;
        const idf = Math.log((totalDocuments + 1) / (docFreq + 1)) + 1;
        
        // TF-IDF score
        score += tf * idf;
        
        // Bonus for exact phrase match
        if (document.content.toLowerCase().includes(queryWords.join(' '))) {
          score += 0.5;
        }
        
        // Bonus for file name match
        if (document.fileName.toLowerCase().includes(queryWord)) {
          score += 0.3;
        }
      });
      
      return score;
    }
    
    // Extract words from text
    function extractWords(text) {
      return text.toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 2);
    }
    
    async function callAIAPI(userMessage, ragContext) {
      const provider = aiProviders[aiProvider];
      const messages = [];
      
      // System prompt
      const systemPrompt = `You are an AI Research Assistant helping with a PHEV (Plug-in Hybrid Electric Vehicle) research project. 
You can help with:
- Reading and summarizing research documents
- Answering questions about methodology, results, and analysis
- Suggesting improvements to papers and analysis
- Explaining statistical concepts and results
- Helping with writing and editing

Context from research files:
${ragContext || 'No additional context available.'}

Be helpful, accurate, and cite sources when possible.`;

      messages.push({ role: 'system', content: systemPrompt });
      
      // Add conversation history (last 10 messages)
      const recentHistory = conversationHistory.slice(-10);
      recentHistory.forEach(msg => {
        messages.push({ role: msg.role, content: msg.content });
      });
      
      // Add current message
      messages.push({ role: 'user', content: userMessage });
      
      const response = await fetch(provider.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${aiApiKey}`
        },
        body: JSON.stringify({
          model: aiModel,
          messages: messages,
          temperature: 0.7,
          max_tokens: 1000
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'API request failed');
      }
      
      const data = await response.json();
      return data.choices[0].message.content;
    }
    
    function handleChatbotKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        event.stopPropagation();
        const input = document.getElementById('chatbotInput');
        const message = input ? input.value.trim() : '';
        if (message && typeof sendChatbotMessage === 'function') {
          sendChatbotMessage();
        } else if (message && typeof window.sendChatbotMessage === 'function') {
          window.sendChatbotMessage();
        }
      }
    }
    
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }
    
    // Handle AI Assistant button click based on user preference
    function handleAIAssistantClick() {
      const location = localStorage.getItem('aiAssistantLocation') || 'chat';
      if (location === 'settings') {
        openSettings();
        // Switch to AI tab
        setTimeout(() => {
          switchSettingsTab('ai');
        }, 100);
      } else {
        openChatbot();
      }
    }
    
    // Make chatbot functions globally accessible
    window.openChatbot = openChatbot;
    window.closeChatbot = closeChatbot;
    window.sendChatbotMessage = sendChatbotMessage;
    
    // Make available early
    if (typeof window.sendChatbotMessage === 'undefined') {
      window.sendChatbotMessage = sendChatbotMessage;
    }
    
    // Ensure sendChatbotMessage is available for button onclick
    document.addEventListener('DOMContentLoaded', function() {
      const sendBtn = document.getElementById('chatbotSend');
      if (sendBtn) {
        sendBtn.onclick = function() {
          if (typeof window.sendChatbotMessage === 'function') {
            window.sendChatbotMessage();
          } else {
            console.error('sendChatbotMessage not available');
            alert('AI assistant is loading, please wait...');
          }
        };
      }
    });
    window.handleChatbotKeydown = handleChatbotKeydown;
    window.openChatbotSettings = openChatbotSettings;
    window.toggleChatbotFileUpload = toggleChatbotFileUpload;
    window.removeChatbotFile = removeChatbotFile;
    window.clearChatbotFiles = clearChatbotFiles;
    window.handleAIAssistantClick = handleAIAssistantClick;
    window.openChatbot = openChatbot;
    
    // Make available early
    if (typeof window.handleAIAssistantClick === 'undefined') {
      window.handleAIAssistantClick = handleAIAssistantClick;
      window.openChatbot = openChatbot;
    }
    
    // Toggle quick access toolbar
    function toggleQuickAccessToolbar() {
      const toolbar = document.getElementById('quickAccessToolbar');
      if (toolbar) {
        const isVisible = toolbar.style.display !== 'none' && window.getComputedStyle(toolbar).display !== 'none';
        if (isVisible) {
          toolbar.style.display = 'none';
          toolbar.classList.remove('show');
        } else {
          toolbar.style.display = 'flex';
          toolbar.classList.add('show');
        }
      }
    }
    window.toggleQuickAccessToolbar = toggleQuickAccessToolbar;
    
    // Make available early
    if (typeof window.toggleQuickAccessToolbar === 'undefined') {
      window.toggleQuickAccessToolbar = toggleQuickAccessToolbar;
    }
    
    // Keyboard shortcut: Ctrl+J or Cmd+J to open chatbot
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
        e.preventDefault();
        handleAIAssistantClick();
      }
      // Ctrl+, or Cmd+, to open settings
      if ((e.ctrlKey || e.metaKey) && e.key === ',') {
        e.preventDefault();
        openSettings();
      }
    });
    
    // ============================================
    // SETTINGS DASHBOARD
    // ============================================
    
    let currentSettingsTab = 'general';
    
    function openSettings() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.classList.add('show');
        }, 10);
        loadSettings();
        // Load AI config when opening settings
        if (typeof loadAIConfig === 'function') {
          loadAIConfig();
        }
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Make openSettings globally accessible
    window.openSettings = openSettings;
    
    // Make available early
    if (typeof window.openSettings === 'undefined') {
      window.openSettings = openSettings;
    }
    
    function closeSettings() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
      // Restore body scroll
      document.body.style.overflow = '';
    }
    
    // Close settings on Escape key (only if settings is open)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal && settingsModal.style.display !== 'none' && settingsModal.classList.contains('show')) {
          closeSettings();
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });
    
    function switchSettingsTab(tabName) {
      currentSettingsTab = tabName;
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.settings-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelector(`.settings-tab[data-tab="${tabName}"]`).classList.add('active');
      const tabContent = document.getElementById(`settings-${tabName}`);
      if (tabContent) {
        tabContent.classList.add('active');
      }
      
      // Load dynamic content for specific tabs
      if (tabName === 'integrations') {
        renderIntegrationsList();
      } else if (tabName === 'timer') {
        renderTimerMethodsList();
      } else if (tabName === 'shortcuts') {
        if (window.renderShortcutsList) {
          window.renderShortcutsList();
        }
      } else if (tabName === 'ai') {
        // Load AI settings when AI tab is opened
        if (typeof loadAIConfig === 'function') {
          loadAIConfig();
        }
      }
    }
    
    // Make settings functions globally accessible
    window.switchSettingsTab = switchSettingsTab;
    window.closeSettings = closeSettings;
    
    // Render integrations list
    function renderIntegrationsList() {
      const container = document.getElementById('integrationsList');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.keys(INTEGRATION_PROVIDERS).forEach(providerId => {
        const provider = INTEGRATION_PROVIDERS[providerId];
        const isConnected = INTEGRATION_FRAMEWORK.connectedApps.has(providerId);
        const integration = INTEGRATION_FRAMEWORK.connectedApps.get(providerId);
        
        const card = document.createElement('div');
        card.style.cssText = 'background: var(--bg-primary); padding: 1.25rem; border-radius: 12px; border: 2px solid var(--bg-primary); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;';
        card.style.borderColor = isConnected ? 'var(--accent)' : 'var(--bg-primary)';
        
        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
            <div style="font-size: 2rem;">${provider.icon}</div>
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.25rem 0; color: var(--text-primary);">${provider.name}</h4>
              <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${provider.description}</p>
              ${isConnected && integration.lastSync ? `
                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">
                  Last synced: ${new Date(integration.lastSync).toLocaleString()}
                </p>
              ` : ''}
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            ${isConnected ? `
              <button onclick="disconnectApp('${providerId}')" class="btn-modern" style="background: var(--error); color: white; font-size: 0.9rem;">
                Disconnect
              </button>
              <button onclick="syncHealthData('${providerId}')" class="btn-modern btn-modern-primary" style="font-size: 0.9rem;">
                Sync Now
              </button>
            ` : `
              <button onclick="connectToApp('${providerId}')" class="btn-modern btn-modern-primary" style="font-size: 0.9rem;">
                Connect
              </button>
            `}
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Render timer methods list
    function renderTimerMethodsList() {
      const container = document.getElementById('timerMethodsList');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.keys(TIMER_METHODS).forEach(methodId => {
        const method = TIMER_METHODS[methodId];
        const isActive = currentTimerMethod === methodId;
        
        const card = document.createElement('div');
        card.style.cssText = `background: var(--bg-primary); padding: 1.25rem; border-radius: 12px; border: 2px solid ${isActive ? 'var(--accent)' : 'var(--bg-primary)'}; cursor: pointer; transition: all 0.3s;`;
        
        card.onclick = () => {
          initTimer(methodId);
          renderTimerMethodsList();
        };
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ${method.name}
                ${isActive ? '<span style="color: var(--accent); font-size: 0.9rem;">(Active)</span>' : ''}
              </h4>
              <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${method.description}</p>
              ${method.workDuration ? `
                <div style="margin-top: 0.75rem; display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                  <span>Work: ${method.workDuration / 60} min</span>
                  ${method.shortBreak ? `<span>Break: ${method.shortBreak / 60} min</span>` : ''}
                  ${method.longBreak ? `<span>Long Break: ${method.longBreak / 60} min</span>` : ''}
                </div>
              ` : '<p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">Flexible duration - work until natural break</p>'}
            </div>
            ${isActive ? '<div style="color: var(--accent); font-size: 1.5rem;">âœ“</div>' : ''}
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Disconnect app
    async function disconnectApp(providerId) {
      if (confirm(`Disconnect from ${INTEGRATION_PROVIDERS[providerId].name}?`)) {
        INTEGRATION_FRAMEWORK.connectedApps.delete(providerId);
        localStorage.removeItem(`integration_token_${providerId}`);
        
        // Save connected apps
        const apps = Array.from(INTEGRATION_FRAMEWORK.connectedApps.entries());
        localStorage.setItem('connectedApps', JSON.stringify(apps));
        
        renderIntegrationsList();
      }
    }
    
    // Make connectToApp and syncHealthData available globally
    window.connectToApp = connectToApp;
    window.disconnectApp = disconnectApp;
    window.syncHealthData = syncHealthData;
    
    function updateSettingsThemeSelect() {
      const themeEl = document.getElementById('settings-theme');
      if (themeEl && typeof window.getCurrentTheme === 'function') {
        themeEl.value = window.getCurrentTheme();
      }
    }
    
    function loadSettings() {
      // Load from localStorage
      const theme = localStorage.getItem('theme') || (typeof window.getCurrentTheme === 'function' ? window.getCurrentTheme() : 'light');
      const fontSize = localStorage.getItem('fontSize') || 'medium';
      const sidebarOpen = localStorage.getItem('sidebarOpen') === 'true';
      
      // Load AI settings
      const aiProvider = localStorage.getItem('aiProvider') || 'openai';
      const aiModel = localStorage.getItem('aiModel') || 'gpt-3.5-turbo';
      const aiApiKey = localStorage.getItem('aiApiKey') || '';
      const aiAssistantLocation = localStorage.getItem('aiAssistantLocation') || 'chat';
      
      // Update UI
      const themeEl = document.getElementById('settings-theme');
      const fontSizeEl = document.getElementById('settings-fontSize');
      const sidebarOpenEl = document.getElementById('settings-sidebarOpen');
      if (themeEl) {
        themeEl.value = theme;
        // Update on theme change
        themeEl.onchange = function() {
          const current = typeof window.getCurrentTheme === 'function' ? window.getCurrentTheme() : 'light';
          if (current !== this.value && typeof window.toggleTheme === 'function') {
            window.toggleTheme();
          }
        };
      }
      if (fontSizeEl) fontSizeEl.value = fontSize;
      if (sidebarOpenEl) sidebarOpenEl.classList.toggle('active', sidebarOpen);
      
      // Update AI settings UI
      const aiProviderEl = document.getElementById('settings-aiProvider');
      const aiModelEl = document.getElementById('settings-aiModel');
      const aiApiKeyEl = document.getElementById('settings-apiKey');
      const aiLocationEl = document.getElementById('settings-aiAssistantLocation');
      if (aiProviderEl) aiProviderEl.value = aiProvider;
      if (aiModelEl) aiModelEl.value = aiModel;
      if (aiApiKeyEl) aiApiKeyEl.value = aiApiKey;
      if (aiLocationEl) aiLocationEl.value = aiAssistantLocation;
      
      // Update global AI config
      window.aiProvider = aiProvider;
      window.aiModel = aiModel;
      window.aiApiKey = aiApiKey;
      if (typeof loadAIConfig === 'function') {
        loadAIConfig();
      }
    }
    
    function saveSettings() {
      const theme = document.getElementById('settings-theme')?.value || 'light';
      const fontSize = document.getElementById('settings-fontSize')?.value || 'medium';
      const sidebarOpen = document.getElementById('settings-sidebarOpen')?.classList.contains('active') || false;
      
      // Get AI settings
      const aiProvider = document.getElementById('settings-aiProvider')?.value || 'openai';
      const aiModel = document.getElementById('settings-aiModel')?.value || 'gpt-3.5-turbo';
      const aiApiKey = document.getElementById('settings-apiKey')?.value || '';
      const aiAssistantLocation = document.getElementById('settings-aiAssistantLocation')?.value || 'chat';
      
      // Save to localStorage
      localStorage.setItem('theme', theme);
      localStorage.setItem('fontSize', fontSize);
      localStorage.setItem('sidebarOpen', sidebarOpen);
      localStorage.setItem('aiProvider', aiProvider);
      localStorage.setItem('aiModel', aiModel);
      if (aiApiKey) {
        localStorage.setItem('aiApiKey', aiApiKey);
      }
      localStorage.setItem('aiAssistantLocation', aiAssistantLocation);
      
      // Update global AI config
      window.aiProvider = aiProvider;
      window.aiModel = aiModel;
      if (aiApiKey) {
        window.aiApiKey = aiApiKey;
      }
      if (typeof saveAIConfig === 'function') {
        saveAIConfig();
      }
      
      // Apply settings
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
      
      document.body.style.fontSize = fontSize === 'small' ? '0.9rem' : fontSize === 'large' ? '1.1rem' : '1rem';
      
      if (sidebarOpen) {
        const sidebar = document.getElementById('fileExplorerSidebar');
        if (sidebar) {
          sidebar.classList.add('open');
        }
        document.body.classList.add('sidebar-open');
      }
      
      alert('Settings saved!');
    }
    
    function toggleSetting(element) {
      element.classList.toggle('active');
    }
    
    // ============================================
    // TASK MANAGEMENT
    // ============================================
    
    let tasks = [];
    let taskIdCounter = 0;
    
    // Load tasks from localStorage
    function loadTasks() {
      const saved = localStorage.getItem('tasks');
      if (saved) {
        tasks = JSON.parse(saved);
        taskIdCounter = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 0;
      }
      renderTasks();
    }
    
    // Save tasks to localStorage
    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }
    
    // Create task
    function createTask(title, description = '', priority = 'medium', dueDate = null, tags = []) {
      const task = {
        id: taskIdCounter++,
        title,
        description,
        priority,
        dueDate,
        tags,
        status: 'pending',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      tasks.push(task);
      saveTasks();
      renderTasks();
      return task;
    }
    
    // Update task
    function updateTask(taskId, updates) {
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        Object.assign(task, updates);
        task.updatedAt = new Date().toISOString();
        saveTasks();
        renderTasks();
      }
    }
    
    // Delete task
    function deleteTask(taskId) {
      tasks = tasks.filter(t => t.id !== taskId);
      saveTasks();
      renderTasks();
    }
    
    // Toggle task completion
    function toggleTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.status = task.status === 'completed' ? 'pending' : 'completed';
        task.updatedAt = new Date().toISOString();
        saveTasks();
        renderTasks();
      }
    }
    
    // Render tasks (will be integrated into UI)
    function renderTasks() {
      // Tasks will be displayed in a task panel or integrated into the dashboard
      // For now, just save to localStorage
    }
    
    // Initialize tasks on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadTasks();
    });
    
    // ============================================
    // TIME TRACKING
    // ============================================
    
    let timeEntries = [];
    let currentTimer = null;
    let taskTimerStartTime = null;
    
    // Start timer
    function startTaskTimer(taskId, category = 'research') {
      if (currentTimer) {
        stopTaskTimer();
      }
      taskTimerStartTime = Date.now();
      currentTimer = {
        taskId,
        category,
        startTime: taskTimerStartTime
      };
      updateTimerDisplay();
    }
    
    // Stop timer
    function stopTimer() {
      if (currentTimer && taskTimerStartTime) {
        const duration = Date.now() - taskTimerStartTime;
        const entry = {
          id: Date.now(),
          taskId: currentTimer.taskId,
          category: currentTimer.category,
          startTime: new Date(taskTimerStartTime).toISOString(),
          endTime: new Date().toISOString(),
          duration: Math.round(duration / 1000 / 60) // minutes
        };
        timeEntries.push(entry);
        saveTimeEntries();
        currentTimer = null;
        taskTimerStartTime = null;
        updateTimerDisplay();
      }
    }
    
    // Update timer display
    function updateTimerDisplay() {
      // Timer display will be integrated into UI
    }
    
    // Save time entries
    function saveTimeEntries() {
      localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
    }
    
    // Load time entries
    function loadTimeEntries() {
      const saved = localStorage.getItem('timeEntries');
      if (saved) {
        timeEntries = JSON.parse(saved);
      }
    }
    
    // Initialize time tracking
    document.addEventListener('DOMContentLoaded', function() {
      loadTimeEntries();
    });
    
    // ============================================
    // ENHANCED WORK TIMER SYSTEM (Multiple Methods)
    // ============================================
    
    // Timer Methods Configuration
    const TIMER_METHODS = {
      pomodoro: {
        name: 'Pomodoro Technique',
        workDuration: 25 * 60, // 25 minutes
        shortBreak: 5 * 60,   // 5 minutes
        longBreak: 15 * 60,   // 15 minutes
        sessionsUntilLongBreak: 4,
        description: '25-minute focused work sessions with short breaks'
      },
      flowtime: {
        name: 'Flow Time',
        workDuration: null, // Flexible, user-defined
        shortBreak: null,
        longBreak: null,
        sessionsUntilLongBreak: null,
        description: 'Work until natural break point, track flow state'
      },
      timeblocking: {
        name: 'Time Blocking',
        workDuration: 60 * 60, // 1 hour blocks
        shortBreak: 10 * 60,   // 10 minutes
        longBreak: 30 * 60,    // 30 minutes
        sessionsUntilLongBreak: 3,
        description: 'Block time for specific tasks, longer focused periods'
      },
      ultradian: {
        name: 'Ultradian Rhythm',
        workDuration: 90 * 60, // 90 minutes
        shortBreak: 20 * 60,   // 20 minutes
        longBreak: null,
        sessionsUntilLongBreak: null,
        description: '90-minute work cycles aligned with natural body rhythms'
      },
      custom: {
        name: 'Custom Timer',
        workDuration: 30 * 60, // 30 minutes default
        shortBreak: 5 * 60,
        longBreak: 15 * 60,
        sessionsUntilLongBreak: 4,
        description: 'Fully customizable timer settings'
      }
    };
    
    let currentTimerMethod = 'pomodoro';
    let timerState = 'stopped'; // stopped, work, break, longBreak
    let timerTimeLeft = TIMER_METHODS[currentTimerMethod].workDuration;
    let timerInterval = null;
    let timerSessions = 0;
    let timerStartTime = null;
    let timerHistory = [];
    
    // Initialize timer with method
    function initTimer(method = 'pomodoro') {
      currentTimerMethod = method;
      const config = TIMER_METHODS[method];
      
      if (config.workDuration) {
        timerTimeLeft = config.workDuration;
      } else {
        // Flow Time - start with 0, count up
        timerTimeLeft = 0;
      }
      
      timerState = 'stopped';
      timerSessions = 0;
    }
    
    // Start timer
    function startTimer(method = null) {
      if (method) {
        initTimer(method);
      }
      
      if (timerState === 'stopped') {
        timerState = 'work';
        timerStartTime = Date.now();
        
        if (TIMER_METHODS[currentTimerMethod].workDuration === null) {
          // Flow Time - count up
          timerTimeLeft = 0;
        }
      }
      
      timerInterval = setInterval(() => {
        const config = TIMER_METHODS[currentTimerMethod];
        
        if (config.workDuration === null) {
          // Flow Time - increment
          timerTimeLeft++;
        } else {
          // Other methods - decrement
          timerTimeLeft--;
        }
        
        updateTimerDisplay();
        
        // Check if timer completed (only for countdown methods)
        if (config.workDuration !== null && timerTimeLeft <= 0) {
          completeTimerSession();
        }
      }, 1000);
      
      // Track timer start
      trackTimerEvent('start', currentTimerMethod);
    }
    
    // Pause timer
    function pauseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        trackTimerEvent('pause', currentTimerMethod);
      }
    }
    
    // Resume timer
    function resumeTimer() {
      if (timerState !== 'stopped' && !timerInterval) {
        timerInterval = setInterval(() => {
          const config = TIMER_METHODS[currentTimerMethod];
          
          if (config.workDuration === null) {
            timerTimeLeft++;
          } else {
            timerTimeLeft--;
          }
          
          updateTimerDisplay();
          
          if (config.workDuration !== null && timerTimeLeft <= 0) {
            completeTimerSession();
          }
        }, 1000);
        trackTimerEvent('resume', currentTimerMethod);
      }
    }
    
    // Stop timer
    function stopTimer() {
      pauseTimer();
      
      if (timerStartTime) {
        const duration = Date.now() - timerStartTime;
        trackTimerEvent('stop', currentTimerMethod, duration);
        taskTimerStartTime = null;
      }
      
      timerState = 'stopped';
      const config = TIMER_METHODS[currentTimerMethod];
      timerTimeLeft = config.workDuration || 0;
      updateTimerDisplay();
    }
    
    // Reset timer
    function resetTimer() {
      stopTimer();
      timerSessions = 0;
      initTimer(currentTimerMethod);
    }
    
    // Complete timer session
    function completeTimerSession() {
      pauseTimer();
      timerSessions++;
      
      const config = TIMER_METHODS[currentTimerMethod];
      const duration = timerStartTime ? Date.now() - timerStartTime : 0;
      
      // Save session
      timerHistory.push({
        id: Date.now(),
        method: currentTimerMethod,
        type: timerState,
        duration: Math.round(duration / 1000 / 60), // minutes
        timestamp: new Date().toISOString()
      });
      saveTimerHistory();
      
      // Determine next state
      if (timerState === 'work') {
        if (config.sessionsUntilLongBreak && timerSessions % config.sessionsUntilLongBreak === 0) {
          timerState = 'longBreak';
          timerTimeLeft = config.longBreak;
        } else if (config.shortBreak) {
          timerState = 'break';
          timerTimeLeft = config.shortBreak;
        } else {
          // Flow Time - just stop
          stopTimer();
          return;
        }
      } else {
        timerState = 'work';
        timerTimeLeft = config.workDuration || 0;
      }
      
      // Show notification
      if (Notification.permission === 'granted') {
        const message = timerState === 'work' 
          ? `Break complete! Time for ${config.name}` 
          : `${config.name} session complete! Time for a break.`;
        new Notification('Timer Complete!', { body: message });
      }
      
      // Sync with health apps
      syncTimerToHealthApps(timerState, duration);
      
      updateTimerDisplay();
    }
    
    // Update timer display
    function updateTimerDisplay() {
      const minutes = Math.floor(Math.abs(timerTimeLeft) / 60);
      const seconds = Math.abs(timerTimeLeft) % 60;
      const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      // Update UI if timer display element exists
      const timerDisplay = document.getElementById('timerDisplay');
      if (timerDisplay) {
        timerDisplay.textContent = formatted;
        timerDisplay.className = `timer-display timer-${timerState} timer-${currentTimerMethod}`;
      }
      
      // Update timer state display
      const timerStateEl = document.getElementById('timerState');
      if (timerStateEl) {
        const stateText = {
          'stopped': 'Ready',
          'work': 'Working',
          'break': 'Break',
          'longBreak': 'Long Break'
        };
        timerStateEl.textContent = stateText[timerState] || 'Ready';
      }
      
      // Update sessions count
      const timerSessionsEl = document.getElementById('timerSessions');
      if (timerSessionsEl) {
        timerSessionsEl.textContent = `Sessions: ${timerSessions}`;
      }
      
      // Update button states
      const startBtn = document.getElementById('timerStartBtn');
      const pauseBtn = document.getElementById('timerPauseBtn');
      if (startBtn && pauseBtn) {
        if (timerState === 'stopped' || !timerInterval) {
          startBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        } else {
          startBtn.style.display = 'none';
          pauseBtn.style.display = 'block';
        }
      }
    }
    
    // Timer Widget UI
    function toggleTimerWidget() {
      const widget = document.getElementById('timerWidget');
      const toolbar = document.querySelector('.quick-access-toolbar');
      if (widget) {
        const isVisible = widget.style.display !== 'none' && widget.style.display !== '';
        if (isVisible) {
          // Hide widget
          widget.style.animation = 'slideOutDown 0.3s ease-out';
          setTimeout(() => {
            widget.style.display = 'none';
            // Adjust toolbar position back
            if (toolbar) toolbar.style.bottom = '1rem';
          }, 300);
        } else {
          // Show widget
          widget.style.display = 'block';
          updateTimerDisplay();
          // Adjust toolbar position to avoid overlap with timer widget
          if (toolbar) {
            const timerHeight = 400; // Approximate timer widget height
            const timerBottom = 32; // 2rem in pixels
            toolbar.style.bottom = `${timerBottom + timerHeight + 16}px`; // 16px gap
          }
          // Set current method in select
          const select = document.getElementById('timerMethodSelect');
          if (select) {
            select.value = currentTimerMethod;
          }
          // Animate in
          setTimeout(() => {
            widget.style.animation = 'slideInUp 0.3s ease-out';
          }, 10);
        }
      }
    }
    
    function closeTimerWidget() {
      const widget = document.getElementById('timerWidget');
      const toolbar = document.querySelector('.quick-access-toolbar');
      if (widget) {
        widget.style.animation = 'slideOutDown 0.3s ease-out';
        setTimeout(() => {
          widget.style.display = 'none';
          // Adjust toolbar position back
          if (toolbar) toolbar.style.bottom = '1rem';
        }, 300);
      }
    }
    
    
    function openTimerStats() {
      const stats = getTimerStats(null, 7);
      alert(`Timer Statistics (Last 7 Days):\n\nTotal Time: ${stats.totalHours} hours\nSessions: ${stats.sessions}\nAverage Session: ${stats.avgSession} minutes\n\nMethod Breakdown:\n${Object.entries(stats.methodBreakdown).map(([method, minutes]) => `  ${method}: ${Math.round(minutes / 60 * 10) / 10} hours`).join('\n')}`);
    }
    
    // Keyboard shortcut for timer
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 't') {
        e.preventDefault();
        toggleTimerWidget();
      }
      // Close timer widget on Escape (only if timer is open)
      if (e.key === 'Escape' || e.keyCode === 27) {
        const timerWidget = document.getElementById('timerWidget');
        if (timerWidget && timerWidget.style.display !== 'none' && timerWidget.style.display !== '') {
          closeTimerWidget();
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });
    
    // Track timer events
    function trackTimerEvent(event, method, duration = null) {
      const eventData = {
        id: Date.now(),
        event,
        method,
        duration: duration ? Math.round(duration / 1000 / 60) : null,
        timestamp: new Date().toISOString()
      };
      
      // Store in IndexedDB
      if (db) {
        const transaction = db.transaction(['timeEntries'], 'readwrite');
        const store = transaction.objectStore('timeEntries');
        store.add(eventData);
      }
      
      // Also sync to health tracking
      if (event === 'start' || event === 'stop') {
        syncWorkActivityToHealthApps(event, method, duration);
      }
    }
    
    // Save timer history
    function saveTimerHistory() {
      localStorage.setItem('timerHistory', JSON.stringify(timerHistory));
    }
    
    // Load timer history
    function loadTimerHistory() {
      const saved = localStorage.getItem('timerHistory');
      if (saved) {
        timerHistory = JSON.parse(saved);
      }
    }
    
    // Get timer statistics
    function getTimerStats(method = null, days = 7) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      
      const filtered = timerHistory.filter(session => {
        const sessionDate = new Date(session.timestamp);
        return sessionDate >= cutoff && (!method || session.method === method);
      });
      
      const totalMinutes = filtered.reduce((sum, s) => sum + s.duration, 0);
      const sessions = filtered.length;
      const avgSession = sessions > 0 ? Math.round(totalMinutes / sessions) : 0;
      
      return {
        totalMinutes,
        totalHours: Math.round(totalMinutes / 60 * 10) / 10,
        sessions,
        avgSession,
        methodBreakdown: filtered.reduce((acc, s) => {
          acc[s.method] = (acc[s.method] || 0) + s.duration;
          return acc;
        }, {})
      };
    }
    
    // Make timer functions globally accessible
    window.toggleTimerWidget = toggleTimerWidget;
    window.closeTimerWidget = closeTimerWidget;
    window.startTimer = startTimer;
    window.pauseTimer = pauseTimer;
    window.stopTimer = stopTimer;
    window.initTimer = initTimer;
    window.openTimerStats = openTimerStats;
    
    // Initialize timer
    document.addEventListener('DOMContentLoaded', function() {
      loadTimerHistory();
      initTimer('pomodoro');
      
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    });
    
    // ============================================
    // RESEARCH JOURNAL
    // ============================================
    
    let journalEntries = [];
    
    // Create journal entry
    function createJournalEntry(title, content, tags = [], mood = 'neutral') {
      const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        title,
        content,
        tags,
        mood,
        achievements: [],
        challenges: [],
        reflections: ''
      };
      journalEntries.push(entry);
      saveJournalEntries();
      return entry;
    }
    
    // Save journal entries
    function saveJournalEntries() {
      localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
    }
    
    // Load journal entries
    function loadJournalEntries() {
      const saved = localStorage.getItem('journalEntries');
      if (saved) {
        journalEntries = JSON.parse(saved);
      }
    }
    
    // Initialize journal
    document.addEventListener('DOMContentLoaded', function() {
      loadJournalEntries();
    });
    
    // ============================================
    // GOAL TRACKER
    // ============================================
    
    let goals = [];
    
    // Create goal
    function createGoal(title, description, target, unit, deadline, milestones = []) {
      const goal = {
        id: Date.now(),
        title,
        description,
        target,
        current: 0,
        unit,
        deadline,
        milestones,
        status: 'active',
        createdAt: new Date().toISOString()
      };
      goals.push(goal);
      saveGoals();
      return goal;
    }
    
    // Update goal progress
    function updateGoalProgress(goalId, current) {
      const goal = goals.find(g => g.id === goalId);
      if (goal) {
        goal.current = current;
        goal.progress = (current / goal.target) * 100;
        
        // Check milestones
        goal.milestones.forEach(milestone => {
          if (goal.progress >= milestone.percentage && !milestone.completed) {
            milestone.completed = true;
            milestone.completedAt = new Date().toISOString();
          }
        });
        
        // Check if goal is complete
        if (goal.progress >= 100) {
          goal.status = 'completed';
        }
        
        saveGoals();
      }
    }
    
    // Save goals
    function saveGoals() {
      localStorage.setItem('goals', JSON.stringify(goals));
    }
    
    // Load goals
    function loadGoals() {
      const saved = localStorage.getItem('goals');
      if (saved) {
        goals = JSON.parse(saved);
      }
    }
    
    // Initialize goals
    document.addEventListener('DOMContentLoaded', function() {
      loadGoals();
    });
    
    // ============================================
    // HABIT TRACKER
    // ============================================
    
    let habits = [];
    let habitCompletions = [];
    
    // Create habit
    function createHabit(name, description, frequency = 'daily') {
      const habit = {
        id: Date.now(),
        name,
        description,
        frequency,
        streak: 0,
        bestStreak: 0,
        totalCompletions: 0,
        createdAt: new Date().toISOString()
      };
      habits.push(habit);
      saveHabits();
      return habit;
    }
    
    // Complete habit
    function completeHabit(habitId) {
      const habit = habits.find(h => h.id === habitId);
      if (habit) {
        const today = new Date().toDateString();
        const lastCompletion = habitCompletions
          .filter(c => c.habitId === habitId)
          .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        
        // Check if already completed today
        if (lastCompletion && new Date(lastCompletion.date).toDateString() === today) {
          return; // Already completed
        }
        
        // Add completion
        habitCompletions.push({
          id: Date.now(),
          habitId,
          date: new Date().toISOString()
        });
        
        // Update streak
        if (lastCompletion) {
          const lastDate = new Date(lastCompletion.date);
          const todayDate = new Date();
          const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff === 1) {
            habit.streak++;
          } else {
            habit.streak = 1;
          }
        } else {
          habit.streak = 1;
        }
        
        habit.bestStreak = Math.max(habit.bestStreak, habit.streak);
        habit.totalCompletions++;
        
        saveHabits();
        saveHabitCompletions();
      }
    }
    
    // Save habits
    function saveHabits() {
      localStorage.setItem('habits', JSON.stringify(habits));
    }
    
    // Save habit completions
    function saveHabitCompletions() {
      localStorage.setItem('habitCompletions', JSON.stringify(habitCompletions));
    }
    
    // Load habits
    function loadHabits() {
      const saved = localStorage.getItem('habits');
      if (saved) {
        habits = JSON.parse(saved);
      }
      const savedCompletions = localStorage.getItem('habitCompletions');
      if (savedCompletions) {
        habitCompletions = JSON.parse(savedCompletions);
      }
    }
    
    // Initialize habits
    document.addEventListener('DOMContentLoaded', function() {
      loadHabits();
    });
    
    // ============================================
    // PROGRESS VISUALIZATIONS
    // ============================================
    
    // Get progress data
    function getProgressData() {
      const taskCompletion = tasks.length > 0 
        ? (tasks.filter(t => t.status === 'completed').length / tasks.length) * 100 
        : 0;
      
      const goalProgress = goals.length > 0
        ? goals.reduce((sum, g) => sum + (g.progress || 0), 0) / goals.length
        : 0;
      
      const totalTime = timeEntries.reduce((sum, e) => sum + e.duration, 0);
      
      return {
        taskCompletion,
        goalProgress,
        totalTime,
        pomodoroSessions,
        habitsCompleted: habitCompletions.length
      };
    }
    
    // ============================================
    // RESEARCH-SPECIFIC FEATURES
    // ============================================
    
    // RS1: Supervisor Meeting Prep
    function generateMeetingAgenda() {
      const pendingTasks = tasks.filter(t => t.status === 'pending' && t.priority === 'high');
      const agenda = {
        date: new Date().toISOString(),
        introduction: 'Progress update and decision points',
        topics: [],
        actionItems: [],
        questions: []
      };
      
      // Categorize tasks by topic
      const topics = {
        methodology: [],
        results: [],
        writing: [],
        other: []
      };
      
      pendingTasks.forEach(task => {
        const category = task.tags.includes('methodology') ? 'methodology' :
                        task.tags.includes('results') ? 'results' :
                        task.tags.includes('writing') ? 'writing' : 'other';
        topics[category].push(task);
      });
      
      // Generate agenda structure
      Object.keys(topics).forEach(category => {
        if (topics[category].length > 0) {
          agenda.topics.push({
            category: category.charAt(0).toUpperCase() + category.slice(1),
            items: topics[category].map(t => t.title),
            timeEstimate: topics[category].length * 5 // 5 min per item
          });
        }
      });
      
      // Add supervisor questions
      agenda.questions = [
        'Variable selection approach (26 clean variables confirmed)',
        'Policy messaging tone (Utility Factor critique strength)',
        'Target journal selection',
        'Co-authorship decisions'
      ];
      
      return agenda;
    }
    
    // RS2: Paper Submission Tracker
    let submissions = [];
    
    function createSubmission(journal, title, date, version = 1) {
      const submission = {
        id: Date.now(),
        journal,
        title,
        date,
        version,
        status: 'submitted',
        reviewStatus: 'awaiting',
        decision: null,
        notes: '',
        createdAt: new Date().toISOString()
      };
      submissions.push(submission);
      saveSubmissions();
      return submission;
    }
    
    function updateSubmissionStatus(submissionId, status, reviewStatus = null, decision = null) {
      const submission = submissions.find(s => s.id === submissionId);
      if (submission) {
        submission.status = status;
        if (reviewStatus) submission.reviewStatus = reviewStatus;
        if (decision) submission.decision = decision;
        submission.updatedAt = new Date().toISOString();
        saveSubmissions();
      }
    }
    
    function saveSubmissions() {
      localStorage.setItem('submissions', JSON.stringify(submissions));
    }
    
    function loadSubmissions() {
      const saved = localStorage.getItem('submissions');
      if (saved) {
        submissions = JSON.parse(saved);
      }
    }
    
    // RS3: Data Provenance Tracker
    let provenanceGraph = {
      nodes: [],
      edges: []
    };
    
    function addProvenanceNode(id, type, name, path) {
      provenanceGraph.nodes.push({ id, type, name, path, timestamp: new Date().toISOString() });
      saveProvenance();
    }
    
    function addProvenanceEdge(fromId, toId, transformation) {
      provenanceGraph.edges.push({ fromId, toId, transformation, timestamp: new Date().toISOString() });
      saveProvenance();
    }
    
    function saveProvenance() {
      localStorage.setItem('provenanceGraph', JSON.stringify(provenanceGraph));
    }
    
    function loadProvenance() {
      const saved = localStorage.getItem('provenanceGraph');
      if (saved) {
        provenanceGraph = JSON.parse(saved);
      }
    }
    
    // RS4: Reproducibility Checker
    function checkReproducibility() {
      const checks = {
        scriptsComplete: true,
        dataAvailable: true,
        dependenciesAvailable: true,
        environmentValid: true,
        issues: []
      };
      
      // Check if all analysis scripts are present
      const requiredScripts = [
        '01_data_loading.R',
        '02_data_cleaning.R',
        '03_energy_calculations.R',
        '09g_all_models_CLEAN_variables.R'
      ];
      
      // Check data files
      const requiredData = [
        'OBFCM_2021.csv',
        'OBFCM_2022.csv',
        'OBFCM_2023.csv'
      ];
      
      // Generate report
      const report = {
        timestamp: new Date().toISOString(),
        checks,
        recommendations: [
          'Ensure all R packages are documented',
          'Verify data file paths are correct',
          'Check R version compatibility',
          'Document all random seeds'
        ]
      };
      
      return report;
    }
    
    // RS5: Ethics Compliance Tracker
    let complianceRecords = [];
    
    function addComplianceRecord(type, description, expiryDate, document = null) {
      const record = {
        id: Date.now(),
        type, // 'training', 'certification', 'approval'
        description,
        expiryDate,
        document,
        status: 'active',
        createdAt: new Date().toISOString()
      };
      complianceRecords.push(record);
      saveCompliance();
      return record;
    }
    
    function checkComplianceStatus() {
      const now = new Date();
      const expiringSoon = complianceRecords.filter(r => {
        if (!r.expiryDate) return false;
        const expiry = new Date(r.expiryDate);
        const daysUntilExpiry = (expiry - now) / (1000 * 60 * 60 * 24);
        return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
      });
      
      const expired = complianceRecords.filter(r => {
        if (!r.expiryDate) return false;
        return new Date(r.expiryDate) < now;
      });
      
      return {
        active: complianceRecords.filter(r => r.status === 'active').length,
        expiringSoon: expiringSoon.length,
        expired: expired.length,
        alerts: [...expiringSoon.map(r => `${r.description} expires soon`), ...expired.map(r => `${r.description} has expired`)]
      };
    }
    
    function saveCompliance() {
      localStorage.setItem('complianceRecords', JSON.stringify(complianceRecords));
    }
    
    function loadCompliance() {
      const saved = localStorage.getItem('complianceRecords');
      if (saved) {
        complianceRecords = JSON.parse(saved);
      }
    }
    
    // RS6: Grant Application Helper
    let grantApplications = [];
    
    function createGrantApplication(funder, title, deadline) {
      const application = {
        id: Date.now(),
        funder,
        title,
        deadline,
        status: 'draft',
        sections: {
          summary: '',
          objectives: '',
          methodology: '',
          budget: '',
          timeline: ''
        },
        createdAt: new Date().toISOString()
      };
      grantApplications.push(application);
      saveGrantApplications();
      return application;
    }
    
    function saveGrantApplications() {
      localStorage.setItem('grantApplications', JSON.stringify(grantApplications));
    }
    
    function loadGrantApplications() {
      const saved = localStorage.getItem('grantApplications');
      if (saved) {
        grantApplications = JSON.parse(saved);
      }
    }
    
    // RS7: Conference Submission Tracker
    let conferenceSubmissions = [];
    
    function createConferenceSubmission(name, location, abstractDeadline, paperDeadline) {
      const submission = {
        id: Date.now(),
        name,
        location,
        abstractDeadline,
        paperDeadline,
        abstractSubmitted: false,
        paperSubmitted: false,
        status: 'planning',
        abstract: '',
        paper: null,
        createdAt: new Date().toISOString()
      };
      conferenceSubmissions.push(submission);
      saveConferenceSubmissions();
      return submission;
    }
    
    function saveConferenceSubmissions() {
      localStorage.setItem('conferenceSubmissions', JSON.stringify(conferenceSubmissions));
    }
    
    function loadConferenceSubmissions() {
      const saved = localStorage.getItem('conferenceSubmissions');
      if (saved) {
        conferenceSubmissions = JSON.parse(saved);
      }
    }
    
    // RS8: Publication Impact Tracker
    let publications = [];
    let impactMetrics = [];
    
    function addPublication(title, journal, year, doi) {
      const publication = {
        id: Date.now(),
        title,
        journal,
        year,
        doi,
        citations: 0,
        downloads: 0,
        altmetrics: {
          twitter: 0,
          news: 0,
          blogs: 0
        },
        createdAt: new Date().toISOString()
      };
      publications.push(publication);
      savePublications();
      return publication;
    }
    
    async function updateImpactMetrics(publicationId) {
      const publication = publications.find(p => p.id === publicationId);
      if (!publication || !publication.doi) return;
      
      // In a real implementation, this would call APIs like:
      // - Google Scholar API for citations
      // - Altmetric API for altmetrics
      // - Publisher API for downloads
      
      // For now, store placeholder
      impactMetrics.push({
        publicationId,
        timestamp: new Date().toISOString(),
        citations: publication.citations,
        downloads: publication.downloads,
        altmetrics: publication.altmetrics
      });
      
      saveImpactMetrics();
    }
    
    function savePublications() {
      localStorage.setItem('publications', JSON.stringify(publications));
    }
    
    function saveImpactMetrics() {
      localStorage.setItem('impactMetrics', JSON.stringify(impactMetrics));
    }
    
    function loadPublications() {
      const saved = localStorage.getItem('publications');
      if (saved) {
        publications = JSON.parse(saved);
      }
      const savedMetrics = localStorage.getItem('impactMetrics');
      if (savedMetrics) {
        impactMetrics = JSON.parse(savedMetrics);
      }
    }
    
    // Initialize all research features
    document.addEventListener('DOMContentLoaded', function() {
      loadSubmissions();
      loadProvenance();
      loadCompliance();
      loadGrantApplications();
      loadConferenceSubmissions();
      loadPublications();
    });
    
    // ============================================
    // COLLABORATION TOOLS (HP4)
    // ============================================
    
    let comments = [];
    let annotations = [];
    
    // Add comment
    function addComment(filePath, lineNumber, text, author = 'You') {
      const comment = {
        id: Date.now(),
        filePath,
        lineNumber,
        text,
        author,
        timestamp: new Date().toISOString(),
        replies: []
      };
      comments.push(comment);
      saveComments();
      return comment;
    }
    
    // Reply to comment
    function replyToComment(commentId, text, author = 'You') {
      const comment = comments.find(c => c.id === commentId);
      if (comment) {
        comment.replies.push({
          id: Date.now(),
          text,
          author,
          timestamp: new Date().toISOString()
        });
        saveComments();
      }
    }
    
    // Save comments
    function saveComments() {
      localStorage.setItem('comments', JSON.stringify(comments));
    }
    
    // Load comments
    function loadComments() {
      const saved = localStorage.getItem('comments');
      if (saved) {
        comments = JSON.parse(saved);
      }
    }
    
    // Add annotation
    function addAnnotation(filePath, selection, text, author = 'You') {
      const annotation = {
        id: Date.now(),
        filePath,
        selection,
        text,
        author,
        timestamp: new Date().toISOString()
      };
      annotations.push(annotation);
      saveAnnotations();
      return annotation;
    }
    
    // Save annotations
    function saveAnnotations() {
      localStorage.setItem('annotations', JSON.stringify(annotations));
    }
    
    // Load annotations
    function loadAnnotations() {
      const saved = localStorage.getItem('annotations');
      if (saved) {
        annotations = JSON.parse(saved);
      }
    }
    
    // Initialize collaboration
    document.addEventListener('DOMContentLoaded', function() {
      loadComments();
      loadAnnotations();
    });
    
    // ============================================
    // VERSION CONTROL UI (HP7)
    // ============================================
    
    let fileVersions = new Map();
    
    // Save file version
    function saveFileVersion(filePath, content) {
      if (!fileVersions.has(filePath)) {
        fileVersions.set(filePath, []);
      }
      
      const versions = fileVersions.get(filePath);
      const version = {
        id: Date.now(),
        version: versions.length + 1,
        content,
        timestamp: new Date().toISOString(),
        author: 'You',
        changes: versions.length > 0 ? getChanges(versions[versions.length - 1].content, content) : 'Initial version'
      };
      
      versions.push(version);
      
      // Keep last 50 versions
      if (versions.length > 50) {
        versions.shift();
      }
      
      saveVersions();
    }
    
    // Get changes between versions
    function getChanges(oldContent, newContent) {
      // Simple diff - in production, use a proper diff library
      if (oldContent === newContent) return 'No changes';
      const oldLines = oldContent.split('\n').length;
      const newLines = newContent.split('\n').length;
      return `Lines: ${oldLines} â†’ ${newLines}`;
    }
    
    // Get version history
    function getVersionHistory(filePath) {
      return fileVersions.get(filePath) || [];
    }
    
    // Restore version
    function restoreVersion(filePath, versionId) {
      const versions = fileVersions.get(filePath);
      if (versions) {
        const version = versions.find(v => v.id === versionId);
        if (version) {
          return version.content;
        }
      }
      return null;
    }
    
    // Save versions
    function saveVersions() {
      const versionsObj = Object.fromEntries(fileVersions);
      localStorage.setItem('fileVersions', JSON.stringify(versionsObj));
    }
    
    // Load versions
    function loadVersions() {
      const saved = localStorage.getItem('fileVersions');
      if (saved) {
        const versionsObj = JSON.parse(saved);
        fileVersions = new Map(Object.entries(versionsObj));
      }
    }
    
    // Initialize version control
    document.addEventListener('DOMContentLoaded', function() {
      loadVersions();
    });
    
    // ============================================
    // EXPORT SYSTEM (HP5)
    // ============================================
    
    async function exportDocument(format, content, fileName) {
      switch (format) {
        case 'pdf':
          await exportToPDF(content, fileName);
          break;
        case 'latex':
          exportToLaTeX(content, fileName);
          break;
        case 'docx':
          exportToDOCX(content, fileName);
          break;
        case 'html':
          exportToHTML(content, fileName);
          break;
        default:
          alert('Unsupported format');
      }
    }
    
    async function exportToPDF(content, fileName) {
      // Use html2pdf or jsPDF
      alert('PDF export - install html2pdf library for full functionality');
      // In production: use html2pdf.js or jsPDF
    }
    
    function exportToLaTeX(content, fileName) {
      // Convert markdown to LaTeX
      let latex = content
        .replace(/^# (.*$)/gim, '\\section{$1}')
        .replace(/^## (.*$)/gim, '\\subsection{$1}')
        .replace(/^### (.*$)/gim, '\\subsubsection{$1}')
        .replace(/\*\*(.*?)\*\*/g, '\\textbf{$1}')
        .replace(/\*(.*?)\*/g, '\\textit{$1}');
      
      const blob = new Blob([latex], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName.replace(/\.[^/.]+$/, '') + '.tex';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function exportToDOCX(content, fileName) {
      alert('DOCX export - install docx library for full functionality');
      // In production: use docx library
    }
    
    function exportToHTML(content, fileName) {
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${fileName}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
  </style>
</head>
<body>
${content}
</body>
</html>`;
      
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName.replace(/\.[^/.]+$/, '') + '.html';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // ============================================
    // CITATION MANAGER (HP8)
    // ============================================
    
    let references = [];
    
    function addReference(title, authors, year, journal, doi, citationKey) {
      const reference = {
        id: Date.now(),
        title,
        authors,
        year,
        journal,
        doi,
        citationKey: citationKey || generateCitationKey(authors, year),
        createdAt: new Date().toISOString()
      };
      references.push(reference);
      saveReferences();
      return reference;
    }
    
    function generateCitationKey(authors, year) {
      const firstAuthor = authors.split(',')[0].trim().split(' ').pop();
      return `${firstAuthor}${year}`.toLowerCase();
    }
    
    function formatCitation(reference, style = 'apa') {
      // Basic APA format
      if (style === 'apa') {
        return `${reference.authors} (${reference.year}). ${reference.title}. ${reference.journal}.`;
      }
      return `${reference.authors}, ${reference.title}, ${reference.journal}, ${reference.year}`;
    }
    
    function generateBibliography(style = 'apa') {
      return references.map(ref => formatCitation(ref, style)).join('\n\n');
    }
    
    function saveReferences() {
      localStorage.setItem('references', JSON.stringify(references));
    }
    
    function loadReferences() {
      const saved = localStorage.getItem('references');
      if (saved) {
        references = JSON.parse(saved);
      }
    }
    
    // Initialize citation manager
    document.addEventListener('DOMContentLoaded', function() {
      loadReferences();
    });
    
    // ============================================
    // METHODOLOGY TRACKER (HP9)
    // ============================================
    
    let methodologyDecisions = [];
    
    function addMethodologyDecision(step, decision, rationale, alternatives = []) {
      const decisionRecord = {
        id: Date.now(),
        step,
        decision,
        rationale,
        alternatives,
        timestamp: new Date().toISOString()
      };
      methodologyDecisions.push(decisionRecord);
      saveMethodology();
      return decisionRecord;
    }
    
    function saveMethodology() {
      localStorage.setItem('methodologyDecisions', JSON.stringify(methodologyDecisions));
    }
    
    function loadMethodology() {
      const saved = localStorage.getItem('methodologyDecisions');
      if (saved) {
        methodologyDecisions = JSON.parse(saved);
      }
    }
    
    // Initialize methodology tracker
    document.addEventListener('DOMContentLoaded', function() {
      loadMethodology();
    });
    
    // ============================================
    // FIGURE/TABLE EDITOR (HP10)
    // ============================================
    
    let figureCanvas = null;
    let tableEditor = null;
    
    // Open figure editor
    function openFigureEditor(imagePath) {
      const modal = document.createElement('div');
      modal.className = 'file-preview-modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="file-preview-content" style="width: 90%; max-width: 1200px; height: 90vh;">
          <div class="file-preview-header">
            <h3>ðŸ–¼ï¸ Figure Editor</h3>
            <div>
              <button onclick="saveFigure()" class="btn-modern btn-modern-primary" style="margin-right: 0.5rem;">Save</button>
              <span class="file-preview-close" onclick="closeFigureEditor()">Ã—</span>
            </div>
          </div>
          <div class="file-preview-body" style="padding: 1rem;">
            <canvas id="figureCanvas" style="border: 1px solid var(--bg-primary); max-width: 100%;"></canvas>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <button onclick="addTextToFigure()" class="btn-modern btn-modern-secondary">Add Text</button>
              <button onclick="addShapeToFigure()" class="btn-modern btn-modern-secondary">Add Shape</button>
              <button onclick="cropFigure()" class="btn-modern btn-modern-secondary">Crop</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Initialize Fabric.js canvas
      figureCanvas = new fabric.Canvas('figureCanvas', {
        width: 800,
        height: 600
      });
      
      // Load image
      fabric.Image.fromURL(imagePath, function(img) {
        img.scaleToWidth(figureCanvas.width);
        figureCanvas.add(img);
        figureCanvas.renderAll();
      });
      
      window.closeFigureEditor = function() {
        document.body.removeChild(modal);
        if (figureCanvas) {
          figureCanvas.dispose();
          figureCanvas = null;
        }
      };
      
      window.saveFigure = function() {
        if (figureCanvas) {
          const dataURL = figureCanvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = dataURL;
          a.download = 'edited_figure.png';
          a.click();
        }
      };
      
      window.addTextToFigure = function() {
        if (figureCanvas) {
          const text = new fabric.Text('New Text', {
            left: 100,
            top: 100,
            fontSize: 20,
            fill: '#000000'
          });
          figureCanvas.add(text);
          figureCanvas.setActiveObject(text);
        }
      };
      
      window.addShapeToFigure = function() {
        if (figureCanvas) {
          const rect = new fabric.Rect({
            left: 100,
            top: 100,
            width: 100,
            height: 100,
            fill: 'transparent',
            stroke: '#000000',
            strokeWidth: 2
          });
          figureCanvas.add(rect);
          figureCanvas.setActiveObject(rect);
        }
      };
      
      window.cropFigure = function() {
        alert('Crop functionality - select area and crop');
        // In production: implement crop selection
      };
    }
    
    // Open table editor
    function openTableEditor(csvPath) {
      fetch(csvPath)
        .then(response => response.text())
        .then(csvText => {
          // Parse CSV
          const lines = csvText.split('\n').filter(l => l.trim());
          const data = lines.map(line => line.split(','));
          
          const modal = document.createElement('div');
          modal.className = 'file-preview-modal';
          modal.style.display = 'flex';
          modal.innerHTML = `
            <div class="file-preview-content" style="width: 90%; max-width: 1200px; height: 90vh;">
              <div class="file-preview-header">
                <h3>ðŸ“Š Table Editor</h3>
                <div>
                  <button onclick="saveTable()" class="btn-modern btn-modern-primary" style="margin-right: 0.5rem;">Save CSV</button>
                  <span class="file-preview-close" onclick="closeTableEditor()">Ã—</span>
                </div>
              </div>
              <div class="file-preview-body" style="padding: 1rem;">
                <div id="tableEditor" style="width: 100%; height: 70vh;"></div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Initialize Handsontable
          tableEditor = new Handsontable(document.getElementById('tableEditor'), {
            data: data,
            rowHeaders: true,
            colHeaders: true,
            contextMenu: true,
            filters: true,
            dropdownMenu: true,
            licenseKey: 'non-commercial-and-evaluation'
          });
          
          window.closeTableEditor = function() {
            document.body.removeChild(modal);
            if (tableEditor) {
              tableEditor.destroy();
              tableEditor = null;
            }
          };
          
          window.saveTable = function() {
            if (tableEditor) {
              const csv = tableEditor.getPlugin('exportFile').exportAsString('csv');
              const blob = new Blob([csv], { type: 'text/csv' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'edited_table.csv';
              a.click();
              URL.revokeObjectURL(url);
            }
          };
        })
        .catch(error => {
          alert('Error loading table: ' + error.message);
        });
    }
    
    // Integrate with file preview - add edit buttons for figures and tables
    function addEditButtonsToPreview(filePath, fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      const footer = document.querySelector('.file-preview-footer');
      
      if (ext === 'png' || ext === 'jpg' || ext === 'jpeg' || ext === 'svg') {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ Edit Figure';
        editBtn.className = 'file-preview-download';
        editBtn.style.marginRight = '0.5rem';
        editBtn.onclick = () => openFigureEditor(filePath);
        footer.insertBefore(editBtn, footer.firstChild);
      } else if (ext === 'csv') {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ Edit Table';
        editBtn.className = 'file-preview-download';
        editBtn.style.marginRight = '0.5rem';
        editBtn.onclick = () => openTableEditor(filePath);
        footer.insertBefore(editBtn, footer.firstChild);
      }
    }
    
    // Modify showFilePreview to add edit buttons
    const originalShowFilePreview = window.showFilePreview;
    window.showFilePreview = function(filePath, fileName) {
      originalShowFilePreview(filePath, fileName);
      setTimeout(() => addEditButtonsToPreview(filePath, fileName), 100);
    };
    
    // ============================================
    // INDEXEDDB SETUP (Core Infrastructure)
    // ============================================
    
    let db = null;
    const DB_NAME = 'PHEVResearchPortal';
    const DB_VERSION = 1;
    
    // Initialize IndexedDB
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Object stores
          if (!db.objectStoreNames.contains('files')) {
            db.createObjectStore('files', { keyPath: 'path' });
          }
          if (!db.objectStoreNames.contains('searchIndex')) {
            const searchStore = db.createObjectStore('searchIndex', { keyPath: 'id' });
            searchStore.createIndex('filePath', 'filePath', { unique: false });
            searchStore.createIndex('fileType', 'fileType', { unique: false });
            // Index for embeddings (stored as array)
            searchStore.createIndex('hasEmbedding', 'hasEmbedding', { unique: false });
          }
          if (!db.objectStoreNames.contains('tasks')) {
            db.createObjectStore('tasks', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('timeEntries')) {
            const timeStore = db.createObjectStore('timeEntries', { keyPath: 'id' });
            timeStore.createIndex('taskId', 'taskId', { unique: false });
            timeStore.createIndex('date', 'startTime', { unique: false });
          }
          if (!db.objectStoreNames.contains('goals')) {
            db.createObjectStore('goals', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('habits')) {
            db.createObjectStore('habits', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('journalEntries')) {
            const journalStore = db.createObjectStore('journalEntries', { keyPath: 'id' });
            journalStore.createIndex('date', 'date', { unique: false });
          }
          if (!db.objectStoreNames.contains('comments')) {
            const commentStore = db.createObjectStore('comments', { keyPath: 'id' });
            commentStore.createIndex('filePath', 'filePath', { unique: false });
          }
          if (!db.objectStoreNames.contains('annotations')) {
            const annotationStore = db.createObjectStore('annotations', { keyPath: 'id' });
            annotationStore.createIndex('filePath', 'filePath', { unique: false });
          }
          if (!db.objectStoreNames.contains('fileVersions')) {
            const versionStore = db.createObjectStore('fileVersions', { keyPath: 'id' });
            versionStore.createIndex('filePath', 'filePath', { unique: false });
          }
          if (!db.objectStoreNames.contains('references')) {
            db.createObjectStore('references', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('submissions')) {
            db.createObjectStore('submissions', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('conferenceSubmissions')) {
            db.createObjectStore('conferenceSubmissions', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('publications')) {
            db.createObjectStore('publications', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('healthData')) {
            const healthStore = db.createObjectStore('healthData', { keyPath: 'id' });
            healthStore.createIndex('category', 'category', { unique: false });
            healthStore.createIndex('date', 'date', { unique: false });
            healthStore.createIndex('timestamp', 'timestamp', { unique: false });
          }
          if (!db.objectStoreNames.contains('integrations')) {
            db.createObjectStore('integrations', { keyPath: 'providerId' });
          }
          if (!db.objectStoreNames.contains('aiTraining')) {
            const trainingStore = db.createObjectStore('aiTraining', { keyPath: 'id' });
            trainingStore.createIndex('fileName', 'fileName', { unique: false });
            trainingStore.createIndex('fileType', 'fileType', { unique: false });
            trainingStore.createIndex('isGlobalProfile', 'isGlobalProfile', { unique: false });
          }
          if (!db.objectStoreNames.contains('userProfile')) {
            const profileStore = db.createObjectStore('userProfile', { keyPath: 'id' });
            profileStore.createIndex('category', 'category', { unique: false });
          }
        };
      });
    }
    
    // Initialize IndexedDB on page load
    document.addEventListener('DOMContentLoaded', function() {
      initIndexedDB().then(() => {
        console.log('IndexedDB initialized');
        // Migrate data from localStorage to IndexedDB
        migrateToIndexedDB();
      }).catch(err => {
        console.error('IndexedDB initialization failed:', err);
      });
    });
    
    // Migrate localStorage data to IndexedDB
    function migrateToIndexedDB() {
      if (!db) return;
      
      // Migrate tasks
      if (tasks.length > 0) {
        const transaction = db.transaction(['tasks'], 'readwrite');
        const store = transaction.objectStore('tasks');
        tasks.forEach(task => {
          store.put(task);
        });
      }
      
      // Migrate other data similarly
      // (This is a simplified migration - in production, do proper migration)
    }
    
    // ============================================
    // MEDIUM PRIORITY FEATURES
    // ============================================
    
    // MP1: Code Execution Environment (basic structure)
    let codeExecutionHistory = [];
    
    async function executeRCode(code) {
      // In production: integrate WebR or R server
      return new Promise((resolve, reject) => {
        // Placeholder - would use WebR or server-side R execution
        setTimeout(() => {
          resolve({
            output: 'R code execution - install WebR for full functionality',
            plots: [],
            errors: []
          });
        }, 1000);
      });
    }
    
    // MP2: Interactive Data Explorer (basic structure)
    let dataCache = new Map();
    
    async function loadDataFile(filePath) {
      if (dataCache.has(filePath)) {
        return dataCache.get(filePath);
      }
      
      try {
        const response = await fetch(filePath);
        const text = await response.text();
        const data = parseCSV(text);
        dataCache.set(filePath, data);
        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        return null;
      }
    }
    
    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(l => l.trim());
      return lines.map(line => line.split(','));
    }
    
    // MP3: Model Comparison Dashboard (basic structure)
    function loadModelResults() {
      // Load from model comparison CSV
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const csvPath = isLocalhost ? '../paper_a_analysis/tables/model_comparison_CLEAN_variables.csv' : 'tables/model_comparison_CLEAN_variables.csv';
      return fetch(csvPath)
        .then(response => response.text())
        .then(csv => {
          const data = parseCSV(csv);
          return data;
        });
    }
    
    // MP5: Notification System (enhanced)
    let notifications = [];
    
    function addNotification(type, title, message, action = null) {
      const notification = {
        id: Date.now(),
        type,
        title,
        message,
        action,
        read: false,
        timestamp: new Date().toISOString()
      };
      notifications.push(notification);
      saveNotifications();
      showBrowserNotification(title, message);
      return notification;
    }
    
    function showBrowserNotification(title, message) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: message, icon: '/favicon.ico' });
      }
    }
    
    function markNotificationRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        saveNotifications();
      }
    }
    
    function saveNotifications() {
      localStorage.setItem('notifications', JSON.stringify(notifications));
    }
    
    function loadNotifications() {
      const saved = localStorage.getItem('notifications');
      if (saved) {
        notifications = JSON.parse(saved);
      }
    }
    
    // Initialize notifications
    document.addEventListener('DOMContentLoaded', function() {
      loadNotifications();
      
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    });
    
    // ============================================
    // 6X7 ECOSYSTEM INTEGRATION FRAMEWORK
    // ============================================
    
    // Integration Framework for connecting to health, life, and work tracking apps
    const INTEGRATION_FRAMEWORK = {
      version: '1.0.0',
      connectedApps: new Map(),
      healthData: {
        sleep: [],
        exercise: [],
        heartRate: [],
        steps: [],
        calories: [],
        stress: [],
        mood: []
      },
      syncSettings: {
        autoSync: true,
        syncInterval: 5 * 60 * 1000, // 5 minutes
        enabledIntegrations: []
      }
    };
    
    // Integration Providers
    const INTEGRATION_PROVIDERS = {
      lifecycle: {
        name: 'Lifecycle',
        type: 'health',
        apiEndpoint: 'https://api.lifecycle.app/v1',
        authType: 'oauth2',
        scopes: ['sleep', 'activity', 'health'],
        description: 'Norwegian sleep and activity tracking app',
        icon: 'ðŸŒ™'
      },
      sleepcycle: {
        name: 'Sleep Cycle',
        type: 'health',
        apiEndpoint: 'https://api.sleepcycle.com/v1',
        authType: 'oauth2',
        scopes: ['sleep', 'alarm', 'health'],
        description: 'Norwegian sleep tracking and smart alarm app',
        icon: 'ðŸ˜´'
      },
      applehealth: {
        name: 'Apple Health',
        type: 'health',
        apiEndpoint: 'health://',
        authType: 'native',
        scopes: ['all'],
        description: 'Apple HealthKit integration',
        icon: 'ðŸŽ'
      },
      googlefit: {
        name: 'Google Fit',
        type: 'health',
        apiEndpoint: 'https://www.googleapis.com/fitness/v1',
        authType: 'oauth2',
        scopes: ['activity', 'body', 'location'],
        description: 'Google Fit health and fitness tracking',
        icon: 'ðŸƒ'
      },
      fitbit: {
        name: 'Fitbit',
        type: 'health',
        apiEndpoint: 'https://api.fitbit.com/1',
        authType: 'oauth2',
        scopes: ['activity', 'heartrate', 'sleep', 'profile'],
        description: 'Fitbit activity and health tracking',
        icon: 'âŒš'
      },
      garmin: {
        name: 'Garmin Connect',
        type: 'health',
        apiEndpoint: 'https://api.garmin.com',
        authType: 'oauth2',
        scopes: ['activity', 'health', 'location'],
        description: 'Garmin smartwatch and fitness tracking',
        icon: 'âŒš'
      },
      withings: {
        name: 'Withings',
        type: 'health',
        apiEndpoint: 'https://wbsapi.withings.net/v2',
        authType: 'oauth2',
        scopes: ['activity', 'measure', 'sleep'],
        description: 'Withings health and activity tracking',
        icon: 'ðŸ’ª'
      }
    };
    
    // Connect to external app
    async function connectToApp(providerId) {
      const provider = INTEGRATION_PROVIDERS[providerId];
      if (!provider) {
        throw new Error(`Unknown provider: ${providerId}`);
      }
      
      try {
        // OAuth2 flow
        if (provider.authType === 'oauth2') {
          const authUrl = await initiateOAuthFlow(provider);
          const authWindow = window.open(authUrl, 'oauth', 'width=600,height=700');
          
          // Listen for OAuth callback
          return new Promise((resolve, reject) => {
            const messageListener = (event) => {
              if (event.data.type === 'oauth_callback' && event.data.provider === providerId) {
                window.removeEventListener('message', messageListener);
                authWindow.close();
                
                if (event.data.success) {
                  saveIntegrationToken(providerId, event.data.token);
                  INTEGRATION_FRAMEWORK.connectedApps.set(providerId, {
                    provider,
                    token: event.data.token,
                    connectedAt: new Date().toISOString(),
                    lastSync: null
                  });
                  resolve(true);
                } else {
                  reject(new Error(event.data.error));
                }
              }
            };
            window.addEventListener('message', messageListener);
          });
        } else if (provider.authType === 'native') {
          // Native integration (e.g., Apple Health)
          return await initiateNativeIntegration(provider);
        }
      } catch (error) {
        console.error(`Failed to connect to ${provider.name}:`, error);
        throw error;
      }
    }
    
    // Initiate OAuth flow
    async function initiateOAuthFlow(provider) {
      const clientId = localStorage.getItem(`oauth_client_id_${provider.name.toLowerCase()}`);
      const redirectUri = `${window.location.origin}/oauth/callback`;
      const scopes = provider.scopes.join(' ');
      
      // Generate state for CSRF protection
      const state = generateRandomString(32);
      sessionStorage.setItem('oauth_state', state);
      
      return `${provider.apiEndpoint}/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&response_type=code&state=${state}`;
    }
    
    // Initiate native integration
    async function initiateNativeIntegration(provider) {
      if (provider.name === 'Apple Health') {
        // Web API for HealthKit (if available)
        if (navigator.health) {
          try {
            const result = await navigator.health.requestAuthorization({
              read: ['steps', 'heartRate', 'sleep', 'activeEnergyBurned']
            });
            
            if (result) {
              INTEGRATION_FRAMEWORK.connectedApps.set('applehealth', {
                provider,
                token: 'native',
                connectedAt: new Date().toISOString(),
                lastSync: null
              });
              return true;
            }
          } catch (error) {
            console.error('HealthKit authorization failed:', error);
            throw error;
          }
        } else {
          throw new Error('HealthKit API not available in this browser');
        }
      }
    }
    
    // Save integration token
    function saveIntegrationToken(providerId, token) {
      // Store encrypted token
      const encrypted = btoa(JSON.stringify({ providerId, token, timestamp: Date.now() }));
      localStorage.setItem(`integration_token_${providerId}`, encrypted);
    }
    
    // Get integration token
    function getIntegrationToken(providerId) {
      const stored = localStorage.getItem(`integration_token_${providerId}`);
      if (stored) {
        try {
          const decrypted = JSON.parse(atob(stored));
          return decrypted.token;
        } catch (e) {
          return null;
        }
      }
      return null;
    }
    
    // Sync data from connected apps
    async function syncHealthData(providerId = null) {
      const providersToSync = providerId 
        ? [INTEGRATION_FRAMEWORK.connectedApps.get(providerId)]
        : Array.from(INTEGRATION_FRAMEWORK.connectedApps.values());
      
      for (const integration of providersToSync) {
        if (!integration) continue;
        
        try {
          const provider = integration.provider;
          
          // Fetch sleep data
          if (provider.scopes.includes('sleep')) {
            const sleepData = await fetchHealthData(provider, 'sleep');
            if (sleepData) {
              INTEGRATION_FRAMEWORK.healthData.sleep.push(...sleepData);
            }
          }
          
          // Fetch exercise/activity data
          if (provider.scopes.includes('activity')) {
            const activityData = await fetchHealthData(provider, 'activity');
            if (activityData) {
              INTEGRATION_FRAMEWORK.healthData.exercise.push(...activityData);
            }
          }
          
          // Fetch heart rate data
          if (provider.scopes.includes('heartrate')) {
            const heartRateData = await fetchHealthData(provider, 'heartrate');
            if (heartRateData) {
              INTEGRATION_FRAMEWORK.healthData.heartRate.push(...heartRateData);
            }
          }
          
          // Fetch steps
          const stepsData = await fetchHealthData(provider, 'steps');
          if (stepsData) {
            INTEGRATION_FRAMEWORK.healthData.steps.push(...stepsData);
          }
          
          // Update last sync time
          integration.lastSync = new Date().toISOString();
          
          // Save to IndexedDB
          saveHealthData();
          
        } catch (error) {
          console.error(`Failed to sync ${provider.name}:`, error);
        }
      }
    }
    
    // Fetch health data from provider
    async function fetchHealthData(provider, dataType) {
      const token = getIntegrationToken(provider.name.toLowerCase().replace(' ', ''));
      if (!token) {
        throw new Error('Not authenticated');
      }
      
      // This would make actual API calls to the provider
      // For now, return mock structure
      const endpoint = `${provider.apiEndpoint}/${dataType}`;
      
      try {
        // In production, this would be a real API call
        const response = await fetch(endpoint, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          return formatHealthData(data, dataType);
        }
      } catch (error) {
        // Fallback to mock data for development
        return generateMockHealthData(dataType);
      }
    }
    
    // Format health data from different providers
    function formatHealthData(rawData, dataType) {
      // Normalize data from different providers to common format
      const normalized = [];
      
      if (dataType === 'sleep') {
        rawData.forEach(entry => {
          normalized.push({
            id: entry.id || Date.now() + Math.random(),
            date: entry.date || entry.startTime,
            duration: entry.duration || entry.totalSleepTime,
            deepSleep: entry.deepSleep || entry.deepSleepMinutes,
            remSleep: entry.remSleep || entry.remSleepMinutes,
            lightSleep: entry.lightSleep || entry.lightSleepMinutes,
            sleepQuality: entry.quality || entry.sleepScore,
            bedTime: entry.bedTime || entry.startTime,
            wakeTime: entry.wakeTime || entry.endTime,
            source: entry.source || 'unknown'
          });
        });
      } else if (dataType === 'activity' || dataType === 'exercise') {
        rawData.forEach(entry => {
          normalized.push({
            id: entry.id || Date.now() + Math.random(),
            date: entry.date || entry.startTime,
            type: entry.type || entry.activityType,
            duration: entry.duration || entry.activeMinutes,
            calories: entry.calories || entry.activeEnergyBurned,
            distance: entry.distance,
            heartRate: entry.heartRate || entry.averageHeartRate,
            source: entry.source || 'unknown'
          });
        });
      } else if (dataType === 'heartrate') {
        rawData.forEach(entry => {
          normalized.push({
            id: entry.id || Date.now() + Math.random(),
            timestamp: entry.timestamp || entry.time,
            bpm: entry.bpm || entry.value,
            resting: entry.resting || false,
            source: entry.source || 'unknown'
          });
        });
      } else if (dataType === 'steps') {
        rawData.forEach(entry => {
          normalized.push({
            id: entry.id || Date.now() + Math.random(),
            date: entry.date || entry.startTime,
            steps: entry.steps || entry.value,
            distance: entry.distance,
            calories: entry.calories,
            source: entry.source || 'unknown'
          });
        });
      }
      
      return normalized;
    }
    
    // Generate mock health data for development
    function generateMockHealthData(dataType) {
      const today = new Date();
      const mockData = [];
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        
        if (dataType === 'sleep') {
          mockData.push({
            id: `mock_sleep_${i}`,
            date: date.toISOString().split('T')[0],
            duration: 7.5 + Math.random() * 1.5, // 7.5-9 hours
            deepSleep: 1.5 + Math.random() * 0.5,
            remSleep: 1.5 + Math.random() * 0.5,
            lightSleep: 4.5 + Math.random() * 1,
            sleepQuality: 70 + Math.random() * 25,
            bedTime: new Date(date.setHours(23, 0, 0, 0)).toISOString(),
            wakeTime: new Date(date.setHours(7, 30, 0, 0)).toISOString(),
            source: 'mock'
          });
        } else if (dataType === 'activity') {
          mockData.push({
            id: `mock_activity_${i}`,
            date: date.toISOString().split('T')[0],
            type: ['walking', 'running', 'cycling', 'gym'][Math.floor(Math.random() * 4)],
            duration: 30 + Math.random() * 60,
            calories: 200 + Math.random() * 400,
            distance: 2 + Math.random() * 8,
            heartRate: 120 + Math.random() * 40,
            source: 'mock'
          });
        } else if (dataType === 'steps') {
          mockData.push({
            id: `mock_steps_${i}`,
            date: date.toISOString().split('T')[0],
            steps: 5000 + Math.random() * 8000,
            distance: 3 + Math.random() * 5,
            calories: 150 + Math.random() * 200,
            source: 'mock'
          });
        }
      }
      
      return mockData;
    }
    
    // Sync timer/work data to health apps
    function syncTimerToHealthApps(state, duration) {
      // When work session completes, sync to health tracking
      if (state === 'work' && duration) {
        syncWorkActivityToHealthApps('work_complete', currentTimerMethod, duration);
      }
    }
    
    function syncWorkActivityToHealthApps(event, method, duration) {
      // Create work activity entry
      const workActivity = {
        id: Date.now(),
        type: 'work',
        method: method,
        duration: duration ? Math.round(duration / 1000 / 60) : null,
        timestamp: new Date().toISOString(),
        event: event
      };
      
      // Store in health data
      INTEGRATION_FRAMEWORK.healthData.exercise.push(workActivity);
      
      // Sync to connected apps
      INTEGRATION_FRAMEWORK.connectedApps.forEach((integration, providerId) => {
        if (integration.provider.scopes.includes('activity')) {
          sendDataToProvider(providerId, 'activity', workActivity);
        }
      });
      
      saveHealthData();
    }
    
    // Send data to provider
    async function sendDataToProvider(providerId, dataType, data) {
      const integration = INTEGRATION_FRAMEWORK.connectedApps.get(providerId);
      if (!integration) return;
      
      const token = getIntegrationToken(providerId);
      if (!token) return;
      
      try {
        const endpoint = `${integration.provider.apiEndpoint}/${dataType}`;
        await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
      } catch (error) {
        console.error(`Failed to send data to ${integration.provider.name}:`, error);
      }
    }
    
    // Save health data to IndexedDB
    function saveHealthData() {
      if (db) {
        const transaction = db.transaction(['healthData'], 'readwrite');
        const store = transaction.objectStore('healthData');
        
        Object.keys(INTEGRATION_FRAMEWORK.healthData).forEach(key => {
          INTEGRATION_FRAMEWORK.healthData[key].forEach(entry => {
            store.put({ ...entry, category: key });
          });
        });
      } else {
        // Fallback to localStorage
        localStorage.setItem('healthData', JSON.stringify(INTEGRATION_FRAMEWORK.healthData));
      }
    }
    
    // Load health data
    function loadHealthData() {
      if (db) {
        const transaction = db.transaction(['healthData'], 'readonly');
        const store = transaction.objectStore('healthData');
        const request = store.getAll();
        
        request.onsuccess = () => {
          const allData = request.result;
          allData.forEach(entry => {
            const category = entry.category;
            if (INTEGRATION_FRAMEWORK.healthData[category]) {
              INTEGRATION_FRAMEWORK.healthData[category].push(entry);
            }
          });
        };
      } else {
        const saved = localStorage.getItem('healthData');
        if (saved) {
          INTEGRATION_FRAMEWORK.healthData = JSON.parse(saved);
        }
      }
    }
    
    // Get health insights
    function getHealthInsights(days = 7) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      
      const recentSleep = INTEGRATION_FRAMEWORK.healthData.sleep.filter(s => 
        new Date(s.date) >= cutoff
      );
      const recentActivity = INTEGRATION_FRAMEWORK.healthData.exercise.filter(a => 
        new Date(a.timestamp || a.date) >= cutoff
      );
      const recentSteps = INTEGRATION_FRAMEWORK.healthData.steps.filter(s => 
        new Date(s.date) >= cutoff
      );
      
      const avgSleep = recentSleep.length > 0
        ? recentSleep.reduce((sum, s) => sum + s.duration, 0) / recentSleep.length
        : 0;
      
      const avgSteps = recentSteps.length > 0
        ? recentSteps.reduce((sum, s) => sum + s.steps, 0) / recentSteps.length
        : 0;
      
      const totalWorkMinutes = recentActivity
        .filter(a => a.type === 'work')
        .reduce((sum, a) => sum + (a.duration || 0), 0);
      
      return {
        sleep: {
          average: Math.round(avgSleep * 10) / 10,
          quality: recentSleep.length > 0 
            ? Math.round(recentSleep.reduce((sum, s) => sum + (s.sleepQuality || 0), 0) / recentSleep.length)
            : 0,
          days: recentSleep.length
        },
        activity: {
          totalMinutes: totalWorkMinutes,
          totalHours: Math.round(totalWorkMinutes / 60 * 10) / 10,
          sessions: recentActivity.filter(a => a.type === 'work').length
        },
        steps: {
          average: Math.round(avgSteps),
          total: recentSteps.reduce((sum, s) => sum + s.steps, 0)
        },
        recommendations: generateHealthRecommendations(avgSleep, avgSteps, totalWorkMinutes)
      };
    }
    
    // Generate health recommendations
    function generateHealthRecommendations(avgSleep, avgSteps, workMinutes) {
      const recommendations = [];
      
      if (avgSleep < 7) {
        recommendations.push({
          type: 'sleep',
          priority: 'high',
          message: 'You\'re getting less than 7 hours of sleep on average. Consider going to bed earlier.',
          action: 'Set bedtime reminder'
        });
      }
      
      if (avgSteps < 5000) {
        recommendations.push({
          type: 'activity',
          priority: 'medium',
          message: 'You\'re below the recommended 10,000 steps per day. Try taking short walks during breaks.',
          action: 'Schedule walking breaks'
        });
      }
      
      if (workMinutes > 8 * 60) {
        recommendations.push({
          type: 'work',
          priority: 'high',
          message: 'You\'re working more than 8 hours per day. Remember to take breaks and maintain work-life balance.',
          action: 'Schedule mandatory breaks'
        });
      }
      
      return recommendations;
    }
    
    // Auto-sync health data
    function startAutoSync() {
      if (INTEGRATION_FRAMEWORK.syncSettings.autoSync) {
        setInterval(() => {
          syncHealthData();
        }, INTEGRATION_FRAMEWORK.syncSettings.syncInterval);
      }
    }
    
    // Initialize integration framework
    document.addEventListener('DOMContentLoaded', function() {
      loadHealthData();
      
      // Load connected apps
      const savedApps = localStorage.getItem('connectedApps');
      if (savedApps) {
        const apps = JSON.parse(savedApps);
        apps.forEach(([id, data]) => {
          INTEGRATION_FRAMEWORK.connectedApps.set(id, data);
        });
      }
      
      // Start auto-sync if enabled
      if (INTEGRATION_FRAMEWORK.syncSettings.autoSync) {
        startAutoSync();
      }
    });
    
    // Helper function to generate random string
    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
  </script>
  
  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal" onclick="if(event.target === this) closeSettings()" style="display: none;">
    <div class="settings-content" onclick="event.stopPropagation()">
      <div class="settings-header">
        <h3>âš™ï¸ Settings</h3>
        <button class="settings-close" onclick="closeSettings()" title="Close (Esc)">Ã—</button>
      </div>
      <div class="settings-tabs" style="overflow-x: auto; display: flex; flex-wrap: nowrap;">
        <button class="settings-tab active" data-tab="general" onclick="switchSettingsTab('general')">General</button>
        <button class="settings-tab" data-tab="appearance" onclick="switchSettingsTab('appearance')">Appearance</button>
        <button class="settings-tab" data-tab="shortcuts" onclick="switchSettingsTab('shortcuts')">Shortcuts</button>
        <button class="settings-tab" data-tab="timer" onclick="switchSettingsTab('timer')">Timer</button>
        <button class="settings-tab" data-tab="integrations" onclick="switchSettingsTab('integrations')">Integrations</button>
        <button class="settings-tab" data-tab="ai" onclick="switchSettingsTab('ai')">AI</button>
        <button class="settings-tab" data-tab="profile" onclick="switchSettingsTab('profile')">Profile</button>
      </div>
      
      <!-- General Tab -->
      <div id="settings-general" class="settings-tab-content active">
        <div class="settings-section">
          <h4>General Settings</h4>
          <div class="settings-field">
            <label>Language</label>
            <select id="settings-language">
              <option value="en">English</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Timezone</label>
            <select id="settings-timezone">
              <option value="UTC">UTC</option>
              <option value="Europe/Athens" selected>Europe/Athens</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Date Format</label>
            <select id="settings-dateFormat">
              <option value="DD/MM/YYYY">DD/MM/YYYY</option>
              <option value="MM/DD/YYYY">MM/DD/YYYY</option>
              <option value="YYYY-MM-DD">YYYY-MM-DD</option>
            </select>
          </div>
          <div class="settings-toggle">
            <label>Auto-save file explorer state</label>
            <div class="toggle-switch active" id="settings-autoSave" onclick="toggleSetting(this)"></div>
          </div>
        </div>
      </div>
      
      <!-- Appearance Tab -->
      <div id="settings-appearance" class="settings-tab-content">
        <div class="settings-section">
          <h4>Theme</h4>
          <div class="settings-field">
            <label>Color Theme</label>
            <select id="settings-theme" onchange="if(typeof window.toggleTheme === 'function') { const current = window.getCurrentTheme(); if(current !== this.value) window.toggleTheme(); }">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
            <button onclick="if(typeof window.toggleTheme === 'function') window.toggleTheme(); updateSettingsThemeSelect();" class="btn-modern btn-modern-secondary" style="margin-top: 0.5rem;">Toggle Theme</button>
          </div>
          <div class="settings-field">
            <label>Font Size</label>
            <select id="settings-fontSize">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Accent Color</label>
            <input type="color" id="settings-accentColor" value="#0f4c81">
          </div>
        </div>
        <div class="settings-section">
          <h4>Layout</h4>
          <div class="settings-toggle">
            <label>Sidebar open by default</label>
            <div class="toggle-switch" id="settings-sidebarOpen" onclick="toggleSetting(this)"></div>
          </div>
          <div class="settings-toggle">
            <label>Compact mode</label>
            <div class="toggle-switch" id="settings-compactMode" onclick="toggleSetting(this)"></div>
          </div>
        </div>
      </div>
      
      <!-- AI Tab -->
      <div id="settings-ai" class="settings-tab-content">
        <div class="settings-section">
          <h4>AI Provider</h4>
          <div class="settings-field">
            <label>Provider</label>
            <select id="settings-aiProvider">
              <option value="openai">OpenAI</option>
              <option value="groq">Groq</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Model</label>
            <select id="settings-aiModel">
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
            </select>
          </div>
          <div class="settings-field">
            <label>API Key</label>
            <input type="password" id="settings-apiKey" class="input-modern" placeholder="Enter API key..." form="settings-form" autocomplete="new-password">
            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
              Your API key is stored locally and never sent to our servers.
            </small>
          </div>
        </div>
        <div class="settings-section" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h4>AI Assistant Location</h4>
          <div class="settings-field">
            <label>Where to access AI Assistant</label>
            <select id="settings-aiAssistantLocation" class="input-modern">
              <option value="chat">In Chat (Modal)</option>
              <option value="settings">In Settings Tab</option>
            </select>
            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
              Choose whether to access the AI assistant from the chat button or in the settings tab.
            </small>
          </div>
        </div>
      </div>
      
      <!-- Integrations Tab -->
      <div id="settings-integrations" class="settings-tab-content">
        <div class="settings-section">
          <h4>Health & Life Tracking Apps</h4>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Connect to apps in the 6x7 ecosystem to track your work, life, and health. Sync sleep, exercise, heart rate, and more.
          </p>
          
          <div id="integrationsList" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Integration cards will be generated here -->
          </div>
          
          <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--bg-primary);">
            <h4>Auto-Sync Settings</h4>
            <div class="settings-toggle">
              <label>Enable automatic data sync</label>
              <div class="toggle-switch active" id="settings-autoSync" onclick="toggleSetting(this)"></div>
            </div>
            <div class="settings-field" style="margin-top: 1rem;">
              <label>Sync Interval (minutes)</label>
              <input type="number" id="settings-syncInterval" value="5" min="1" max="60">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Timer Tab -->
      <div id="settings-timer" class="settings-tab-content">
        <div class="settings-section">
          <h4>Work Timer Methods</h4>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Choose your preferred work timer method. You can switch between methods at any time.
          </p>
          
          <div id="timerMethodsList" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Timer method cards will be generated here -->
          </div>
          
          <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--bg-primary);">
            <h4>Custom Timer Settings</h4>
            <div class="settings-field">
              <label>Work Duration (minutes)</label>
              <input type="number" id="settings-customWorkDuration" value="30" min="5" max="180">
            </div>
            <div class="settings-field">
              <label>Short Break (minutes)</label>
              <input type="number" id="settings-customShortBreak" value="5" min="1" max="30">
            </div>
            <div class="settings-field">
              <label>Long Break (minutes)</label>
              <input type="number" id="settings-customLongBreak" value="15" min="5" max="60">
            </div>
            <div class="settings-field">
              <label>Sessions Until Long Break</label>
              <input type="number" id="settings-customSessionsUntilLongBreak" value="4" min="2" max="10">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profile Tab -->
      <div id="settings-profile" class="settings-tab-content">
        <div class="settings-section">
          <h4>Profile Information</h4>
          <div class="settings-field">
            <label>Name</label>
            <input type="text" id="settings-name" placeholder="Your name">
          </div>
          <div class="settings-field">
            <label>Email</label>
            <input type="email" id="settings-email" placeholder="your.email@example.com">
          </div>
          <div class="settings-field">
            <label>Bio</label>
            <textarea id="settings-bio" placeholder="Tell us about yourself..."></textarea>
          </div>
        </div>
      </div>
      
      <!-- Keyboard Shortcuts Tab -->
      <div id="settings-shortcuts" class="settings-tab-content">
        <div class="settings-section">
          <h4>Customize Keyboard Shortcuts</h4>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Customize keyboard shortcuts for quick access to features.
          </p>
          
          <div id="shortcutsList" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Shortcuts will be populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <form id="settings-form" style="padding: 1.5rem; border-top: 2px solid var(--bg-primary); background: var(--bg-primary); flex-shrink: 0;" onsubmit="event.preventDefault(); saveSettings();">
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" class="settings-save" style="flex: 1;">Save Settings</button>
          <button type="button" onclick="closeSettings()" class="btn-modern btn-modern-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- User Display (Top Right) - Hidden, login button is in banner now -->
  <div id="userDisplay" style="display: none;">
    <!-- Will be populated by JavaScript for backward compatibility -->
  </div>
  
  <script>
    // Integrate additional features
    document.addEventListener('DOMContentLoaded', function() {
      // Add Keyboard Shortcuts tab
      const settingsTabs = document.querySelector('.settings-tabs');
      if (settingsTabs) {
        const shortcutsTab = document.createElement('button');
        shortcutsTab.className = 'settings-tab';
        shortcutsTab.setAttribute('data-tab', 'shortcuts');
        shortcutsTab.textContent = 'Shortcuts';
        shortcutsTab.onclick = () => {
          switchSettingsTab('shortcuts');
          renderShortcutsList();
        };
        settingsTabs.appendChild(shortcutsTab);
      }
      
      // Render shortcuts list
      function renderShortcutsList() {
        const container = document.getElementById('shortcutsList');
        if (!container) return;
        
        // Get shortcuts from ADDITIONAL_FEATURES.js or use default
        const shortcuts = window.customShortcuts || {};
        
        container.innerHTML = Object.entries(shortcuts).map(([action, config]) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius); margin-bottom: 0.75rem; border: 1px solid var(--border-color);">
            <div style="flex: 1;">
              <strong style="display: block; margin-bottom: 0.25rem; color: var(--text-primary);">${config.description}</strong>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">
                Current: <code style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${config.ctrl ? 'Ctrl+' : ''}${config.key.toUpperCase()}</code>
              </div>
            </div>
            <button onclick="editShortcut('${action}')" class="btn-modern btn-modern-primary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Edit</button>
          </div>
        `).join('');
      }
      
      window.renderShortcutsList = renderShortcutsList;
      window.editShortcut = function(action) {
        const shortcuts = window.customShortcuts || {};
        const config = shortcuts[action];
        if (!config) return;
        
        const modal = document.createElement('div');
        modal.className = 'about-modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="about-modal-content" style="max-width: 500px;">
            <div class="about-modal-header">
              <h3>Edit Shortcut: ${config.description}</h3>
              <span class="about-modal-close" onclick="this.closest('.about-modal').remove()">&times;</span>
            </div>
            <div class="about-modal-body">
              <div class="settings-field" style="margin-bottom: 1rem;">
                <label>Key (single letter or number)</label>
                <input type="text" id="shortcutKey" class="input-modern" value="${config.key}" maxlength="1" style="text-transform: uppercase;">
              </div>
              <div class="settings-toggle">
                <label>Require Ctrl/Cmd key</label>
                <div class="toggle-switch ${config.ctrl ? 'active' : ''}" id="shortcutCtrl" onclick="toggleSetting(this)"></div>
              </div>
              <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                <button onclick="saveShortcut('${action}')" class="btn-modern btn-modern-primary" style="flex: 1;">Save</button>
                <button onclick="this.closest('.about-modal').remove()" class="btn-modern btn-modern-secondary" style="flex: 1;">Cancel</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Focus input
        setTimeout(() => {
          const input = document.getElementById('shortcutKey');
          if (input) {
            input.focus();
            input.select();
          }
        }, 100);
        
        // Close on Escape
        const escapeHandler = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escapeHandler);
          }
        };
        document.addEventListener('keydown', escapeHandler);
      };
      
      window.saveShortcut = function(action) {
        const shortcuts = window.customShortcuts || {};
        const config = shortcuts[action];
        if (!config) return;
        
        const newKey = document.getElementById('shortcutKey')?.value?.toLowerCase();
        const useCtrl = document.getElementById('shortcutCtrl')?.classList.contains('active');
        
        if (newKey && newKey.length === 1) {
          config.key = newKey;
          config.ctrl = useCtrl;
          
          if (window.saveCustomShortcuts) {
            window.saveCustomShortcuts();
          }
          if (window.applyCustomShortcuts) {
            window.applyCustomShortcuts();
          }
          renderShortcutsList();
          
          document.querySelector('.about-modal')?.remove();
        } else {
          alert('Please enter a single letter or number');
        }
      };
      
      // Initialize AI config on page load
      if (typeof loadAIConfig === 'function') {
        loadAIConfig();
      }
      
      // Initialize user display (will be created by ADDITIONAL_FEATURES.js)
      if (window.loadUser) {
        loadUser();
      } else {
        // Fallback: create basic user display
        const userDisplay = document.createElement('div');
        userDisplay.id = 'userDisplay';
        userDisplay.style.cssText = 'position: fixed; top: 1rem; right: 1rem; z-index: 1000;';
        // Login button is already in the top banner, just ensure it's visible
        const loginBtn = document.getElementById('loginButton');
        if (loginBtn) {
          loginBtn.style.display = 'flex';
          loginBtn.innerHTML = 'ðŸ” Login';
          loginBtn.onclick = () => showLoginModal();
        }
        document.body.appendChild(userDisplay);
      }
      
      // Show commit button if user is editor/admin
      if (currentUser && (currentUser.role === 'editor' || currentUser.role === 'admin')) {
        const commitBtn = document.querySelector('.commit-btn');
        if (commitBtn) {
          commitBtn.style.display = 'flex';
        }
      }
      
      // Add commits panel button for admins (add to quick access toolbar)
      if (currentUser && currentUser.role === 'admin') {
        const toolbar = document.querySelector('.quick-access-toolbar');
        if (toolbar) {
          // Check if commits button already exists
          const existingCommitsBtn = toolbar.querySelector('.commits-panel-btn');
          if (!existingCommitsBtn) {
            const commitsBtn = document.createElement('button');
            commitsBtn.className = 'quick-tool-btn commits-panel-btn';
            commitsBtn.innerHTML = '<span style="font-size: 1.25rem;">ðŸ“‹</span>';
            commitsBtn.onclick = showCommitsPanel;
            commitsBtn.title = 'Review pending commits';
            // Insert before commit button
            const commitBtn = toolbar.querySelector('.commit-btn');
            if (commitBtn) {
              toolbar.insertBefore(commitsBtn, commitBtn);
            } else {
              toolbar.appendChild(commitsBtn);
            }
          }
        }
      }
      
      // Code editor is already accessible via Editor button in quick access toolbar
      // No need to add separately
    });
    
    // Make AI assistant able to edit files
    async function aiEditFile(filePath, changes) {
      // In production, this would use backend API
      // For now, show edit preview
      const modal = document.createElement('div');
      modal.className = 'about-modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="about-modal-content" style="max-width: 800px;">
          <div class="about-modal-header">
            <h3>âœï¸ AI File Edit Preview</h3>
            <span class="about-modal-close" onclick="this.closest('.about-modal').remove()">&times;</span>
          </div>
          <div class="about-modal-body">
            <p><strong>File:</strong> ${filePath}</p>
            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
              <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;">${changes}</pre>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <button onclick="applyFileEdit('${filePath}', \`${changes.replace(/`/g, '\\`')}\`)" class="btn-modern" style="background: var(--success); color: white;">âœ… Apply Changes</button>
              <button onclick="this.closest('.about-modal').remove()" class="btn-modern btn-modern-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
    
    async function applyFileEdit(filePath, content) {
      // In production, send to backend
      alert(`File edit applied to ${filePath} (Backend integration needed for actual file saving)`);
      document.querySelector('.about-modal')?.remove();
      trackEvent('ai', 'file_edit', filePath);
    }
    
    // Enhanced AI assistant with file editing capability
    const originalCallAIAPI = window.callAIAPI;
    window.callAIAPI = async function(userMessage, ragContext) {
      const response = await originalCallAIAPI(userMessage, ragContext);
      
      // Check if AI response contains file edit commands
      if (response.includes('[EDIT_FILE]') || response.includes('edit file')) {
        // Extract file path and changes from AI response
        // This would be more sophisticated in production
        const editMatch = response.match(/\[EDIT_FILE\](.*?)\[\/EDIT_FILE\]/s);
        if (editMatch) {
          const [filePath, changes] = editMatch[1].split('\n', 2);
          await aiEditFile(filePath.trim(), changes.trim());
        }
      }
      
      return response;
    };
  </script>
  
  <!-- Global Escape Key Handler for All Modals -->
  <script>
    document.addEventListener('keydown', function(e) {
      // Close modals with Escape key
      if (e.key === 'Escape' || e.keyCode === 27) {
        // Close settings modal
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal && settingsModal.style.display !== 'none') {
          if (typeof closeSettings === 'function') {
            closeSettings();
          } else {
            settingsModal.style.display = 'none';
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close chatbot modal
        const chatbotModal = document.getElementById('chatbotModal');
        if (chatbotModal && chatbotModal.style.display !== 'none') {
          if (typeof closeChatbot === 'function') {
            closeChatbot();
          } else {
            chatbotModal.style.display = 'none';
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close file preview modal
        const filePreviewModal = document.getElementById('filePreviewModal');
        if (filePreviewModal && filePreviewModal.style.display !== 'none') {
          if (typeof closeFilePreview === 'function') {
            closeFilePreview();
          } else {
            filePreviewModal.style.display = 'none';
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close timer widget
        const timerWidget = document.getElementById('timerWidget');
        if (timerWidget && timerWidget.style.display !== 'none') {
          if (typeof closeTimerWidget === 'function') {
            closeTimerWidget();
          } else {
            timerWidget.style.display = 'none';
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close messaging panel
        const messagingPanel = document.getElementById('messagingPanel');
        if (messagingPanel) {
          messagingPanel.remove();
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close conversation view
        const conversationView = document.getElementById('conversationView');
        if (conversationView) {
          conversationView.remove();
          if (typeof showMessagingPanel === 'function') {
            showMessagingPanel();
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // Close any about-modal (most common modal type)
        const aboutModals = document.querySelectorAll('.about-modal');
        if (aboutModals.length > 0) {
          // Close the last one (topmost)
          const lastModal = aboutModals[aboutModals.length - 1];
          if (lastModal && lastModal.style.display !== 'none') {
            lastModal.remove();
            e.preventDefault();
            e.stopPropagation();
            return;
          }
        }
        
        // Close file upload modal
        const fileUploadModal = document.getElementById('fileUploadModal');
        if (fileUploadModal && fileUploadModal.style.display !== 'none') {
          if (typeof closeFileUploadModal === 'function') {
            closeFileUploadModal();
          } else {
            fileUploadModal.style.display = 'none';
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
      }
    });
  </script>
  
  <!-- Footer -->
  <footer>
    <p>Made by <a href="https://6x7.gr" target="_blank">6x7.gr</a></p>
  </footer>
</body>
</html>














